{"version":3,"file":"create-from-pdf-action-rSrhSCno.js","sources":["../src/create-from-pdf-modal.token.ts","../src/create-from-pdf-action.ts"],"sourcesContent":["import { UmbModalToken } from '@umbraco-cms/backoffice/modal';\r\n\r\nexport interface UmbCreateFromPdfModalData {\r\n\tunique: string | null;\r\n}\r\n\r\nexport interface UmbCreateFromPdfModalValue {\r\n\tname: string;\r\n\tmediaUnique: string | null;\r\n\tpageTitle: string;\r\n\tpageTitleShort: string;\r\n\tpageDescription: string;\r\n\titineraryContent: string;\r\n}\r\n\r\nexport const UMB_CREATE_FROM_PDF_MODAL = new UmbModalToken<UmbCreateFromPdfModalData, UmbCreateFromPdfModalValue>(\r\n\t'CreateFromPdf.Modal',\r\n\t{\r\n\t\tmodal: {\r\n\t\t\ttype: 'sidebar',\r\n\t\t\tsize: 'small',\r\n\t\t},\r\n\t},\r\n);\r\n","import { UMB_CREATE_FROM_PDF_MODAL } from './create-from-pdf-modal.token.js';\r\nimport { UmbEntityActionBase } from '@umbraco-cms/backoffice/entity-action';\r\nimport { umbOpenModal } from '@umbraco-cms/backoffice/modal';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport type { UmbEntityActionArgs } from '@umbraco-cms/backoffice/entity-action';\r\nimport { UMB_NOTIFICATION_CONTEXT } from '@umbraco-cms/backoffice/notification';\r\nimport { UMB_AUTH_CONTEXT } from '@umbraco-cms/backoffice/auth';\r\nimport { UmbDocumentTypeStructureRepository } from '@umbraco-cms/backoffice/document-type';\r\nimport { UmbDocumentBlueprintItemRepository } from '@umbraco-cms/backoffice/document-blueprint';\r\nimport { UmbDocumentItemRepository } from '@umbraco-cms/backoffice/document';\r\n\r\nexport class CreateFromPdfEntityAction extends UmbEntityActionBase<never> {\r\n\t#documentTypeStructureRepository = new UmbDocumentTypeStructureRepository(this);\r\n\t#blueprintItemRepository = new UmbDocumentBlueprintItemRepository(this);\r\n\t#documentItemRepository = new UmbDocumentItemRepository(this);\r\n\r\n\tconstructor(host: UmbControllerHost, args: UmbEntityActionArgs<never>) {\r\n\t\tsuper(host, args);\r\n\t}\r\n\r\n\toverride async execute() {\r\n\t\tconst notificationContext = await this.getContext(UMB_NOTIFICATION_CONTEXT);\r\n\t\tconst parentUnique = this.args.unique ?? null;\r\n\r\n\t\t// Open modal and get values (PDF extraction happens in modal)\r\n\t\tlet modalValue;\r\n\t\ttry {\r\n\t\t\tmodalValue = await umbOpenModal(this, UMB_CREATE_FROM_PDF_MODAL, {\r\n\t\t\t\tdata: { unique: parentUnique },\r\n\t\t\t});\r\n\t\t} catch {\r\n\t\t\t// Modal was cancelled\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst { name, mediaUnique, pageTitle, pageTitleShort, pageDescription, itineraryContent } = modalValue;\r\n\r\n\t\tif (!mediaUnique || !name) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconsole.log('Creating document with:', { name, pageTitle, pageTitleShort, pageDescription, itineraryContent: itineraryContent?.substring(0, 100) });\r\n\r\n\t\ttry {\r\n\t\t\t// Step 1: Get the parent document's document type\r\n\t\t\tlet parentDocTypeUnique: string | null = null;\r\n\r\n\t\t\tif (parentUnique) {\r\n\t\t\t\tconsole.log('Getting parent document info for:', parentUnique);\r\n\t\t\t\tconst { data: parentItems } = await this.#documentItemRepository.requestItems([parentUnique]);\r\n\t\t\t\tconsole.log('Parent items:', parentItems);\r\n\r\n\t\t\t\tif (parentItems?.length) {\r\n\t\t\t\t\tparentDocTypeUnique = parentItems[0].documentType.unique;\r\n\t\t\t\t\tconsole.log('Parent document type unique:', parentDocTypeUnique);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t// Step 2: Get allowed child document types for the parent's document type\r\n\t\t\tconsole.log('Getting allowed children for docType:', parentDocTypeUnique, 'parent:', parentUnique);\r\n\t\t\tconst result = await this.#documentTypeStructureRepository.requestAllowedChildrenOf(\r\n\t\t\t\tparentDocTypeUnique,\r\n\t\t\t\tparentUnique\r\n\t\t\t);\r\n\t\t\tconsole.log('Full result from requestAllowedChildrenOf:', result);\r\n\t\t\tconst allowedTypes = result.data;\r\n\t\t\tconsole.log('Allowed types data:', allowedTypes);\r\n\r\n\t\t\tif (!allowedTypes?.items?.length) {\r\n\t\t\t\tconsole.log('No allowed types found, items:', allowedTypes?.items);\r\n\t\t\t\tnotificationContext.peek('danger', {\r\n\t\t\t\t\tdata: { message: 'No document types are allowed as children of this page.' },\r\n\t\t\t\t});\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tconsole.log('Allowed document types:', allowedTypes.items);\r\n\r\n\t\t\t// Step 2: Get blueprints for the allowed document types\r\n\t\t\tlet blueprint = null;\r\n\t\t\tlet documentTypeUnique = null;\r\n\r\n\t\t\tfor (const docType of allowedTypes.items) {\r\n\t\t\t\tconst { data: blueprints } = await this.#blueprintItemRepository.requestItemsByDocumentType(docType.unique);\r\n\t\t\t\tif (blueprints?.length) {\r\n\t\t\t\t\tblueprint = blueprints[0]; // Use first available blueprint\r\n\t\t\t\t\tdocumentTypeUnique = docType.unique;\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (!blueprint) {\r\n\t\t\t\tnotificationContext.peek('danger', {\r\n\t\t\t\t\tdata: { message: 'No blueprint found for allowed document types. Please create a blueprint first.' },\r\n\t\t\t\t});\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tconsole.log('Using blueprint:', blueprint.name, blueprint.unique);\r\n\t\t\tconsole.log('Document type:', documentTypeUnique);\r\n\r\n\t\t\t// Step 3: Scaffold from the blueprint to get default values\r\n\t\t\tconst authContext = await this.getContext(UMB_AUTH_CONTEXT);\r\n\t\t\tconst token = await authContext.getLatestToken();\r\n\r\n\t\t\tconst scaffoldResponse = await fetch(\r\n\t\t\t\t`/umbraco/management/api/v1/document-blueprint/${blueprint.unique}/scaffold`,\r\n\t\t\t\t{\r\n\t\t\t\t\tmethod: 'GET',\r\n\t\t\t\t\theaders: {\r\n\t\t\t\t\t\t'Content-Type': 'application/json',\r\n\t\t\t\t\t\tAuthorization: `Bearer ${token}`,\r\n\t\t\t\t\t},\r\n\t\t\t\t}\r\n\t\t\t);\r\n\r\n\t\t\tif (!scaffoldResponse.ok) {\r\n\t\t\t\tconst error = await scaffoldResponse.json();\r\n\t\t\t\tconsole.error('Scaffold failed:', error);\r\n\t\t\t\tnotificationContext.peek('danger', {\r\n\t\t\t\t\tdata: { message: `Failed to scaffold from blueprint: ${error.title || 'Unknown error'}` },\r\n\t\t\t\t});\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tconst scaffold = await scaffoldResponse.json();\r\n\t\t\tconsole.log('Scaffold response:', scaffold);\r\n\r\n\t\t\t// Step 4: Build the document creation request\r\n\t\t\t// Start with scaffold values and override with PDF-extracted values\r\n\t\t\tconst values = scaffold.values ? [...scaffold.values] : [];\r\n\r\n\t\t\t// Helper to set or update a value\r\n\t\t\tconst setValue = (alias: string, value: string) => {\r\n\t\t\t\tconst existing = values.find((v: { alias: string }) => v.alias === alias);\r\n\t\t\t\tif (existing) {\r\n\t\t\t\t\texisting.value = value;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tvalues.push({ alias, value });\r\n\t\t\t\t}\r\n\t\t\t};\r\n\r\n\t\t\t// Set the PDF-extracted properties\r\n\t\t\tsetValue('pageTitle', pageTitle);\r\n\t\t\tsetValue('pageTitleShort', pageTitleShort);\r\n\t\t\tsetValue('pageDescription', pageDescription);\r\n\r\n\t\t\t// Update contentGrid if we have itinerary content\r\n\t\t\tif (itineraryContent) {\r\n\t\t\t\tthis.#updateContentGridWithItinerary(values, itineraryContent);\r\n\t\t\t}\r\n\r\n\t\t\t// Build the create request\r\n\t\t\tconst createRequest = {\r\n\t\t\t\tparent: parentUnique ? { id: parentUnique } : null,\r\n\t\t\t\tdocumentType: { id: documentTypeUnique },\r\n\t\t\t\ttemplate: scaffold.template ? { id: scaffold.template.id } : null,\r\n\t\t\t\tvalues,\r\n\t\t\t\tvariants: [\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tname,\r\n\t\t\t\t\t\tculture: null,\r\n\t\t\t\t\t\tsegment: null,\r\n\t\t\t\t\t},\r\n\t\t\t\t],\r\n\t\t\t};\r\n\r\n\t\t\tconsole.log('Create request:', JSON.stringify(createRequest, null, 2));\r\n\r\n\t\t\t// Step 5: Create the document\r\n\t\t\tconst createResponse = await fetch('/umbraco/management/api/v1/document', {\r\n\t\t\t\tmethod: 'POST',\r\n\t\t\t\theaders: {\r\n\t\t\t\t\t'Content-Type': 'application/json',\r\n\t\t\t\t\tAuthorization: `Bearer ${token}`,\r\n\t\t\t\t},\r\n\t\t\t\tbody: JSON.stringify(createRequest),\r\n\t\t\t});\r\n\r\n\t\t\tif (!createResponse.ok) {\r\n\t\t\t\tconst error = await createResponse.json();\r\n\t\t\t\tconsole.error('Document creation failed:', error);\r\n\t\t\t\tnotificationContext.peek('danger', {\r\n\t\t\t\t\tdata: { message: `Failed to create document: ${error.title || error.detail || 'Unknown error'}` },\r\n\t\t\t\t});\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\t// Success!\r\n\t\t\tconst locationHeader = createResponse.headers.get('Location');\r\n\t\t\tconst newDocumentId = locationHeader?.split('/').pop();\r\n\r\n\t\t\tconsole.log('Document created successfully! ID:', newDocumentId);\r\n\r\n\t\t\t// Step 6: Save the document to properly persist it and trigger cache updates\r\n\t\t\tif (newDocumentId) {\r\n\t\t\t\t// First, fetch the document to get its current state\r\n\t\t\t\tconst getResponse = await fetch(`/umbraco/management/api/v1/document/${newDocumentId}`, {\r\n\t\t\t\t\tmethod: 'GET',\r\n\t\t\t\t\theaders: {\r\n\t\t\t\t\t\t'Content-Type': 'application/json',\r\n\t\t\t\t\t\tAuthorization: `Bearer ${token}`,\r\n\t\t\t\t\t},\r\n\t\t\t\t});\r\n\r\n\t\t\t\tif (getResponse.ok) {\r\n\t\t\t\t\tconst documentData = await getResponse.json();\r\n\t\t\t\t\tconsole.log('Fetched document for save:', documentData);\r\n\r\n\t\t\t\t\t// Save the document\r\n\t\t\t\t\tconst saveResponse = await fetch(`/umbraco/management/api/v1/document/${newDocumentId}`, {\r\n\t\t\t\t\t\tmethod: 'PUT',\r\n\t\t\t\t\t\theaders: {\r\n\t\t\t\t\t\t\t'Content-Type': 'application/json',\r\n\t\t\t\t\t\t\tAuthorization: `Bearer ${token}`,\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tbody: JSON.stringify(documentData),\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t\tif (saveResponse.ok) {\r\n\t\t\t\t\t\tconsole.log('Document saved successfully');\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tconsole.warn('Document save failed, but document was created:', await saveResponse.text());\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconsole.warn('Could not fetch document for save:', await getResponse.text());\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tnotificationContext.peek('positive', {\r\n\t\t\t\tdata: { message: `Document \"${name}\" created successfully!` },\r\n\t\t\t});\r\n\r\n\t\t\t// Navigate to the new document after a short delay\r\n\t\t\tif (newDocumentId) {\r\n\t\t\t\tconst newPath = `/umbraco/section/content/workspace/document/edit/${newDocumentId}`;\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\twindow.location.href = newPath;\r\n\t\t\t\t}, 150);\r\n\t\t\t}\r\n\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error('Error creating document:', error);\r\n\t\t\tnotificationContext.peek('danger', {\r\n\t\t\t\tdata: { message: 'An unexpected error occurred while creating the document.' },\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Updates the contentGrid value to replace the \"Suggested Itinerary\" RTE content\r\n\t */\r\n\t#updateContentGridWithItinerary(values: Array<{ alias: string; value: unknown }>, itineraryContent: string) {\r\n\t\tconst contentGridValue = values.find((v) => v.alias === 'contentGrid');\r\n\t\tif (!contentGridValue || !contentGridValue.value) {\r\n\t\t\tconsole.log('No contentGrid found in scaffold values');\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\ttry {\r\n\t\t\t// Track if the value was originally a string (need to stringify back)\r\n\t\t\tconst wasString = typeof contentGridValue.value === 'string';\r\n\t\t\tconsole.log('contentGrid original type:', wasString ? 'string' : 'object');\r\n\r\n\t\t\t// Parse the contentGrid JSON\r\n\t\t\tconst contentGrid = wasString\r\n\t\t\t\t? JSON.parse(contentGridValue.value as string)\r\n\t\t\t\t: contentGridValue.value;\r\n\r\n\t\t\tconsole.log('Parsed contentGrid:', contentGrid);\r\n\t\t\tconsole.log('contentData length:', contentGrid.contentData?.length);\r\n\r\n\t\t\t// Find the content block with \"Suggested Itinerary\" as the feature title\r\n\t\t\tconst contentData = contentGrid.contentData as Array<{\r\n\t\t\t\tcontentTypeKey: string;\r\n\t\t\t\tkey: string;\r\n\t\t\t\tvalues: Array<{ alias: string; value: unknown }>;\r\n\t\t\t}>;\r\n\r\n\t\t\tif (!contentData) {\r\n\t\t\t\tconsole.log('No contentData in contentGrid');\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\t// Look for a block that has featurePropertyFeatureTitle = \"Suggested Itinerary\"\r\n\t\t\tlet foundBlock = false;\r\n\t\t\tfor (const block of contentData) {\r\n\t\t\t\tconsole.log('Checking block:', block.key, 'contentTypeKey:', block.contentTypeKey);\r\n\t\t\t\tconsole.log('Block values:', block.values?.map((v) => ({ alias: v.alias, value: typeof v.value === 'object' ? '[object]' : v.value })));\r\n\r\n\t\t\t\tconst titleValue = block.values?.find((v) => v.alias === 'featurePropertyFeatureTitle');\r\n\t\t\t\tconsole.log('Title value for block:', titleValue?.value);\r\n\r\n\t\t\t\tif (titleValue && typeof titleValue.value === 'string' &&\r\n\t\t\t\t\ttitleValue.value.toLowerCase().includes('suggested itinerary')) {\r\n\r\n\t\t\t\t\tconsole.log('Found Suggested Itinerary block:', block.key);\r\n\t\t\t\t\tfoundBlock = true;\r\n\r\n\t\t\t\t\t// Find and update the richTextContent\r\n\t\t\t\t\tconst rteValue = block.values?.find((v) => v.alias === 'richTextContent');\r\n\t\t\t\t\tif (rteValue) {\r\n\t\t\t\t\t\t// Convert plain text to HTML paragraphs\r\n\t\t\t\t\t\tconst htmlContent = this.#convertToHtml(itineraryContent);\r\n\t\t\t\t\t\trteValue.value = {\r\n\t\t\t\t\t\t\tblocks: {\r\n\t\t\t\t\t\t\t\tcontentData: [],\r\n\t\t\t\t\t\t\t\tsettingsData: [],\r\n\t\t\t\t\t\t\t\texpose: [],\r\n\t\t\t\t\t\t\t\tLayout: {},\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\tmarkup: htmlContent,\r\n\t\t\t\t\t\t};\r\n\t\t\t\t\t\tconsole.log('Updated richTextContent with itinerary');\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (!foundBlock) {\r\n\t\t\t\tconsole.log('WARNING: Did not find a block with featurePropertyFeatureTitle containing \"suggested itinerary\"');\r\n\t\t\t}\r\n\r\n\t\t\t// Update the contentGrid value - stringify back if it was originally a string\r\n\t\t\tcontentGridValue.value = wasString ? JSON.stringify(contentGrid) : contentGrid;\r\n\t\t\tconsole.log('ContentGrid updated successfully (stringified:', wasString, ')');\r\n\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error('Failed to update contentGrid:', error);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Converts plain text to HTML with paragraph tags\r\n\t */\r\n\t#convertToHtml(text: string): string {\r\n\t\tif (!text) return '';\r\n\r\n\t\t// Split by newlines and wrap each non-empty line in paragraph tags\r\n\t\tconst paragraphs = text\r\n\t\t\t.split(/\\n+/)\r\n\t\t\t.filter((line) => line.trim())\r\n\t\t\t.map((line) => `<p>${this.#escapeHtml(line.trim())}</p>`)\r\n\t\t\t.join('\\n');\r\n\r\n\t\treturn paragraphs || `<p>${this.#escapeHtml(text)}</p>`;\r\n\t}\r\n\r\n\t/**\r\n\t * Escapes HTML special characters\r\n\t */\r\n\t#escapeHtml(text: string): string {\r\n\t\treturn text\r\n\t\t\t.replace(/&/g, '&amp;')\r\n\t\t\t.replace(/</g, '&lt;')\r\n\t\t\t.replace(/>/g, '&gt;')\r\n\t\t\t.replace(/\"/g, '&quot;')\r\n\t\t\t.replace(/'/g, '&#039;');\r\n\t}\r\n}\r\n\r\nexport default CreateFromPdfEntityAction;\r\n"],"names":["UMB_CREATE_FROM_PDF_MODAL","UmbModalToken","CreateFromPdfEntityAction","UmbEntityActionBase","host","args","__privateAdd","_CreateFromPdfEntityAction_instances","_documentTypeStructureRepository","UmbDocumentTypeStructureRepository","_blueprintItemRepository","UmbDocumentBlueprintItemRepository","_documentItemRepository","UmbDocumentItemRepository","notificationContext","UMB_NOTIFICATION_CONTEXT","parentUnique","modalValue","umbOpenModal","name","mediaUnique","pageTitle","pageTitleShort","pageDescription","itineraryContent","parentDocTypeUnique","parentItems","__privateGet","result","allowedTypes","_a","blueprint","documentTypeUnique","docType","blueprints","token","UMB_AUTH_CONTEXT","scaffoldResponse","error","scaffold","values","setValue","alias","value","existing","v","__privateMethod","updateContentGridWithItinerary_fn","createRequest","createResponse","locationHeader","newDocumentId","getResponse","documentData","saveResponse","newPath","contentGridValue","wasString","contentGrid","contentData","foundBlock","block","_b","titleValue","_c","rteValue","_d","htmlContent","convertToHtml_fn","text","line","escapeHtml_fn"],"mappings":"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"}