{"version":3,"file":"section-rules-editor-modal.element-C2mlgdvn.js","sources":["../src/workflow.types.ts","../src/section-rules-editor-modal.element.ts"],"sourcesContent":["// ============================================================================\r\n// Source Config Types (source.json)\r\n// ============================================================================\r\n\r\nexport interface SourceConfig {\r\n\tversion: string;\r\n\tsourceTypes: string[];\r\n\tglobals?: SourceGlobals;\r\n\t/** Top-level page selection: \"all\" or array of page numbers. */\r\n\tpages?: number[] | 'all';\r\n\tsections: SourceSection[];\r\n\t/** Legacy: rules keyed by section ID. Superseded by areaRules. */\r\n\tsectionRules?: Record<string, SectionRuleSet>;\r\n\t/** Rules for breaking area elements into individually-mappable sections, keyed by area name in kebab-case.\r\n\t * Supports both old flat format { rules: [...] } and new grouped format { groups: [...], rules: [...] }. */\r\n\tareaRules?: Record<string, AreaRules>;\r\n}\r\n\r\n// ============================================================================\r\n// Section Rules Types (stored in source.json under sectionRules)\r\n// ============================================================================\r\n\r\n/** Legacy flat rule set — kept for backward-compatible deserialization of sectionRules. */\r\nexport interface SectionRuleSet {\r\n\trules: SectionRule[];\r\n}\r\n\r\n// ============================================================================\r\n// v3 Area Rules Types (groups + ungrouped)\r\n// ============================================================================\r\n\r\n/** Which slot a rule fills within a group. Title triggers section boundaries. */\r\nexport type RulePart = 'title' | 'content' | 'description' | 'summary';\r\n\r\n/** Top-level container for an area's rules. Groups contain multi-part sections; ungrouped rules are single properties. */\r\nexport interface AreaRules {\r\n\tgroups: RuleGroup[];\r\n\trules: SectionRule[];  // Ungrouped\r\n}\r\n\r\n/** A named group of rules representing a multi-part section (e.g., \"Tour Detail\" with title + content). */\r\nexport interface RuleGroup {\r\n\tname: string;\r\n\trules: SectionRule[];\r\n}\r\n\r\n/** Legacy action names — kept for backward compat deserialization */\r\nexport type RuleAction = 'singleProperty' | 'sectionTitle' | 'sectionContent' | 'sectionDescription' | 'sectionSummary' | 'exclude';\r\nexport type LegacyRuleAction = 'createSection' | 'setAsHeading' | 'addAsContent' | 'addAsList';\r\n\r\n/**\r\n * Block-level Markdown format.\r\n * Determines what Markdown syntax the matched content produces.\r\n */\r\nexport type BlockFormat =\r\n\t| 'auto'\r\n\t| 'paragraph'\r\n\t| 'heading1' | 'heading2' | 'heading3'\r\n\t| 'heading4' | 'heading5' | 'heading6'\r\n\t| 'bulletListItem' | 'numberedListItem'\r\n\t| 'quote';\r\n\r\n/** Legacy alias — kept for backward compat */\r\nexport type RuleContentFormat = BlockFormat;\r\n\r\n/** Format entry types — Block (block-level Markdown) or Style (inline Markdown) */\r\nexport type FormatEntryType = 'block' | 'style';\r\n\r\n/** Block-level format values — each maps to a Markdown block element */\r\nexport type BlockFormatValue =\r\n\t| 'auto'\r\n\t| 'paragraph'\r\n\t| 'heading1' | 'heading2' | 'heading3'\r\n\t| 'heading4' | 'heading5' | 'heading6'\r\n\t| 'bulletListItem' | 'numberedListItem'\r\n\t| 'quote';\r\n\r\n/** Inline style format values — each wraps text in Markdown inline syntax */\r\nexport type StyleFormatValue = 'bold' | 'italic' | 'strikethrough' | 'code' | 'highlight';\r\n\r\n/** A single format entry — either a block format or an inline style */\r\nexport interface FormatEntry {\r\n\ttype: FormatEntryType;\r\n\tvalue: BlockFormatValue | StyleFormatValue;\r\n}\r\n\r\nexport interface SectionRule {\r\n\trole: string;\r\n\t/** v3: which slot this rule fills. */\r\n\tpart?: RulePart;\r\n\t/** Legacy: action name. When part is set, action is ignored. */\r\n\taction?: RuleAction | LegacyRuleAction;\r\n\t/** Block format: auto, paragraph, heading1-6, etc. */\r\n\tformat?: BlockFormat;\r\n\t/** Array of format entries (Block + Style rows). */\r\n\tformats?: FormatEntry[];\r\n\t/** When true, matched elements are skipped entirely. */\r\n\texclude?: boolean;\r\n\tconditions: RuleCondition[];\r\n\t/** UNLESS conditions — if any single exception matches, the rule does not apply. */\r\n\texceptions?: RuleCondition[];\r\n\t/** Transient: unique ID for drag-and-drop tracking. Not persisted. */\r\n\t_id?: string;\r\n}\r\n\r\n/** Get the effective part for a rule, normalizing from legacy action if needed. */\r\nexport function getEffectivePart(rule: SectionRule): RulePart | 'exclude' {\r\n\tif (rule.exclude) return 'exclude';\r\n\tif (rule.part) return rule.part;\r\n\r\n\t// Normalize from legacy action\r\n\tswitch (rule.action) {\r\n\t\tcase 'singleProperty':\r\n\t\tcase 'sectionProperty':\r\n\t\tcase 'sectionContent':\r\n\t\tcase 'addAsContent':\r\n\t\tcase 'addAsList':\r\n\t\t\treturn 'content';\r\n\t\tcase 'sectionTitle':\r\n\t\tcase 'createSection':\r\n\t\tcase 'setAsHeading':\r\n\t\t\treturn 'title';\r\n\t\tcase 'sectionDescription':\r\n\t\t\treturn 'description';\r\n\t\tcase 'sectionSummary':\r\n\t\t\treturn 'summary';\r\n\t\tcase 'exclude':\r\n\t\t\treturn 'exclude';\r\n\t\tdefault:\r\n\t\t\treturn 'content';\r\n\t}\r\n}\r\n\r\n/** Get the effective block format for a rule. */\r\nexport function getEffectiveFormat(rule: SectionRule): BlockFormat {\r\n\tif (rule.format) return rule.format;\r\n\tif (rule.action === 'addAsList') return 'bulletListItem';\r\n\treturn 'auto';\r\n}\r\n\r\n/** Legacy normalize helper — kept for backward compat. Prefer getEffectivePart/getEffectiveFormat. */\r\nexport function normalizeAction(action: string, format?: RuleContentFormat): [RuleAction, RuleContentFormat | undefined] {\r\n\tswitch (action) {\r\n\t\tcase 'createSection':\r\n\t\tcase 'setAsHeading':\r\n\t\t\treturn ['sectionTitle', undefined];\r\n\t\tcase 'addAsContent':\r\n\t\t\treturn ['sectionContent', format ?? 'paragraph'];\r\n\t\tcase 'addAsList':\r\n\t\t\treturn ['sectionContent', format ?? 'bulletListItem'];\r\n\t\tcase 'singleProperty':\r\n\t\tcase 'sectionProperty':\r\n\t\t\treturn ['singleProperty', format ?? 'paragraph'];\r\n\t\tcase 'sectionTitle':\r\n\t\t\treturn ['sectionTitle', undefined];\r\n\t\tcase 'sectionContent':\r\n\t\t\treturn ['sectionContent', format ?? 'paragraph'];\r\n\t\tcase 'exclude':\r\n\t\t\treturn ['exclude', undefined];\r\n\t\tdefault:\r\n\t\t\treturn ['sectionContent', format ?? 'paragraph'];\r\n\t}\r\n}\r\n\r\n/**\r\n * Convert a legacy SectionRuleSet (flat rules) to AreaRules.\r\n * All rules go into the ungrouped array; groups is empty.\r\n */\r\nexport function toAreaRules(ruleSet: SectionRuleSet | AreaRules): AreaRules {\r\n\t// Already an AreaRules (has groups property)\r\n\tif ('groups' in ruleSet && Array.isArray(ruleSet.groups)) {\r\n\t\treturn ruleSet as AreaRules;\r\n\t}\r\n\t// Legacy SectionRuleSet — wrap\r\n\treturn { groups: [], rules: (ruleSet as SectionRuleSet).rules };\r\n}\r\n\r\n/** Get all rules from an AreaRules in order: grouped first, then ungrouped. */\r\nexport function allRules(areaRules: AreaRules): SectionRule[] {\r\n\tconst result: SectionRule[] = [];\r\n\tfor (const group of areaRules.groups) {\r\n\t\tresult.push(...group.rules);\r\n\t}\r\n\tresult.push(...areaRules.rules);\r\n\treturn result;\r\n}\r\n\r\nexport interface RuleCondition {\r\n\ttype: RuleConditionType;\r\n\tvalue?: string | number;\r\n}\r\n\r\nexport type RuleConditionType =\r\n\t| 'textBeginsWith'\r\n\t| 'textEndsWith'\r\n\t| 'textContains'\r\n\t| 'textEquals'\r\n\t| 'textMatchesPattern'\r\n\t| 'fontSizeEquals'\r\n\t| 'fontSizeAbove'\r\n\t| 'fontSizeBelow'\r\n\t| 'fontNameContains'\r\n\t| 'fontNameEquals'\r\n\t| 'colorEquals'\r\n\t| 'positionFirst'\r\n\t| 'positionLast';\r\n\r\n/**\r\n * Pattern for identifying section heading elements within an area.\r\n * Null/undefined = auto-detect (bodySize * 1.15).\r\n * Empty conditions = flat section (no grouping).\r\n * Populated conditions = user-defined from teach-by-example.\r\n */\r\nexport interface SectionPattern {\r\n\tconditions: RuleCondition[];\r\n}\r\n\r\nexport interface SourceGlobals {\r\n\tcolumnDetection?: ColumnDetectionConfig;\r\n\tpageRange?: PageRangeConfig;\r\n}\r\n\r\nexport interface ColumnDetectionConfig {\r\n\tenabled: boolean;\r\n\tthresholdPercent: number;\r\n}\r\n\r\nexport interface PageRangeConfig {\r\n\tstart: number;\r\n\tend: number | 'last';\r\n}\r\n\r\nexport interface SourceSection {\r\n\tkey: string;\r\n\tlabel: string;\r\n\tdescription?: string;\r\n\tstrategy: ExtractionStrategy;\r\n\toutputFormat: 'text' | 'markdown' | 'html';\r\n\trequired?: boolean;\r\n\tpages?: number[] | 'all';\r\n\tcolumnFilter?: boolean;\r\n\toccurrence?: 'first' | 'last' | 'all';\r\n\tstrategyParams?: StrategyParams;\r\n}\r\n\r\nexport type ExtractionStrategy =\r\n\t| 'largestFont'\r\n\t| 'regex'\r\n\t| 'betweenPatterns'\r\n\t| 'region'\r\n\t| 'afterLabel'\r\n\t| 'firstHeading'\r\n\t| 'firstParagraph'\r\n\t| 'cssSelector'\r\n\t| 'xpath';\r\n\r\nexport interface StrategyParams {\r\n\t// largestFont\r\n\tfontSizeThreshold?: number;\r\n\r\n\t// regex\r\n\tpattern?: string;\r\n\tflags?: string;\r\n\tcaptureGroup?: number;\r\n\r\n\t// betweenPatterns\r\n\tstartPattern?: string;\r\n\tstopPatterns?: string[];\r\n\tincludeStartLine?: boolean;\r\n\theadingLevel?: 'h1' | 'h2' | 'h3' | 'h4' | 'h5' | 'h6';\r\n\r\n\t// region\r\n\tregion?: RegionConfig;\r\n\r\n\t// firstHeading (markdown)\r\n\tlevel?: number;\r\n\r\n\t// afterLabel\r\n\tlabel?: string;\r\n\tlabelPattern?: string;\r\n\textractMode?: 'sameLine' | 'nextLine' | 'untilBlank';\r\n\r\n\t// cssSelector (web)\r\n\tselector?: string;\r\n\tattribute?: string;\r\n\r\n\t// xpath (web/Word)\r\n\txpath?: string;\r\n}\r\n\r\nexport interface RegionConfig {\r\n\tx?: { min?: number; max?: number };\r\n\ty?: { min?: number; max?: number };\r\n\tunit?: 'percent' | 'points';\r\n}\r\n\r\n// ============================================================================\r\n// Destination Config Types (destination.json)\r\n// ============================================================================\r\n\r\nexport interface DestinationConfig {\r\n\tversion: string;\r\n\tdocumentTypeAlias: string;\r\n\tdocumentTypeName?: string;\r\n\tblueprintId?: string;\r\n\tblueprintName?: string;\r\n\tfields: DestinationField[];\r\n\tblockGrids?: DestinationBlockGrid[];\r\n}\r\n\r\nexport interface DestinationField {\r\n\tkey: string;\r\n\talias: string;\r\n\tlabel: string;\r\n\tdescription?: string;\r\n\ttype: FieldType;\r\n\ttab?: string;\r\n\tmandatory?: boolean;\r\n\tacceptsFormats?: ContentFormat[];\r\n}\r\n\r\nexport type FieldType =\r\n\t| 'text'\r\n\t| 'textArea'\r\n\t| 'richText'\r\n\t| 'number'\r\n\t| 'date'\r\n\t| 'boolean'\r\n\t| 'mediaPicker'\r\n\t| 'contentPicker'\r\n\t| 'blockGrid'\r\n\t| 'blockList';\r\n\r\nexport type ContentFormat = 'text' | 'markdown' | 'html';\r\n\r\nexport interface DestinationBlockGrid {\r\n\tkey: string;\r\n\talias: string;\r\n\tlabel: string;\r\n\tdescription?: string;\r\n\tblocks: DestinationBlock[];\r\n}\r\n\r\nexport interface DestinationBlock {\r\n\tkey: string;\r\n\tcontentTypeAlias: string;\r\n\tcontentTypeKey?: string;\r\n\tlabel: string;\r\n\tdescription?: string;\r\n\tidentifyBy?: BlockIdentifier;\r\n\tproperties?: BlockProperty[];\r\n}\r\n\r\nexport interface BlockIdentifier {\r\n\tproperty: string;\r\n\tvalue: string;\r\n}\r\n\r\nexport interface BlockProperty {\r\n\tkey: string;\r\n\talias: string;\r\n\tlabel?: string;\r\n\ttype: FieldType;\r\n\tacceptsFormats?: ContentFormat[];\r\n}\r\n\r\n// ============================================================================\r\n// Map Config Types (map.json)\r\n// ============================================================================\r\n\r\nexport interface MapConfig {\r\n\tversion: string;\r\n\tname?: string;\r\n\tdescription?: string;\r\n\tmappings: SectionMapping[];\r\n}\r\n\r\nexport interface SectionMapping {\r\n\tsource: string;\r\n\tdestinations: MappingDestination[];\r\n\tenabled?: boolean;\r\n\tcomment?: string;\r\n}\r\n\r\nexport interface MappingDestination {\r\n\ttarget: string;\r\n\tblockKey?: string;\r\n\ttransforms?: MappingTransform[];\r\n}\r\n\r\nexport interface MappingTransform {\r\n\ttype: TransformType;\r\n\tparams?: TransformParams;\r\n}\r\n\r\nexport type TransformType =\r\n\t| 'convertMarkdownToHtml'\r\n\t| 'convertHtmlToMarkdown'\r\n\t| 'truncate'\r\n\t| 'template'\r\n\t| 'regex'\r\n\t| 'trim'\r\n\t| 'uppercase'\r\n\t| 'lowercase'\r\n\t| 'stripHtml';\r\n\r\nexport interface TransformParams {\r\n\tmaxLength?: number;\r\n\tsuffix?: string;\r\n\ttemplate?: string;\r\n\tpattern?: string;\r\n\treplacement?: string;\r\n}\r\n\r\n// ============================================================================\r\n// Combined Document Type Config\r\n// ============================================================================\r\n\r\nexport interface DocumentTypeConfig {\r\n\tfolderPath: string;\r\n\tdocumentTypeAlias: string;\r\n\tsources: Record<string, SourceConfig>;\r\n\tdestination: DestinationConfig;\r\n\tmap: MapConfig;\r\n}\r\n\r\n// ============================================================================\r\n// Rich Extraction Types (sample-extraction.json)\r\n// ============================================================================\r\n\r\nexport interface RichExtractionResult {\r\n\tversion: string;\r\n\tsourceType: string;\r\n\tsource: ExtractionSource;\r\n\telements: ExtractionElement[];\r\n}\r\n\r\nexport interface ExtractionSource {\r\n\tfileName: string;\r\n\tmediaKey: string;\r\n\textractedDate: string;\r\n\ttotalPages: number;\r\n\t/** Which pages were extracted. Null/undefined = all pages. */\r\n\textractedPages?: number[] | null;\r\n}\r\n\r\nexport interface ExtractionElement {\r\n\tid: string;\r\n\tpage: number;\r\n\ttext: string;\r\n\tmetadata: ElementMetadata;\r\n}\r\n\r\nexport interface ElementMetadata {\r\n\tfontSize: number;\r\n\tfontName: string;\r\n\tposition: { x: number; y: number };\r\n\tboundingBox: { left: number; top: number; width: number; height: number };\r\n\tcolor: string;\r\n}\r\n\r\n// ============================================================================\r\n// Visual Grouping Types (frontend-only, computed from extraction metadata)\r\n// ============================================================================\r\n\r\nexport interface VisualGroup {\r\n\theading: ExtractionElement | null;\r\n\tchildren: ExtractionElement[];\r\n}\r\n\r\n// ============================================================================\r\n// Area Detection Types (area-detection.json — area-based hierarchical extraction)\r\n// ============================================================================\r\n\r\nexport interface AreaDetectionResult {\r\n\ttotalPages: number;\r\n\tpages: PageAreas[];\r\n\tdiagnostics: AreaDiagnosticInfo;\r\n}\r\n\r\nexport interface PageAreas {\r\n\tpage: number;\r\n\tareas: DetectedArea[];\r\n}\r\n\r\nexport interface DetectedArea {\r\n\tname?: string;\r\n\tcolor: string;\r\n\tboundingBox: { left: number; top: number; width: number; height: number };\r\n\tpage: number;\r\n\tsections: DetectedSection[];\r\n\ttotalElements: number;\r\n\tsectionPattern?: SectionPattern;\r\n}\r\n\r\nexport interface DetectedSection {\r\n\theading: AreaElement | null;\r\n\tchildren: AreaElement[];\r\n}\r\n\r\nexport interface AreaElement {\r\n\tid: string;\r\n\ttext: string;\r\n\tfontSize: number;\r\n\tfontName: string;\r\n\tcolor: string;\r\n\tboundingBox: { left: number; top: number; width: number; height: number };\r\n}\r\n\r\nexport interface AreaDiagnosticInfo {\r\n\ttotalPathsFound: number;\r\n\tpathsAfterFiltering: number;\r\n\tareasDetected: number;\r\n\telementsInAreas: number;\r\n}\r\n\r\n// ============================================================================\r\n// Transform Result Types (transform.json — assembled Markdown per section)\r\n// ============================================================================\r\n\r\nexport interface TransformResult {\r\n\tversion: string;\r\n\tsections: TransformedSection[];\r\n\tdiagnostics: TransformDiagnostics;\r\n}\r\n\r\nexport interface TransformedSection {\r\n\tid: string;\r\n\toriginalHeading: string | null;\r\n\theading: string | null;\r\n\tcontent: string;\r\n\t/** Assembled Markdown from sectionDescription elements. Null if none. */\r\n\tdescription?: string | null;\r\n\t/** Assembled Markdown from sectionSummary elements. Null if none. */\r\n\tsummary?: string | null;\r\n\tpattern: 'bulletList' | 'paragraph' | 'subHeaded' | 'preamble' | 'mixed' | 'role';\r\n\tpage: number;\r\n\tareaColor: string | null;\r\n\tareaName: string | null;\r\n\tchildCount: number;\r\n\tincluded: boolean;\r\n}\r\n\r\nexport interface TransformDiagnostics {\r\n\ttotalSections: number;\r\n\tbulletListSections: number;\r\n\tparagraphSections: number;\r\n\tsubHeadedSections: number;\r\n\tpreambleSections: number;\r\n\troleSections: number;\r\n}\r\n\r\n// ============================================================================\r\n// Area Template Types (area-template.json — user-defined extraction areas)\r\n// ============================================================================\r\n\r\nexport interface AreaTemplate {\r\n\ttemplateName: string;\r\n\tsourceFile: string;\r\n\tpageSize: { width: number; height: number };\r\n\tcreatedAt: string;\r\n\tareas: AreaDefinition[];\r\n}\r\n\r\nexport interface AreaDefinition {\r\n\tname: string;\r\n\tproperty: string;\r\n\tpage: number;\r\n\ttype: string;\r\n\tbounds: AreaBounds;\r\n\tcolor: string;\r\n\tsectionPattern?: SectionPattern;\r\n\texpectedSections: string[];\r\n\tnotes: string;\r\n}\r\n\r\nexport interface AreaBounds {\r\n\tx: number;\r\n\ty: number;\r\n\twidth: number;\r\n\theight: number;\r\n}\r\n\r\n// ============================================================================\r\n// API Response Types\r\n// ============================================================================\r\n\r\nexport interface ExtractSectionsResponse {\r\n\tsections: Record<string, string>;\r\n\tconfig: DocumentTypeConfig;\r\n}\r\n\r\nexport interface InferSectionPatternResponse {\r\n\tpattern: SectionPattern;\r\n\tmatchingElementIds: string[];\r\n\tclickedElementId: string;\r\n\ttotalElements: number;\r\n}\r\n","import type { SectionRulesEditorModalData, SectionRulesEditorModalValue } from './section-rules-editor-modal.token.js';\r\nimport type { SectionRule, RuleCondition, RuleConditionType, RulePart, BlockFormat, FormatEntry, FormatEntryType, AreaElement, AreaRules, RuleGroup } from './workflow.types.js';\r\nimport { getEffectivePart, getEffectiveFormat } from './workflow.types.js';\r\nimport { html, css, state, nothing } from '@umbraco-cms/backoffice/external/lit';\r\nimport { customElement } from '@umbraco-cms/backoffice/external/lit';\r\nimport { UmbModalBaseElement } from '@umbraco-cms/backoffice/modal';\r\nimport { UmbTextStyles } from '@umbraco-cms/backoffice/style';\r\n\r\n/**\r\n * Editable rule: SectionRule + transient tracking fields for the modal.\r\n * _id is used for drag-and-drop tracking. _groupName tracks which group the rule belongs to.\r\n */\r\ninterface EditableRule extends SectionRule {\r\n\t_id: string;\r\n\t_groupName: string | null;\r\n}\r\n\r\nlet _nextRuleId = 0;\r\nfunction generateRuleId(): string {\r\n\treturn `r-${++_nextRuleId}`;\r\n}\r\n\r\n/** Friendly labels for condition types */\r\nconst CONDITION_LABELS: Record<RuleConditionType, string> = {\r\n\ttextBeginsWith: 'Text begins with',\r\n\ttextEndsWith: 'Text ends with',\r\n\ttextContains: 'Text contains',\r\n\ttextEquals: 'Text equals',\r\n\ttextMatchesPattern: 'Text matches pattern',\r\n\tfontSizeEquals: 'Font size equals',\r\n\tfontSizeAbove: 'Font size above',\r\n\tfontSizeBelow: 'Font size below',\r\n\tfontNameContains: 'Font name contains',\r\n\tfontNameEquals: 'Font name equals',\r\n\tcolorEquals: 'Color equals',\r\n\tpositionFirst: 'Position: first',\r\n\tpositionLast: 'Position: last',\r\n};\r\n\r\n/** Condition types that don't need a value input */\r\nconst VALUELESS_CONDITIONS: RuleConditionType[] = ['positionFirst', 'positionLast'];\r\n\r\n/** All available condition types */\r\nconst ALL_CONDITION_TYPES: RuleConditionType[] = [\r\n\t'textBeginsWith', 'textEndsWith', 'textContains', 'textEquals', 'textMatchesPattern',\r\n\t'fontSizeEquals', 'fontSizeAbove', 'fontSizeBelow',\r\n\t'fontNameContains', 'fontNameEquals', 'colorEquals',\r\n\t'positionFirst', 'positionLast',\r\n];\r\n\r\n/** Friendly labels for rule parts */\r\nconst PART_LABELS: Record<RulePart, string> = {\r\n\ttitle: 'Title',\r\n\tcontent: 'Content',\r\n\tdescription: 'Description',\r\n\tsummary: 'Summary',\r\n};\r\n\r\n/** All available rule parts */\r\nconst ALL_PARTS: RulePart[] = ['title', 'content', 'description', 'summary'];\r\n\r\n/** Format entry type labels */\r\nconst FORMAT_ENTRY_TYPE_LABELS: Record<FormatEntryType, string> = {\r\n\tblock: 'Block',\r\n\tstyle: 'Style',\r\n};\r\n\r\nconst ALL_FORMAT_ENTRY_TYPES: FormatEntryType[] = ['block', 'style'];\r\n\r\n/** Block format value labels (block-level Markdown elements) */\r\nconst BLOCK_FORMAT_LABELS: Record<string, string> = {\r\n\tauto: 'Auto',\r\n\tparagraph: 'Paragraph',\r\n\theading1: 'Heading 1',\r\n\theading2: 'Heading 2',\r\n\theading3: 'Heading 3',\r\n\theading4: 'Heading 4',\r\n\theading5: 'Heading 5',\r\n\theading6: 'Heading 6',\r\n\tbulletListItem: 'Bullet List',\r\n\tnumberedListItem: 'Numbered List',\r\n\tquote: 'Quote',\r\n};\r\n\r\nconst ALL_BLOCK_FORMATS: string[] = [\r\n\t'auto', 'paragraph', 'heading1', 'heading2', 'heading3', 'heading4', 'heading5', 'heading6',\r\n\t'bulletListItem', 'numberedListItem', 'quote',\r\n];\r\n\r\n/** Style format value labels (inline Markdown decorations) */\r\nconst STYLE_FORMAT_LABELS: Record<string, string> = {\r\n\tbold: 'Bold',\r\n\titalic: 'Italic',\r\n\tstrikethrough: 'Strikethrough',\r\n\tcode: 'Code',\r\n\thighlight: 'Highlight',\r\n};\r\n\r\nconst ALL_STYLE_FORMATS: string[] = ['bold', 'italic', 'strikethrough', 'code', 'highlight'];\r\n\r\n@customElement('up-doc-section-rules-editor-modal')\r\nexport class UpDocSectionRulesEditorModalElement extends UmbModalBaseElement<SectionRulesEditorModalData, SectionRulesEditorModalValue> {\r\n\t/** Flat array of all rules (grouped + ungrouped). Each carries _groupName for grouping. */\r\n\t@state() private _rules: EditableRule[] = [];\r\n\t/** Ordered list of group names. */\r\n\t@state() private _groupOrder: string[] = [];\r\n\t/** Track collapsed state per rule section: \"conditions-0\", \"exceptions-1\", etc. */\r\n\t@state() private _collapsed: Set<string> = new Set();\r\n\t/** Track which rules are expanded (by _id). All collapsed by default. */\r\n\t@state() private _expandedRules: Set<string> = new Set();\r\n\t/** Group currently being renamed (null = none). */\r\n\t@state() private _renamingGroup: string | null = null;\r\n\t@state() private _renameValue = '';\r\n\r\n\t#isCollapsed(section: string, ruleIdx: number): boolean {\r\n\t\treturn this._collapsed.has(`${section}-${ruleIdx}`);\r\n\t}\r\n\r\n\t#toggleCollapsed(section: string, ruleIdx: number) {\r\n\t\tconst key = `${section}-${ruleIdx}`;\r\n\t\tconst next = new Set(this._collapsed);\r\n\t\tif (next.has(key)) {\r\n\t\t\tnext.delete(key);\r\n\t\t} else {\r\n\t\t\tnext.add(key);\r\n\t\t}\r\n\t\tthis._collapsed = next;\r\n\t}\r\n\r\n\t#isRuleExpanded(ruleId: string): boolean {\r\n\t\treturn this._expandedRules.has(ruleId);\r\n\t}\r\n\r\n\t#toggleRuleExpanded(ruleId: string) {\r\n\t\tconst next = new Set(this._expandedRules);\r\n\t\tif (next.has(ruleId)) {\r\n\t\t\tnext.delete(ruleId);\r\n\t\t} else {\r\n\t\t\tnext.add(ruleId);\r\n\t\t}\r\n\t\tthis._expandedRules = next;\r\n\t}\r\n\r\n\t#expandRule(ruleId: string) {\r\n\t\tif (!this._expandedRules.has(ruleId)) {\r\n\t\t\tconst next = new Set(this._expandedRules);\r\n\t\t\tnext.add(ruleId);\r\n\t\t\tthis._expandedRules = next;\r\n\t\t}\r\n\t}\r\n\r\n\toverride firstUpdated() {\r\n\t\tconst areaRules = this.data?.existingRules;\r\n\t\tif (!areaRules) return;\r\n\r\n\t\tconst editableRules: EditableRule[] = [];\r\n\t\tconst groupOrder: string[] = [];\r\n\r\n\t\t// Grouped rules first\r\n\t\tfor (const group of (areaRules.groups ?? [])) {\r\n\t\t\tgroupOrder.push(group.name);\r\n\t\t\tfor (const rule of group.rules) {\r\n\t\t\t\teditableRules.push(this.#normalizeRule(rule, group.name));\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// Ungrouped rules\r\n\t\tfor (const rule of (areaRules.rules ?? [])) {\r\n\t\t\teditableRules.push(this.#normalizeRule(rule, null));\r\n\t\t}\r\n\r\n\t\tthis._rules = editableRules;\r\n\t\tthis._groupOrder = groupOrder;\r\n\t}\r\n\r\n\t/** Normalize a rule on load: derive part from legacy action, migrate formats. */\r\n\t#normalizeRule(rule: SectionRule, groupName: string | null): EditableRule {\r\n\t\tlet part = rule.part as RulePart | undefined;\r\n\t\tlet exclude = rule.exclude ?? false;\r\n\r\n\t\t// Normalize from legacy action field\r\n\t\tif (!part && !exclude) {\r\n\t\t\tconst derived = getEffectivePart(rule);\r\n\t\t\tif (derived === 'exclude') {\r\n\t\t\t\texclude = true;\r\n\t\t\t} else {\r\n\t\t\t\tpart = derived as RulePart;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// Migrate old single format to formats array\r\n\t\tlet formats = rule.formats;\r\n\t\tif (!formats || formats.length === 0) {\r\n\t\t\tconst blockValue = rule.format ?? getEffectiveFormat(rule);\r\n\t\t\tformats = [{ type: 'block' as FormatEntryType, value: blockValue }];\r\n\t\t}\r\n\r\n\t\treturn {\r\n\t\t\t...rule,\r\n\t\t\tpart,\r\n\t\t\texclude,\r\n\t\t\tformats,\r\n\t\t\t_id: generateRuleId(),\r\n\t\t\t_groupName: groupName,\r\n\t\t};\r\n\t}\r\n\r\n\tget #elements(): AreaElement[] {\r\n\t\treturn this.data?.elements ?? [];\r\n\t}\r\n\r\n\tget #sectionHeading(): string {\r\n\t\treturn this.data?.sectionHeading ?? 'Section';\r\n\t}\r\n\r\n\t/**\r\n\t * Returns a grouped view for rendering: groups in order, then ungrouped.\r\n\t * Each entry has the group name (null = ungrouped) and rules with their flat indices.\r\n\t */\r\n\tget #groupedView(): Array<{ group: string | null; rules: Array<{ rule: EditableRule; flatIndex: number }> }> {\r\n\t\tconst result: Array<{ group: string | null; rules: Array<{ rule: EditableRule; flatIndex: number }> }> = [];\r\n\r\n\t\t// Groups in order\r\n\t\tfor (const name of this._groupOrder) {\r\n\t\t\tconst groupRules: Array<{ rule: EditableRule; flatIndex: number }> = [];\r\n\t\t\tthis._rules.forEach((r, i) => {\r\n\t\t\t\tif (r._groupName === name) groupRules.push({ rule: r, flatIndex: i });\r\n\t\t\t});\r\n\t\t\tresult.push({ group: name, rules: groupRules });\r\n\t\t}\r\n\r\n\t\t// Ungrouped\r\n\t\tconst ungrouped: Array<{ rule: EditableRule; flatIndex: number }> = [];\r\n\t\tthis._rules.forEach((r, i) => {\r\n\t\t\tif (r._groupName === null) ungrouped.push({ rule: r, flatIndex: i });\r\n\t\t});\r\n\t\tresult.push({ group: null, rules: ungrouped });\r\n\r\n\t\treturn result;\r\n\t}\r\n\r\n\t// ===== Rule evaluation (first-match-wins) =====\r\n\r\n\t/** Evaluate all rules against elements. Returns a map of elementId -> ruleIndex */\r\n\t#evaluateRules(): Map<string, number> {\r\n\t\tconst claimed = new Map<string, number>();\r\n\t\tconst elements = this.#elements;\r\n\r\n\t\tfor (let ruleIdx = 0; ruleIdx < this._rules.length; ruleIdx++) {\r\n\t\t\tconst rule = this._rules[ruleIdx];\r\n\t\t\tif (rule.conditions.length === 0) continue;\r\n\r\n\t\t\tfor (let elIdx = 0; elIdx < elements.length; elIdx++) {\r\n\t\t\t\tconst el = elements[elIdx];\r\n\t\t\t\tif (claimed.has(el.id)) continue; // already claimed by an earlier rule\r\n\r\n\t\t\t\tif (this.#elementMatchesAllConditions(el, rule.conditions, elIdx, elements.length)) {\r\n\t\t\t\t\t// Check exceptions — if any exception matches, skip this element for this rule\r\n\t\t\t\t\tif (rule.exceptions?.length) {\r\n\t\t\t\t\t\tconst anyExceptionMatches = rule.exceptions.some((exc) =>\r\n\t\t\t\t\t\t\tthis.#elementMatchesCondition(el, exc, elIdx, elements.length),\r\n\t\t\t\t\t\t);\r\n\t\t\t\t\t\tif (anyExceptionMatches) continue;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tclaimed.set(el.id, ruleIdx);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn claimed;\r\n\t}\r\n\r\n\t#elementMatchesAllConditions(el: AreaElement, conditions: RuleCondition[], index: number, total: number): boolean {\r\n\t\treturn conditions.every((c) => this.#elementMatchesCondition(el, c, index, total));\r\n\t}\r\n\r\n\t#elementMatchesCondition(el: AreaElement, condition: RuleCondition, index: number, total: number): boolean {\r\n\t\tconst val = String(condition.value ?? '');\r\n\t\tconst numVal = Number(condition.value);\r\n\r\n\t\tswitch (condition.type) {\r\n\t\t\tcase 'textBeginsWith':\r\n\t\t\t\treturn el.text.toLowerCase().startsWith(val.toLowerCase());\r\n\t\t\tcase 'textEndsWith':\r\n\t\t\t\treturn el.text.toLowerCase().endsWith(val.toLowerCase());\r\n\t\t\tcase 'textContains':\r\n\t\t\t\treturn el.text.toLowerCase().includes(val.toLowerCase());\r\n\t\t\tcase 'textMatchesPattern':\r\n\t\t\t\ttry { return new RegExp(val, 'i').test(el.text); } catch { return false; }\r\n\t\t\tcase 'fontSizeEquals':\r\n\t\t\t\treturn !isNaN(numVal) && Math.abs(el.fontSize - numVal) < 0.5;\r\n\t\t\tcase 'fontSizeAbove':\r\n\t\t\t\treturn !isNaN(numVal) && el.fontSize > numVal;\r\n\t\t\tcase 'fontSizeBelow':\r\n\t\t\t\treturn !isNaN(numVal) && el.fontSize < numVal;\r\n\t\t\tcase 'fontNameContains':\r\n\t\t\t\treturn el.fontName.toLowerCase().includes(val.toLowerCase());\r\n\t\t\tcase 'colorEquals':\r\n\t\t\t\treturn el.color.toLowerCase() === val.toLowerCase();\r\n\t\t\tcase 'positionFirst':\r\n\t\t\t\treturn index === 0;\r\n\t\t\tcase 'positionLast':\r\n\t\t\t\treturn index === total - 1;\r\n\t\t\tdefault:\r\n\t\t\t\treturn false;\r\n\t\t}\r\n\t}\r\n\r\n\t// ===== Auto-populate conditions from an element =====\r\n\r\n\t#autoPopulateConditions(el: AreaElement, elIndex: number, total: number): RuleCondition[] {\r\n\t\tconst conditions: RuleCondition[] = [];\r\n\r\n\t\t// Font size\r\n\t\tconditions.push({ type: 'fontSizeEquals', value: el.fontSize });\r\n\r\n\t\t// Font name\r\n\t\tif (el.fontName) {\r\n\t\t\tconditions.push({ type: 'fontNameContains', value: el.fontName });\r\n\t\t}\r\n\r\n\t\t// Color (skip black/very dark as it's the default)\r\n\t\tif (el.color && el.color.toLowerCase() !== '#000000' && el.color.toLowerCase() !== '#000') {\r\n\t\t\tconditions.push({ type: 'colorEquals', value: el.color });\r\n\t\t}\r\n\r\n\t\t// Text prefix — if text contains a colon, use \"begins with\" up to the colon\r\n\t\tconst colonIdx = el.text.indexOf(':');\r\n\t\tif (colonIdx > 0 && colonIdx < 30) {\r\n\t\t\tconditions.push({ type: 'textBeginsWith', value: el.text.substring(0, colonIdx + 1) });\r\n\t\t}\r\n\r\n\t\t// Position\r\n\t\tif (elIndex === 0) {\r\n\t\t\tconditions.push({ type: 'positionFirst' });\r\n\t\t} else if (elIndex === total - 1) {\r\n\t\t\tconditions.push({ type: 'positionLast' });\r\n\t\t}\r\n\r\n\t\treturn conditions;\r\n\t}\r\n\r\n\t// ===== Rule CRUD =====\r\n\r\n\t#addRule(groupName: string | null = null) {\r\n\t\tconst id = generateRuleId();\r\n\t\tthis._rules = [...this._rules, {\r\n\t\t\trole: '',\r\n\t\t\tpart: 'content' as RulePart,\r\n\t\t\tconditions: [],\r\n\t\t\tformats: [{ type: 'block' as FormatEntryType, value: 'auto' }],\r\n\t\t\t_id: id,\r\n\t\t\t_groupName: groupName,\r\n\t\t}];\r\n\t\t// Auto-expand new rules so user can fill in details\r\n\t\tthis.#expandRule(id);\r\n\t}\r\n\r\n\t#removeRule(ruleIdx: number) {\r\n\t\tthis._rules = this._rules.filter((_, i) => i !== ruleIdx);\r\n\t}\r\n\r\n\t#createRuleFromElement(el: AreaElement, elIndex: number) {\r\n\t\tconst conditions = this.#autoPopulateConditions(el, elIndex, this.#elements.length);\r\n\t\t// Derive a role name suggestion from text (kebab-case first few words)\r\n\t\tconst roleSuggestion = el.text\r\n\t\t\t.split(/[\\s:,]+/)\r\n\t\t\t.slice(0, 3)\r\n\t\t\t.join('-')\r\n\t\t\t.toLowerCase()\r\n\t\t\t.replace(/[^a-z0-9-]/g, '');\r\n\t\tconst id = generateRuleId();\r\n\t\tthis._rules = [...this._rules, {\r\n\t\t\trole: roleSuggestion,\r\n\t\t\tpart: 'content' as RulePart,\r\n\t\t\tconditions,\r\n\t\t\tformats: [{ type: 'block' as FormatEntryType, value: 'auto' }],\r\n\t\t\t_id: id,\r\n\t\t\t_groupName: null,\r\n\t\t}];\r\n\t\t// Auto-expand so user can review auto-populated conditions\r\n\t\tthis.#expandRule(id);\r\n\t}\r\n\r\n\t#updateRoleName(ruleIdx: number, value: string) {\r\n\t\tconst updated = [...this._rules];\r\n\t\tupdated[ruleIdx] = { ...updated[ruleIdx], role: value };\r\n\t\tthis._rules = updated;\r\n\t}\r\n\r\n\t#updatePart(ruleIdx: number, value: RulePart) {\r\n\t\tconst updated = [...this._rules];\r\n\t\tupdated[ruleIdx] = { ...updated[ruleIdx], part: value };\r\n\t\tthis._rules = updated;\r\n\t}\r\n\r\n\t#updateExclude(ruleIdx: number, value: boolean) {\r\n\t\tconst updated = [...this._rules];\r\n\t\tupdated[ruleIdx] = { ...updated[ruleIdx], exclude: value };\r\n\t\tthis._rules = updated;\r\n\t}\r\n\r\n\t// ===== Group CRUD =====\r\n\r\n\t#addGroup() {\r\n\t\tlet name = 'New Group';\r\n\t\tlet counter = 1;\r\n\t\twhile (this._groupOrder.includes(name)) {\r\n\t\t\tname = `New Group ${++counter}`;\r\n\t\t}\r\n\t\tthis._groupOrder = [...this._groupOrder, name];\r\n\t\t// Immediately enter rename mode\r\n\t\tthis._renamingGroup = name;\r\n\t\tthis._renameValue = name;\r\n\t}\r\n\r\n\t#startRenameGroup(name: string) {\r\n\t\tthis._renamingGroup = name;\r\n\t\tthis._renameValue = name;\r\n\t}\r\n\r\n\t#confirmRenameGroup() {\r\n\t\tif (!this._renamingGroup || !this._renameValue.trim()) return;\r\n\t\tconst oldName = this._renamingGroup;\r\n\t\tconst newName = this._renameValue.trim();\r\n\r\n\t\tif (oldName !== newName) {\r\n\t\t\t// Update group order\r\n\t\t\tthis._groupOrder = this._groupOrder.map((n) => n === oldName ? newName : n);\r\n\t\t\t// Update all rules in this group\r\n\t\t\tthis._rules = this._rules.map((r) =>\r\n\t\t\t\tr._groupName === oldName ? { ...r, _groupName: newName } : r,\r\n\t\t\t);\r\n\t\t}\r\n\t\tthis._renamingGroup = null;\r\n\t\tthis._renameValue = '';\r\n\t}\r\n\r\n\t#cancelRenameGroup() {\r\n\t\tthis._renamingGroup = null;\r\n\t\tthis._renameValue = '';\r\n\t}\r\n\r\n\t#deleteGroup(name: string) {\r\n\t\t// Move all rules from this group to ungrouped\r\n\t\tthis._rules = this._rules.map((r) =>\r\n\t\t\tr._groupName === name ? { ...r, _groupName: null } : r,\r\n\t\t);\r\n\t\tthis._groupOrder = this._groupOrder.filter((n) => n !== name);\r\n\t}\r\n\r\n\t#moveRuleToGroup(ruleIdx: number, groupName: string | null) {\r\n\t\tconst updated = [...this._rules];\r\n\t\tupdated[ruleIdx] = { ...updated[ruleIdx], _groupName: groupName };\r\n\t\tthis._rules = updated;\r\n\t}\r\n\r\n\t// ===== Format entry CRUD =====\r\n\r\n\t#addFormatEntry(ruleIdx: number) {\r\n\t\tconst updated = [...this._rules];\r\n\t\tconst rule = { ...updated[ruleIdx] };\r\n\t\trule.formats = [...(rule.formats ?? []), { type: 'block' as FormatEntryType, value: 'auto' }];\r\n\t\tupdated[ruleIdx] = rule;\r\n\t\tthis._rules = updated;\r\n\t}\r\n\r\n\t#removeFormatEntry(ruleIdx: number, fmtIdx: number) {\r\n\t\tconst updated = [...this._rules];\r\n\t\tconst rule = { ...updated[ruleIdx] };\r\n\t\trule.formats = (rule.formats ?? []).filter((_, i) => i !== fmtIdx);\r\n\t\tupdated[ruleIdx] = rule;\r\n\t\tthis._rules = updated;\r\n\t}\r\n\r\n\t#updateFormatEntryType(ruleIdx: number, fmtIdx: number, type: FormatEntryType) {\r\n\t\tconst updated = [...this._rules];\r\n\t\tconst rule = { ...updated[ruleIdx] };\r\n\t\trule.formats = [...(rule.formats ?? [])];\r\n\t\t// Reset value to first option when switching type\r\n\t\tconst defaultValue = type === 'block' ? 'auto' : 'bold';\r\n\t\trule.formats[fmtIdx] = { type, value: defaultValue };\r\n\t\tupdated[ruleIdx] = rule;\r\n\t\tthis._rules = updated;\r\n\t}\r\n\r\n\t#updateFormatEntryValue(ruleIdx: number, fmtIdx: number, value: string) {\r\n\t\tconst updated = [...this._rules];\r\n\t\tconst rule = { ...updated[ruleIdx] };\r\n\t\trule.formats = [...(rule.formats ?? [])];\r\n\t\trule.formats[fmtIdx] = { ...rule.formats[fmtIdx], value: value as FormatEntry['value'] };\r\n\t\tupdated[ruleIdx] = rule;\r\n\t\tthis._rules = updated;\r\n\t}\r\n\r\n\t#addCondition(ruleIdx: number) {\r\n\t\tconst updated = [...this._rules];\r\n\t\tconst rule = { ...updated[ruleIdx] };\r\n\t\trule.conditions = [...rule.conditions, { type: 'textBeginsWith', value: '' }];\r\n\t\tupdated[ruleIdx] = rule;\r\n\t\tthis._rules = updated;\r\n\t}\r\n\r\n\t#removeCondition(ruleIdx: number, condIdx: number) {\r\n\t\tconst updated = [...this._rules];\r\n\t\tconst rule = { ...updated[ruleIdx] };\r\n\t\trule.conditions = rule.conditions.filter((_, i) => i !== condIdx);\r\n\t\tupdated[ruleIdx] = rule;\r\n\t\tthis._rules = updated;\r\n\t}\r\n\r\n\t#updateConditionType(ruleIdx: number, condIdx: number, type: RuleConditionType) {\r\n\t\tconst updated = [...this._rules];\r\n\t\tconst rule = { ...updated[ruleIdx] };\r\n\t\trule.conditions = [...rule.conditions];\r\n\t\trule.conditions[condIdx] = {\r\n\t\t\ttype,\r\n\t\t\tvalue: VALUELESS_CONDITIONS.includes(type) ? undefined : rule.conditions[condIdx].value,\r\n\t\t};\r\n\t\tupdated[ruleIdx] = rule;\r\n\t\tthis._rules = updated;\r\n\t}\r\n\r\n\t#updateConditionValue(ruleIdx: number, condIdx: number, value: string) {\r\n\t\tconst updated = [...this._rules];\r\n\t\tconst rule = { ...updated[ruleIdx] };\r\n\t\trule.conditions = [...rule.conditions];\r\n\t\tconst cond = rule.conditions[condIdx];\r\n\t\t// Store as number for font size conditions\r\n\t\tconst isNumeric = cond.type === 'fontSizeEquals' || cond.type === 'fontSizeAbove' || cond.type === 'fontSizeBelow';\r\n\t\trule.conditions[condIdx] = { ...cond, value: isNumeric && !isNaN(Number(value)) ? Number(value) : value };\r\n\t\tupdated[ruleIdx] = rule;\r\n\t\tthis._rules = updated;\r\n\t}\r\n\r\n\t// ===== Exception CRUD =====\r\n\r\n\t#addException(ruleIdx: number) {\r\n\t\tconst updated = [...this._rules];\r\n\t\tconst rule = { ...updated[ruleIdx] };\r\n\t\trule.exceptions = [...(rule.exceptions ?? []), { type: 'textContains' as RuleConditionType, value: '' }];\r\n\t\tupdated[ruleIdx] = rule;\r\n\t\tthis._rules = updated;\r\n\t}\r\n\r\n\t#removeException(ruleIdx: number, excIdx: number) {\r\n\t\tconst updated = [...this._rules];\r\n\t\tconst rule = { ...updated[ruleIdx] };\r\n\t\trule.exceptions = (rule.exceptions ?? []).filter((_, i) => i !== excIdx);\r\n\t\tupdated[ruleIdx] = rule;\r\n\t\tthis._rules = updated;\r\n\t}\r\n\r\n\t#updateExceptionType(ruleIdx: number, excIdx: number, type: RuleConditionType) {\r\n\t\tconst updated = [...this._rules];\r\n\t\tconst rule = { ...updated[ruleIdx] };\r\n\t\trule.exceptions = [...(rule.exceptions ?? [])];\r\n\t\trule.exceptions[excIdx] = {\r\n\t\t\ttype,\r\n\t\t\tvalue: VALUELESS_CONDITIONS.includes(type) ? undefined : rule.exceptions[excIdx].value,\r\n\t\t};\r\n\t\tupdated[ruleIdx] = rule;\r\n\t\tthis._rules = updated;\r\n\t}\r\n\r\n\t#updateExceptionValue(ruleIdx: number, excIdx: number, value: string) {\r\n\t\tconst updated = [...this._rules];\r\n\t\tconst rule = { ...updated[ruleIdx] };\r\n\t\trule.exceptions = [...(rule.exceptions ?? [])];\r\n\t\tconst exc = rule.exceptions[excIdx];\r\n\t\tconst isNumeric = exc.type === 'fontSizeEquals' || exc.type === 'fontSizeAbove' || exc.type === 'fontSizeBelow';\r\n\t\trule.exceptions[excIdx] = { ...exc, value: isNumeric && !isNaN(Number(value)) ? Number(value) : value };\r\n\t\tupdated[ruleIdx] = rule;\r\n\t\tthis._rules = updated;\r\n\t}\r\n\r\n\t// ===== Submit =====\r\n\r\n\t/** Strip transient fields and sync format for C# compatibility. */\r\n\t#cleanRule(rule: EditableRule): SectionRule {\r\n\t\tconst blockEntry = (rule.formats ?? []).find((f) => f.type === 'block');\r\n\t\t// eslint-disable-next-line @typescript-eslint/no-unused-vars\r\n\t\tconst { _id, _groupName, action, ...clean } = rule;\r\n\t\treturn {\r\n\t\t\t...clean,\r\n\t\t\tformat: (blockEntry?.value ?? 'auto') as BlockFormat,\r\n\t\t};\r\n\t}\r\n\r\n\t#buildRulesValue(): AreaRules {\r\n\t\t// Auto-confirm any pending group rename before building value\r\n\t\tif (this._renamingGroup) {\r\n\t\t\tthis.#confirmRenameGroup();\r\n\t\t}\r\n\r\n\t\tconst groups: RuleGroup[] = [];\r\n\t\tfor (const name of this._groupOrder) {\r\n\t\t\tconst groupRules = this._rules\r\n\t\t\t\t.filter((r) => r._groupName === name)\r\n\t\t\t\t.map((r) => this.#cleanRule(r));\r\n\t\t\tgroups.push({ name, rules: groupRules });\r\n\t\t}\r\n\t\tconst ungroupedRules = this._rules\r\n\t\t\t.filter((r) => r._groupName === null)\r\n\t\t\t.map((r) => this.#cleanRule(r));\r\n\r\n\t\treturn { groups, rules: ungroupedRules };\r\n\t}\r\n\r\n\tasync #onSave() {\r\n\t\tconst rules = this.#buildRulesValue();\r\n\t\tif (this.data?.onSave) {\r\n\t\t\tawait this.data.onSave(rules);\r\n\t\t}\r\n\t}\r\n\r\n\t#onSaveAndClose() {\r\n\t\tconst rules = this.#buildRulesValue();\r\n\t\tthis.value = { rules };\r\n\t\tthis.modalContext?.submit();\r\n\t}\r\n\r\n\t#onClose() {\r\n\t\tthis.modalContext?.reject();\r\n\t}\r\n\r\n\t// ===== Rendering =====\r\n\r\n\t#renderConditionRow(ruleIdx: number, condIdx: number, condition: RuleCondition) {\r\n\t\tconst isValueless = VALUELESS_CONDITIONS.includes(condition.type);\r\n\t\treturn html`\r\n\t\t\t<div class=\"condition-row\">\r\n\t\t\t\t<select\r\n\t\t\t\t\tclass=\"condition-type-select\"\r\n\t\t\t\t\t.value=${condition.type}\r\n\t\t\t\t\t@change=${(e: Event) => this.#updateConditionType(ruleIdx, condIdx, (e.target as HTMLSelectElement).value as RuleConditionType)}>\r\n\t\t\t\t\t${ALL_CONDITION_TYPES.map((t) => html`\r\n\t\t\t\t\t\t<option value=${t} ?selected=${t === condition.type}>${CONDITION_LABELS[t]}</option>\r\n\t\t\t\t\t`)}\r\n\t\t\t\t</select>\r\n\t\t\t\t${isValueless ? nothing : html`\r\n\t\t\t\t\t<input\r\n\t\t\t\t\t\ttype=\"text\"\r\n\t\t\t\t\t\tclass=\"condition-value-input\"\r\n\t\t\t\t\t\tplaceholder=\"Value...\"\r\n\t\t\t\t\t\t.value=${String(condition.value ?? '')}\r\n\t\t\t\t\t\t@input=${(e: Event) => this.#updateConditionValue(ruleIdx, condIdx, (e.target as HTMLInputElement).value)} />\r\n\t\t\t\t`}\r\n\t\t\t\t<uui-button\r\n\t\t\t\t\tcompact\r\n\t\t\t\t\tlook=\"secondary\"\r\n\t\t\t\t\tlabel=\"Remove condition\"\r\n\t\t\t\t\t@click=${() => this.#removeCondition(ruleIdx, condIdx)}>\r\n\t\t\t\t\t<uui-icon name=\"icon-trash\"></uui-icon>\r\n\t\t\t\t</uui-button>\r\n\t\t\t</div>\r\n\t\t`;\r\n\t}\r\n\r\n\t#renderExceptionRow(ruleIdx: number, excIdx: number, exception: RuleCondition) {\r\n\t\tconst isValueless = VALUELESS_CONDITIONS.includes(exception.type);\r\n\t\treturn html`\r\n\t\t\t<div class=\"condition-row\">\r\n\t\t\t\t<select\r\n\t\t\t\t\tclass=\"condition-type-select\"\r\n\t\t\t\t\t.value=${exception.type}\r\n\t\t\t\t\t@change=${(e: Event) => this.#updateExceptionType(ruleIdx, excIdx, (e.target as HTMLSelectElement).value as RuleConditionType)}>\r\n\t\t\t\t\t${ALL_CONDITION_TYPES.map((t) => html`\r\n\t\t\t\t\t\t<option value=${t} ?selected=${t === exception.type}>${CONDITION_LABELS[t]}</option>\r\n\t\t\t\t\t`)}\r\n\t\t\t\t</select>\r\n\t\t\t\t${isValueless ? nothing : html`\r\n\t\t\t\t\t<input\r\n\t\t\t\t\t\ttype=\"text\"\r\n\t\t\t\t\t\tclass=\"condition-value-input\"\r\n\t\t\t\t\t\tplaceholder=\"Value...\"\r\n\t\t\t\t\t\t.value=${String(exception.value ?? '')}\r\n\t\t\t\t\t\t@input=${(e: Event) => this.#updateExceptionValue(ruleIdx, excIdx, (e.target as HTMLInputElement).value)} />\r\n\t\t\t\t`}\r\n\t\t\t\t<uui-button\r\n\t\t\t\t\tcompact\r\n\t\t\t\t\tlook=\"secondary\"\r\n\t\t\t\t\tlabel=\"Remove exception\"\r\n\t\t\t\t\t@click=${() => this.#removeException(ruleIdx, excIdx)}>\r\n\t\t\t\t\t<uui-icon name=\"icon-trash\"></uui-icon>\r\n\t\t\t\t</uui-button>\r\n\t\t\t</div>\r\n\t\t`;\r\n\t}\r\n\r\n\t#renderFormatRow(ruleIdx: number, fmtIdx: number, entry: FormatEntry) {\r\n\t\tconst valueOptions = entry.type === 'block' ? ALL_BLOCK_FORMATS : ALL_STYLE_FORMATS;\r\n\t\tconst valueLabels = entry.type === 'block' ? BLOCK_FORMAT_LABELS : STYLE_FORMAT_LABELS;\r\n\r\n\t\treturn html`\r\n\t\t\t<div class=\"condition-row\">\r\n\t\t\t\t<select\r\n\t\t\t\t\tclass=\"format-type-select\"\r\n\t\t\t\t\t.value=${entry.type}\r\n\t\t\t\t\t@change=${(e: Event) => this.#updateFormatEntryType(ruleIdx, fmtIdx, (e.target as HTMLSelectElement).value as FormatEntryType)}>\r\n\t\t\t\t\t${ALL_FORMAT_ENTRY_TYPES.map((t) => html`\r\n\t\t\t\t\t\t<option value=${t} ?selected=${t === entry.type}>${FORMAT_ENTRY_TYPE_LABELS[t]}</option>\r\n\t\t\t\t\t`)}\r\n\t\t\t\t</select>\r\n\t\t\t\t<select\r\n\t\t\t\t\tclass=\"format-value-select\"\r\n\t\t\t\t\t.value=${entry.value}\r\n\t\t\t\t\t@change=${(e: Event) => this.#updateFormatEntryValue(ruleIdx, fmtIdx, (e.target as HTMLSelectElement).value)}>\r\n\t\t\t\t\t${valueOptions.map((v) => html`\r\n\t\t\t\t\t\t<option value=${v} ?selected=${v === entry.value}>${valueLabels[v]}</option>\r\n\t\t\t\t\t`)}\r\n\t\t\t\t</select>\r\n\t\t\t\t<uui-button\r\n\t\t\t\t\tcompact\r\n\t\t\t\t\tlook=\"secondary\"\r\n\t\t\t\t\tlabel=\"Remove format\"\r\n\t\t\t\t\t@click=${() => this.#removeFormatEntry(ruleIdx, fmtIdx)}>\r\n\t\t\t\t\t<uui-icon name=\"icon-trash\"></uui-icon>\r\n\t\t\t\t</uui-button>\r\n\t\t\t</div>\r\n\t\t`;\r\n\t}\r\n\r\n\t#renderRuleCard(rule: EditableRule, flatIdx: number, matchedElements: AreaElement[]) {\r\n\t\tconst isExpanded = this.#isRuleExpanded(rule._id);\r\n\r\n\t\tif (!isExpanded) {\r\n\t\t\treturn this.#renderCollapsedRule(rule, flatIdx, matchedElements);\r\n\t\t}\r\n\r\n\t\treturn this.#renderExpandedRule(rule, flatIdx, matchedElements);\r\n\t}\r\n\r\n\t#renderCollapsedRule(rule: EditableRule, flatIdx: number, matchedElements: AreaElement[]) {\r\n\t\tconst isExcluded = rule.exclude;\r\n\t\tconst currentPart = rule.part ?? 'content';\r\n\t\tconst partLabel = isExcluded ? 'Exclude' : PART_LABELS[currentPart] ?? currentPart;\r\n\t\tconst matchCount = matchedElements.length;\r\n\t\tconst roleName = rule.role || '(unnamed rule)';\r\n\r\n\t\treturn html`\r\n\t\t\t<div class=\"rule-row\" @click=${() => this.#toggleRuleExpanded(rule._id)}>\r\n\t\t\t\t<span class=\"rule-grip\" title=\"Drag to reorder\" @click=${(e: Event) => e.stopPropagation()}>⠿</span>\r\n\t\t\t\t<uui-icon class=\"rule-row-chevron\" name=\"icon-navigation-right\"></uui-icon>\r\n\t\t\t\t<span class=\"rule-row-name\">${roleName}</span>\r\n\t\t\t\t<span class=\"rule-row-part ${isExcluded ? 'excluded' : ''}\">${partLabel}</span>\r\n\t\t\t\t${matchCount > 0\r\n\t\t\t\t\t? html`<span class=\"rule-row-match ${isExcluded ? 'excluded' : 'matched'}\">${matchCount}&times;</span>`\r\n\t\t\t\t\t: html`<span class=\"rule-row-match no-match\">0</span>`}\r\n\t\t\t\t<uui-action-bar class=\"rule-row-actions\"\r\n\t\t\t\t\t@click=${(e: Event) => e.stopPropagation()}>\r\n\t\t\t\t\t<uui-button pristine look=\"primary\" label=\"Edit rule\"\r\n\t\t\t\t\t\t@click=${() => this.#toggleRuleExpanded(rule._id)}>\r\n\t\t\t\t\t\t<uui-icon name=\"icon-edit\"></uui-icon>\r\n\t\t\t\t\t</uui-button>\r\n\t\t\t\t\t<uui-button pristine look=\"primary\" label=\"Delete rule\"\r\n\t\t\t\t\t\t@click=${() => this.#removeRule(flatIdx)}>\r\n\t\t\t\t\t\t<uui-icon name=\"icon-trash\"></uui-icon>\r\n\t\t\t\t\t</uui-button>\r\n\t\t\t\t</uui-action-bar>\r\n\t\t\t</div>\r\n\t\t`;\r\n\t}\r\n\r\n\t#renderExpandedRule(rule: EditableRule, flatIdx: number, matchedElements: AreaElement[]) {\r\n\t\tconst isExcluded = rule.exclude;\r\n\t\tconst currentPart = rule.part ?? 'content';\r\n\r\n\t\t// Build group move options\r\n\t\tconst moveOptions: Array<{ label: string; value: string | null }> = [\r\n\t\t\t{ label: 'Ungrouped', value: null },\r\n\t\t\t...this._groupOrder.map((name) => ({ label: name, value: name })),\r\n\t\t];\r\n\r\n\t\treturn html`\r\n\t\t\t<div class=\"rule-card\">\r\n\t\t\t\t<div class=\"rule-header\">\r\n\t\t\t\t\t<span class=\"rule-grip disabled\" title=\"Collapse to drag\">⠿</span>\r\n\t\t\t\t\t<uui-icon class=\"rule-row-chevron expanded\" name=\"icon-navigation-down\"\r\n\t\t\t\t\t\t@click=${() => this.#toggleRuleExpanded(rule._id)}\r\n\t\t\t\t\t\tstyle=\"cursor:pointer\"></uui-icon>\r\n\t\t\t\t\t<input\r\n\t\t\t\t\t\ttype=\"text\"\r\n\t\t\t\t\t\tclass=\"role-name-input\"\r\n\t\t\t\t\t\tplaceholder=\"Section name (e.g. tour-title)\"\r\n\t\t\t\t\t\t.value=${rule.role}\r\n\t\t\t\t\t\t@input=${(e: Event) => this.#updateRoleName(flatIdx, (e.target as HTMLInputElement).value)} />\r\n\t\t\t\t\t<uui-button\r\n\t\t\t\t\t\tcompact\r\n\t\t\t\t\t\tlook=\"secondary\"\r\n\t\t\t\t\t\tcolor=\"danger\"\r\n\t\t\t\t\t\tlabel=\"Remove rule\"\r\n\t\t\t\t\t\t@click=${() => this.#removeRule(flatIdx)}>\r\n\t\t\t\t\t\t<uui-icon name=\"icon-trash\"></uui-icon>\r\n\t\t\t\t\t</uui-button>\r\n\t\t\t\t</div>\r\n\r\n\t\t\t\t<div class=\"conditions-area\">\r\n\t\t\t\t\t<div class=\"section-header collapsible\" @click=${() => this.#toggleCollapsed('conditions', flatIdx)}>\r\n\t\t\t\t\t\t<uui-icon name=${this.#isCollapsed('conditions', flatIdx) ? 'icon-navigation-right' : 'icon-navigation-down'}></uui-icon>\r\n\t\t\t\t\t\tConditions${rule.conditions.length > 0 ? ` (${rule.conditions.length})` : ''}\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t${this.#isCollapsed('conditions', flatIdx) ? nothing : html`\r\n\t\t\t\t\t\t${rule.conditions.map((cond, cIdx) => this.#renderConditionRow(flatIdx, cIdx, cond))}\r\n\t\t\t\t\t\t<uui-button\r\n\t\t\t\t\t\t\tcompact\r\n\t\t\t\t\t\t\tlook=\"placeholder\"\r\n\t\t\t\t\t\t\tlabel=\"Add condition\"\r\n\t\t\t\t\t\t\t@click=${() => this.#addCondition(flatIdx)}>\r\n\t\t\t\t\t\t\t+ Add condition\r\n\t\t\t\t\t\t</uui-button>\r\n\t\t\t\t\t`}\r\n\t\t\t\t</div>\r\n\r\n\t\t\t\t<div class=\"exceptions-area\">\r\n\t\t\t\t\t<div class=\"section-header collapsible\" @click=${() => this.#toggleCollapsed('exceptions', flatIdx)}>\r\n\t\t\t\t\t\t<uui-icon name=${this.#isCollapsed('exceptions', flatIdx) ? 'icon-navigation-right' : 'icon-navigation-down'}></uui-icon>\r\n\t\t\t\t\t\tExceptions${(rule.exceptions ?? []).length > 0 ? ` (${(rule.exceptions ?? []).length})` : ''}\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t${this.#isCollapsed('exceptions', flatIdx) ? nothing : html`\r\n\t\t\t\t\t\t${(rule.exceptions ?? []).map((exc, eIdx) => this.#renderExceptionRow(flatIdx, eIdx, exc))}\r\n\t\t\t\t\t\t<uui-button\r\n\t\t\t\t\t\t\tcompact\r\n\t\t\t\t\t\t\tlook=\"placeholder\"\r\n\t\t\t\t\t\t\tlabel=\"Add exception\"\r\n\t\t\t\t\t\t\t@click=${() => this.#addException(flatIdx)}>\r\n\t\t\t\t\t\t\t+ Add exception\r\n\t\t\t\t\t\t</uui-button>\r\n\t\t\t\t\t`}\r\n\t\t\t\t</div>\r\n\r\n\t\t\t\t<div class=\"part-area\">\r\n\t\t\t\t\t<div class=\"section-header collapsible\" @click=${() => this.#toggleCollapsed('part', flatIdx)}>\r\n\t\t\t\t\t\t<uui-icon name=${this.#isCollapsed('part', flatIdx) ? 'icon-navigation-right' : 'icon-navigation-down'}></uui-icon>\r\n\t\t\t\t\t\tPart\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t${this.#isCollapsed('part', flatIdx) ? nothing : html`\r\n\t\t\t\t\t\t<div class=\"part-controls\">\r\n\t\t\t\t\t\t\t<select\r\n\t\t\t\t\t\t\t\tclass=\"part-select\"\r\n\t\t\t\t\t\t\t\t.value=${currentPart}\r\n\t\t\t\t\t\t\t\t?disabled=${isExcluded}\r\n\t\t\t\t\t\t\t\t@change=${(e: Event) => this.#updatePart(flatIdx, (e.target as HTMLSelectElement).value as RulePart)}>\r\n\t\t\t\t\t\t\t\t${ALL_PARTS.map((p) => html`\r\n\t\t\t\t\t\t\t\t\t<option value=${p} ?selected=${p === currentPart}>${PART_LABELS[p]}</option>\r\n\t\t\t\t\t\t\t\t`)}\r\n\t\t\t\t\t\t\t</select>\r\n\t\t\t\t\t\t\t<label class=\"exclude-label\">\r\n\t\t\t\t\t\t\t\t<input\r\n\t\t\t\t\t\t\t\t\ttype=\"checkbox\"\r\n\t\t\t\t\t\t\t\t\t.checked=${isExcluded}\r\n\t\t\t\t\t\t\t\t\t@change=${(e: Event) => this.#updateExclude(flatIdx, (e.target as HTMLInputElement).checked)} />\r\n\t\t\t\t\t\t\t\tExclude\r\n\t\t\t\t\t\t\t</label>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t${moveOptions.length > 1 ? html`\r\n\t\t\t\t\t\t\t<div class=\"move-to-group\">\r\n\t\t\t\t\t\t\t\t<span class=\"move-label\">Group:</span>\r\n\t\t\t\t\t\t\t\t<select\r\n\t\t\t\t\t\t\t\t\tclass=\"group-select\"\r\n\t\t\t\t\t\t\t\t\t.value=${rule._groupName ?? ''}\r\n\t\t\t\t\t\t\t\t\t@change=${(e: Event) => {\r\n\t\t\t\t\t\t\t\t\t\tconst val = (e.target as HTMLSelectElement).value;\r\n\t\t\t\t\t\t\t\t\t\tthis.#moveRuleToGroup(flatIdx, val || null);\r\n\t\t\t\t\t\t\t\t\t}}>\r\n\t\t\t\t\t\t\t\t\t${moveOptions.map((opt) => html`\r\n\t\t\t\t\t\t\t\t\t\t<option value=${opt.value ?? ''} ?selected=${(opt.value ?? '') === (rule._groupName ?? '')}>${opt.label}</option>\r\n\t\t\t\t\t\t\t\t\t`)}\r\n\t\t\t\t\t\t\t\t</select>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t` : nothing}\r\n\t\t\t\t\t`}\r\n\t\t\t\t</div>\r\n\r\n\t\t\t\t${!isExcluded ? html`\r\n\t\t\t\t<div class=\"format-area\">\r\n\t\t\t\t\t<div class=\"section-header collapsible\" @click=${() => this.#toggleCollapsed('format', flatIdx)}>\r\n\t\t\t\t\t\t<uui-icon name=${this.#isCollapsed('format', flatIdx) ? 'icon-navigation-right' : 'icon-navigation-down'}></uui-icon>\r\n\t\t\t\t\t\tFormat${(rule.formats ?? []).length > 0 ? ` (${(rule.formats ?? []).length})` : ''}\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t${this.#isCollapsed('format', flatIdx) ? nothing : html`\r\n\t\t\t\t\t\t${(rule.formats ?? []).map((fmt, fIdx) => this.#renderFormatRow(flatIdx, fIdx, fmt))}\r\n\t\t\t\t\t\t<uui-button\r\n\t\t\t\t\t\t\tcompact\r\n\t\t\t\t\t\t\tlook=\"placeholder\"\r\n\t\t\t\t\t\t\tlabel=\"Add format\"\r\n\t\t\t\t\t\t\t@click=${() => this.#addFormatEntry(flatIdx)}>\r\n\t\t\t\t\t\t\t+ Add format\r\n\t\t\t\t\t\t</uui-button>\r\n\t\t\t\t\t`}\r\n\t\t\t\t</div>\r\n\t\t\t\t` : nothing}\r\n\r\n\t\t\t\t<div class=\"match-preview ${matchedElements.length > 0 ? (isExcluded ? 'excluded' : 'matched') : 'no-match'}\">\r\n\t\t\t\t\t${matchedElements.length > 0\r\n\t\t\t\t\t\t? html`<uui-icon name=${isExcluded ? 'icon-block' : 'icon-check'}></uui-icon> ${isExcluded ? 'Excluded' : 'Matched'} <strong>${matchedElements.length}&times;</strong>${matchedElements.length <= 5 ? html`: ${matchedElements.map((el, i) => html`${i > 0 ? html`, ` : nothing}<strong>${this.#truncate(el.text, 40)}</strong>`)}` : nothing}`\r\n\t\t\t\t\t\t: html`<uui-icon name=\"icon-alert\"></uui-icon> ${rule.conditions.length === 0 ? 'Add conditions to match elements' : 'No match'}`}\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t`;\r\n\t}\r\n\r\n\t#truncate(text: string, max: number): string {\r\n\t\treturn text.length > max ? text.substring(0, max) + '...' : text;\r\n\t}\r\n\r\n\t#renderGroupHeader(name: string) {\r\n\t\tif (this._renamingGroup === name) {\r\n\t\t\treturn html`\r\n\t\t\t\t<div class=\"group-header\">\r\n\t\t\t\t\t<input\r\n\t\t\t\t\t\ttype=\"text\"\r\n\t\t\t\t\t\tclass=\"group-rename-input\"\r\n\t\t\t\t\t\t.value=${this._renameValue}\r\n\t\t\t\t\t\t@input=${(e: Event) => { this._renameValue = (e.target as HTMLInputElement).value; }}\r\n\t\t\t\t\t\t@keydown=${(e: KeyboardEvent) => {\r\n\t\t\t\t\t\t\tif (e.key === 'Enter') this.#confirmRenameGroup();\r\n\t\t\t\t\t\t\tif (e.key === 'Escape') this.#cancelRenameGroup();\r\n\t\t\t\t\t\t}} />\r\n\t\t\t\t\t<uui-button compact look=\"primary\" label=\"Confirm\" @click=${() => this.#confirmRenameGroup()}>\r\n\t\t\t\t\t\t<uui-icon name=\"icon-check\"></uui-icon>\r\n\t\t\t\t\t</uui-button>\r\n\t\t\t\t\t<uui-button compact look=\"secondary\" label=\"Cancel\" @click=${() => this.#cancelRenameGroup()}>\r\n\t\t\t\t\t\t<uui-icon name=\"icon-wrong\"></uui-icon>\r\n\t\t\t\t\t</uui-button>\r\n\t\t\t\t</div>\r\n\t\t\t`;\r\n\t\t}\r\n\r\n\t\treturn html`\r\n\t\t\t<div class=\"group-header\">\r\n\t\t\t\t<strong class=\"group-name\">${name}</strong>\r\n\t\t\t\t<span class=\"header-spacer\"></span>\r\n\t\t\t\t<uui-action-bar class=\"group-header-actions\">\r\n\t\t\t\t\t<uui-button pristine look=\"primary\" label=\"Rename\" @click=${() => this.#startRenameGroup(name)}>\r\n\t\t\t\t\t\t<uui-icon name=\"icon-edit\"></uui-icon>\r\n\t\t\t\t\t</uui-button>\r\n\t\t\t\t\t<uui-button pristine look=\"primary\" label=\"Delete group\"\r\n\t\t\t\t\t\ttitle=\"Delete group (rules move to ungrouped)\"\r\n\t\t\t\t\t\t@click=${() => this.#deleteGroup(name)}>\r\n\t\t\t\t\t\t<uui-icon name=\"icon-trash\"></uui-icon>\r\n\t\t\t\t\t</uui-button>\r\n\t\t\t\t</uui-action-bar>\r\n\t\t\t</div>\r\n\t\t`;\r\n\t}\r\n\r\n\t#renderUnmatchedElements(claimed: Map<string, number>) {\r\n\t\tconst elements = this.#elements;\r\n\t\tconst unmatched = elements.filter((el) => !claimed.has(el.id));\r\n\t\tif (unmatched.length === 0) return nothing;\r\n\r\n\t\treturn html`\r\n\t\t\t<div class=\"unmatched-section\">\r\n\t\t\t\t<h4>Unmatched elements (${unmatched.length})</h4>\r\n\t\t\t\t${unmatched.map((el) => {\r\n\t\t\t\t\tconst elIndex = elements.indexOf(el);\r\n\t\t\t\t\treturn html`\r\n\t\t\t\t\t\t<div class=\"unmatched-element\">\r\n\t\t\t\t\t\t\t<div class=\"unmatched-text\">${this.#truncate(el.text, 80)}</div>\r\n\t\t\t\t\t\t\t<div class=\"unmatched-meta\">\r\n\t\t\t\t\t\t\t\t<span class=\"meta-badge\">${el.fontSize}pt</span>\r\n\t\t\t\t\t\t\t\t<span class=\"meta-badge\">${el.fontName}</span>\r\n\t\t\t\t\t\t\t\t${el.color !== '#000000' ? html`<span class=\"meta-badge\" style=\"border-left: 3px solid ${el.color};\">${el.color}</span>` : nothing}\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t<uui-button\r\n\t\t\t\t\t\t\t\tcompact\r\n\t\t\t\t\t\t\t\tlook=\"outline\"\r\n\t\t\t\t\t\t\t\tlabel=\"Define rule from this\"\r\n\t\t\t\t\t\t\t\t@click=${() => this.#createRuleFromElement(el, elIndex)}>\r\n\t\t\t\t\t\t\t\tDefine rule\r\n\t\t\t\t\t\t\t</uui-button>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t`;\r\n\t\t\t\t})}\r\n\t\t\t</div>\r\n\t\t`;\r\n\t}\r\n\r\n\toverride render() {\r\n\t\tconst claimed = this.#evaluateRules();\r\n\r\n\t\t// Build ruleIdx -> all matched elements lookup\r\n\t\tconst ruleMatches = new Map<number, AreaElement[]>();\r\n\t\tfor (const [elId, ruleIdx] of claimed) {\r\n\t\t\tconst el = this.#elements.find((e) => e.id === elId);\r\n\t\t\tif (el) {\r\n\t\t\t\tconst existing = ruleMatches.get(ruleIdx) ?? [];\r\n\t\t\t\texisting.push(el);\r\n\t\t\t\truleMatches.set(ruleIdx, existing);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tconst groupedView = this.#groupedView;\r\n\r\n\t\treturn html`\r\n\t\t\t<umb-body-layout headline=\"Edit Sections: ${this.#sectionHeading}\">\r\n\t\t\t\t<div id=\"main\">\r\n\t\t\t\t\t<div class=\"section-info\">\r\n\t\t\t\t\t\t<span class=\"meta-badge\">${this.#elements.length} elements</span>\r\n\t\t\t\t\t\t<span class=\"meta-badge\">${this._rules.length} rules</span>\r\n\t\t\t\t\t\t<span class=\"meta-badge\">${claimed.size} matched</span>\r\n\t\t\t\t\t\t<span class=\"meta-badge\">${this.#elements.length - claimed.size} unmatched</span>\r\n\t\t\t\t\t\t${this._groupOrder.length > 0\r\n\t\t\t\t\t\t\t? html`<span class=\"meta-badge\">${this._groupOrder.length} group${this._groupOrder.length !== 1 ? 's' : ''}</span>`\r\n\t\t\t\t\t\t\t: nothing}\r\n\t\t\t\t\t</div>\r\n\r\n\t\t\t\t\t${groupedView.map((entry) => {\r\n\t\t\t\t\t\tif (entry.group !== null) {\r\n\t\t\t\t\t\t\t// Render a named group\r\n\t\t\t\t\t\t\treturn html`\r\n\t\t\t\t\t\t\t\t<div class=\"group-container\">\r\n\t\t\t\t\t\t\t\t\t${this.#renderGroupHeader(entry.group)}\r\n\t\t\t\t\t\t\t\t\t<div class=\"group-rules\">\r\n\t\t\t\t\t\t\t\t\t\t${entry.rules.map(({ rule, flatIndex }) =>\r\n\t\t\t\t\t\t\t\t\t\t\tthis.#renderRuleCard(rule, flatIndex, ruleMatches.get(flatIndex) ?? []),\r\n\t\t\t\t\t\t\t\t\t\t)}\r\n\t\t\t\t\t\t\t\t\t\t<uui-button\r\n\t\t\t\t\t\t\t\t\t\t\tlook=\"placeholder\"\r\n\t\t\t\t\t\t\t\t\t\t\tlabel=\"Add rule to ${entry.group}\"\r\n\t\t\t\t\t\t\t\t\t\t\t@click=${() => this.#addRule(entry.group)}>\r\n\t\t\t\t\t\t\t\t\t\t\t+ Add rule\r\n\t\t\t\t\t\t\t\t\t\t</uui-button>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t`;\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t// Render ungrouped rules\r\n\t\t\t\t\t\treturn html`\r\n\t\t\t\t\t\t\t${this._groupOrder.length > 0 ? html`\r\n\t\t\t\t\t\t\t\t<div class=\"ungrouped-label\">Ungrouped</div>\r\n\t\t\t\t\t\t\t` : nothing}\r\n\t\t\t\t\t\t\t${entry.rules.map(({ rule, flatIndex }) =>\r\n\t\t\t\t\t\t\t\tthis.#renderRuleCard(rule, flatIndex, ruleMatches.get(flatIndex) ?? []),\r\n\t\t\t\t\t\t\t)}\r\n\t\t\t\t\t\t\t<uui-button\r\n\t\t\t\t\t\t\t\tlook=\"placeholder\"\r\n\t\t\t\t\t\t\t\tlabel=\"Add rule\"\r\n\t\t\t\t\t\t\t\t@click=${() => this.#addRule(null)}>\r\n\t\t\t\t\t\t\t\t+ Add rule\r\n\t\t\t\t\t\t\t</uui-button>\r\n\t\t\t\t\t\t`;\r\n\t\t\t\t\t})}\r\n\r\n\t\t\t\t\t<uui-button\r\n\t\t\t\t\t\tlook=\"outline\"\r\n\t\t\t\t\t\tlabel=\"Add group\"\r\n\t\t\t\t\t\t@click=${() => this.#addGroup()}>\r\n\t\t\t\t\t\t<uui-icon name=\"icon-add\"></uui-icon>\r\n\t\t\t\t\t\tAdd group\r\n\t\t\t\t\t</uui-button>\r\n\r\n\t\t\t\t\t${this.#renderUnmatchedElements(claimed)}\r\n\t\t\t\t</div>\r\n\r\n\t\t\t\t<div slot=\"actions\">\r\n\t\t\t\t\t<uui-button label=\"Close\" @click=${this.#onClose}>Close</uui-button>\r\n\t\t\t\t\t<uui-button\r\n\t\t\t\t\t\tlabel=\"Save\"\r\n\t\t\t\t\t\tlook=\"secondary\"\r\n\t\t\t\t\t\t@click=${this.#onSave}>\r\n\t\t\t\t\t\tSave\r\n\t\t\t\t\t</uui-button>\r\n\t\t\t\t\t<uui-button\r\n\t\t\t\t\t\tlabel=\"Save and Close\"\r\n\t\t\t\t\t\tlook=\"primary\"\r\n\t\t\t\t\t\tcolor=\"positive\"\r\n\t\t\t\t\t\t@click=${this.#onSaveAndClose}>\r\n\t\t\t\t\t\tSave and Close\r\n\t\t\t\t\t</uui-button>\r\n\t\t\t\t</div>\r\n\t\t\t</umb-body-layout>\r\n\t\t`;\r\n\t}\r\n\r\n\tstatic override styles = [\r\n\t\tUmbTextStyles,\r\n\t\tcss`\r\n\t\t\t:host {\r\n\t\t\t\tdisplay: block;\r\n\t\t\t\theight: 100%;\r\n\t\t\t}\r\n\r\n\t\t\t#main {\r\n\t\t\t\tpadding: var(--uui-size-space-4);\r\n\t\t\t\tdisplay: flex;\r\n\t\t\t\tflex-direction: column;\r\n\t\t\t\tgap: var(--uui-size-space-4);\r\n\t\t\t}\r\n\r\n\t\t\t.section-info {\r\n\t\t\t\tdisplay: flex;\r\n\t\t\t\tgap: var(--uui-size-space-2);\r\n\t\t\t\tflex-wrap: wrap;\r\n\t\t\t}\r\n\r\n\t\t\t.meta-badge {\r\n\t\t\t\tfont-size: 11px;\r\n\t\t\t\tfont-family: monospace;\r\n\t\t\t\tpadding: 1px 6px;\r\n\t\t\t\tborder-radius: var(--uui-border-radius);\r\n\t\t\t\tbackground: var(--uui-color-surface-alt);\r\n\t\t\t\tcolor: var(--uui-color-text-alt);\r\n\t\t\t}\r\n\r\n\t\t\t/* Group containers */\r\n\t\t\t.group-container {\r\n\t\t\t\tborder: 2px solid var(--uui-color-border);\r\n\t\t\t\tborder-radius: var(--uui-border-radius);\r\n\t\t\t\toverflow: hidden;\r\n\t\t\t}\r\n\r\n\t\t\t.group-header {\r\n\t\t\t\tdisplay: flex;\r\n\t\t\t\talign-items: center;\r\n\t\t\t\tgap: var(--uui-size-space-2);\r\n\t\t\t\tpadding: var(--uui-size-space-3) var(--uui-size-space-4);\r\n\t\t\t\tbackground: var(--uui-color-surface-alt);\r\n\t\t\t\tborder-bottom: 1px solid var(--uui-color-border);\r\n\t\t\t}\r\n\r\n\t\t\t.group-name {\r\n\t\t\t\tfont-size: var(--uui-type-default-size);\r\n\t\t\t\tcolor: var(--uui-color-text);\r\n\t\t\t}\r\n\r\n\t\t\t.group-header-actions {\r\n\t\t\t\topacity: 0;\r\n\t\t\t\ttransition: opacity 120ms ease;\r\n\t\t\t}\r\n\r\n\t\t\t.group-header:hover .group-header-actions {\r\n\t\t\t\topacity: 1;\r\n\t\t\t}\r\n\r\n\t\t\t.group-rename-input {\r\n\t\t\t\tflex: 1;\r\n\t\t\t\tpadding: var(--uui-size-space-1) var(--uui-size-space-2);\r\n\t\t\t\tborder: 1px solid var(--uui-color-focus);\r\n\t\t\t\tborder-radius: var(--uui-border-radius);\r\n\t\t\t\tfont-size: var(--uui-type-default-size);\r\n\t\t\t\tbackground: var(--uui-color-surface);\r\n\t\t\t\tcolor: var(--uui-color-text);\r\n\t\t\t}\r\n\r\n\t\t\t.group-rename-input:focus {\r\n\t\t\t\toutline: none;\r\n\t\t\t}\r\n\r\n\t\t\t.header-spacer {\r\n\t\t\t\tflex: 1;\r\n\t\t\t}\r\n\r\n\t\t\t.group-rules {\r\n\t\t\t\tpadding: var(--uui-size-space-3);\r\n\t\t\t\tdisplay: flex;\r\n\t\t\t\tflex-direction: column;\r\n\t\t\t\tgap: var(--uui-size-space-3);\r\n\t\t\t}\r\n\r\n\t\t\t.ungrouped-label {\r\n\t\t\t\tfont-size: 11px;\r\n\t\t\t\tfont-weight: 700;\r\n\t\t\t\ttext-transform: uppercase;\r\n\t\t\t\tletter-spacing: 0.5px;\r\n\t\t\t\tcolor: var(--uui-color-text-alt);\r\n\t\t\t\tpadding-top: var(--uui-size-space-2);\r\n\t\t\t}\r\n\r\n\t\t\t/* Collapsed rule row */\r\n\t\t\t.rule-row {\r\n\t\t\t\tdisplay: flex;\r\n\t\t\t\talign-items: center;\r\n\t\t\t\tgap: var(--uui-size-space-3);\r\n\t\t\t\tpadding: var(--uui-size-space-2) var(--uui-size-space-4);\r\n\t\t\t\tborder: 1px solid var(--uui-color-border);\r\n\t\t\t\tborder-radius: var(--uui-border-radius);\r\n\t\t\t\tcursor: pointer;\r\n\t\t\t\tuser-select: none;\r\n\t\t\t\tbackground: var(--uui-color-surface);\r\n\t\t\t\ttransition: background 120ms ease;\r\n\t\t\t}\r\n\r\n\t\t\t.rule-row:hover {\r\n\t\t\t\tbackground: var(--uui-color-surface-alt);\r\n\t\t\t}\r\n\r\n\t\t\t.rule-row-name {\r\n\t\t\t\tflex: 1;\r\n\t\t\t\tfont-size: var(--uui-type-default-size);\r\n\t\t\t\tfont-weight: 600;\r\n\t\t\t\tmin-width: 0;\r\n\t\t\t\toverflow: hidden;\r\n\t\t\t\ttext-overflow: ellipsis;\r\n\t\t\t\twhite-space: nowrap;\r\n\t\t\t}\r\n\r\n\t\t\t.rule-row-part {\r\n\t\t\t\tfont-size: 11px;\r\n\t\t\t\tfont-weight: 600;\r\n\t\t\t\tpadding: 1px 8px;\r\n\t\t\t\tborder-radius: var(--uui-border-radius);\r\n\t\t\t\tbackground: var(--uui-color-surface-alt);\r\n\t\t\t\tcolor: var(--uui-color-text-alt);\r\n\t\t\t\tflex-shrink: 0;\r\n\t\t\t}\r\n\r\n\t\t\t.rule-row-part.excluded {\r\n\t\t\t\tbackground: color-mix(in srgb, var(--uui-color-danger) 15%, transparent);\r\n\t\t\t\tcolor: var(--uui-color-danger-standalone);\r\n\t\t\t}\r\n\r\n\t\t\t.rule-row-match {\r\n\t\t\t\tfont-size: 11px;\r\n\t\t\t\tfont-weight: 700;\r\n\t\t\t\tpadding: 1px 6px;\r\n\t\t\t\tborder-radius: var(--uui-border-radius);\r\n\t\t\t\tflex-shrink: 0;\r\n\t\t\t}\r\n\r\n\t\t\t.rule-row-match.matched {\r\n\t\t\t\tbackground: color-mix(in srgb, var(--uui-color-positive) 15%, transparent);\r\n\t\t\t\tcolor: var(--uui-color-positive-standalone);\r\n\t\t\t}\r\n\r\n\t\t\t.rule-row-match.excluded {\r\n\t\t\t\tbackground: color-mix(in srgb, var(--uui-color-danger) 15%, transparent);\r\n\t\t\t\tcolor: var(--uui-color-danger-standalone);\r\n\t\t\t}\r\n\r\n\t\t\t.rule-row-match.no-match {\r\n\t\t\t\tbackground: color-mix(in srgb, var(--uui-color-warning) 15%, transparent);\r\n\t\t\t\tcolor: var(--uui-color-warning-standalone);\r\n\t\t\t}\r\n\r\n\t\t\t.rule-row-chevron {\r\n\t\t\t\tfont-size: 12px;\r\n\t\t\t\tcolor: var(--uui-color-text-alt);\r\n\t\t\t\tflex-shrink: 0;\r\n\t\t\t\ttransition: transform 120ms ease;\r\n\t\t\t}\r\n\r\n\t\t\t/* Action bar: hidden by default, appears on hover */\r\n\t\t\t.rule-row-actions {\r\n\t\t\t\tflex-shrink: 0;\r\n\t\t\t\topacity: 0;\r\n\t\t\t\ttransition: opacity 120ms ease;\r\n\t\t\t}\r\n\r\n\t\t\t.rule-row:hover .rule-row-actions {\r\n\t\t\t\topacity: 1;\r\n\t\t\t}\r\n\r\n\t\t\t/* Rule cards (expanded) */\r\n\t\t\t.rule-card {\r\n\t\t\t\tborder: 1px solid var(--uui-color-border);\r\n\t\t\t\tborder-radius: var(--uui-border-radius);\r\n\t\t\t\toverflow: hidden;\r\n\t\t\t}\r\n\r\n\t\t\t.rule-header {\r\n\t\t\t\tdisplay: flex;\r\n\t\t\t\talign-items: center;\r\n\t\t\t\tgap: var(--uui-size-space-3);\r\n\t\t\t\tpadding: var(--uui-size-space-3) var(--uui-size-space-4);\r\n\t\t\t\tbackground: var(--uui-color-surface-alt);\r\n\t\t\t\tborder-bottom: 1px solid var(--uui-color-border);\r\n\t\t\t}\r\n\r\n\t\t\t.rule-grip {\r\n\t\t\t\tcursor: grab;\r\n\t\t\t\tcolor: var(--uui-color-text-alt);\r\n\t\t\t\tfont-size: 14px;\r\n\t\t\t\tuser-select: none;\r\n\t\t\t\tflex-shrink: 0;\r\n\t\t\t}\r\n\r\n\t\t\t.rule-grip.disabled {\r\n\t\t\t\tcursor: default;\r\n\t\t\t\topacity: 0.3;\r\n\t\t\t}\r\n\r\n\t\t\t.rule-grip:active {\r\n\t\t\t\tcursor: grabbing;\r\n\t\t\t}\r\n\r\n\t\t\t.role-name-input {\r\n\t\t\t\tflex: 1;\r\n\t\t\t\tpadding: var(--uui-size-space-1) var(--uui-size-space-2);\r\n\t\t\t\tborder: 1px solid var(--uui-color-border);\r\n\t\t\t\tborder-radius: var(--uui-border-radius);\r\n\t\t\t\tfont-size: var(--uui-type-default-size);\r\n\t\t\t\tfont-family: monospace;\r\n\t\t\t\tbackground: var(--uui-color-surface);\r\n\t\t\t\tcolor: var(--uui-color-text);\r\n\t\t\t}\r\n\r\n\t\t\t.role-name-input:focus {\r\n\t\t\t\toutline: none;\r\n\t\t\t\tborder-color: var(--uui-color-focus);\r\n\t\t\t}\r\n\r\n\t\t\t/* Section headers within rule cards */\r\n\t\t\t.section-header {\r\n\t\t\t\tfont-size: 11px;\r\n\t\t\t\tfont-weight: 700;\r\n\t\t\t\ttext-transform: uppercase;\r\n\t\t\t\tletter-spacing: 0.5px;\r\n\t\t\t\tcolor: var(--uui-color-text-alt);\r\n\t\t\t\tmargin-bottom: var(--uui-size-space-1);\r\n\t\t\t}\r\n\r\n\t\t\t.section-header.collapsible {\r\n\t\t\t\tcursor: pointer;\r\n\t\t\t\tdisplay: flex;\r\n\t\t\t\talign-items: center;\r\n\t\t\t\tgap: var(--uui-size-space-1);\r\n\t\t\t\tuser-select: none;\r\n\t\t\t}\r\n\r\n\t\t\t.section-header.collapsible:hover {\r\n\t\t\t\tcolor: var(--uui-color-text);\r\n\t\t\t}\r\n\r\n\t\t\t.section-header.collapsible uui-icon {\r\n\t\t\t\tfont-size: 10px;\r\n\t\t\t}\r\n\r\n\t\t\t/* Conditions */\r\n\t\t\t.conditions-area {\r\n\t\t\t\tpadding: var(--uui-size-space-3) var(--uui-size-space-4);\r\n\t\t\t\tdisplay: flex;\r\n\t\t\t\tflex-direction: column;\r\n\t\t\t\tgap: var(--uui-size-space-2);\r\n\t\t\t}\r\n\r\n\t\t\t/* Exceptions */\r\n\t\t\t.exceptions-area {\r\n\t\t\t\tpadding: var(--uui-size-space-3) var(--uui-size-space-4);\r\n\t\t\t\tdisplay: flex;\r\n\t\t\t\tflex-direction: column;\r\n\t\t\t\tgap: var(--uui-size-space-2);\r\n\t\t\t\tborder-top: 1px solid var(--uui-color-border);\r\n\t\t\t}\r\n\r\n\t\t\t.condition-row {\r\n\t\t\t\tdisplay: flex;\r\n\t\t\t\talign-items: center;\r\n\t\t\t\tgap: var(--uui-size-space-2);\r\n\t\t\t}\r\n\r\n\t\t\t.condition-type-select {\r\n\t\t\t\tmin-width: 180px;\r\n\t\t\t\tpadding: var(--uui-size-space-1) var(--uui-size-space-2);\r\n\t\t\t\tborder: 1px solid var(--uui-color-border);\r\n\t\t\t\tborder-radius: var(--uui-border-radius);\r\n\t\t\t\tfont-size: var(--uui-type-small-size);\r\n\t\t\t\tbackground: var(--uui-color-surface);\r\n\t\t\t\tcolor: var(--uui-color-text);\r\n\t\t\t}\r\n\r\n\t\t\t.condition-type-select:focus {\r\n\t\t\t\toutline: none;\r\n\t\t\t\tborder-color: var(--uui-color-focus);\r\n\t\t\t}\r\n\r\n\t\t\t.condition-value-input {\r\n\t\t\t\tflex: 1;\r\n\t\t\t\tpadding: var(--uui-size-space-1) var(--uui-size-space-2);\r\n\t\t\t\tborder: 1px solid var(--uui-color-border);\r\n\t\t\t\tborder-radius: var(--uui-border-radius);\r\n\t\t\t\tfont-size: var(--uui-type-small-size);\r\n\t\t\t\tfont-family: monospace;\r\n\t\t\t\tbackground: var(--uui-color-surface);\r\n\t\t\t\tcolor: var(--uui-color-text);\r\n\t\t\t}\r\n\r\n\t\t\t.condition-value-input:focus {\r\n\t\t\t\toutline: none;\r\n\t\t\t\tborder-color: var(--uui-color-focus);\r\n\t\t\t}\r\n\r\n\t\t\t/* Format row selects */\r\n\t\t\t.format-type-select {\r\n\t\t\t\tmin-width: 100px;\r\n\t\t\t\tpadding: var(--uui-size-space-1) var(--uui-size-space-2);\r\n\t\t\t\tborder: 1px solid var(--uui-color-border);\r\n\t\t\t\tborder-radius: var(--uui-border-radius);\r\n\t\t\t\tfont-size: var(--uui-type-small-size);\r\n\t\t\t\tbackground: var(--uui-color-surface);\r\n\t\t\t\tcolor: var(--uui-color-text);\r\n\t\t\t}\r\n\r\n\t\t\t.format-type-select:focus {\r\n\t\t\t\toutline: none;\r\n\t\t\t\tborder-color: var(--uui-color-focus);\r\n\t\t\t}\r\n\r\n\t\t\t.format-value-select {\r\n\t\t\t\tflex: 1;\r\n\t\t\t\tpadding: var(--uui-size-space-1) var(--uui-size-space-2);\r\n\t\t\t\tborder: 1px solid var(--uui-color-border);\r\n\t\t\t\tborder-radius: var(--uui-border-radius);\r\n\t\t\t\tfont-size: var(--uui-type-small-size);\r\n\t\t\t\tbackground: var(--uui-color-surface);\r\n\t\t\t\tcolor: var(--uui-color-text);\r\n\t\t\t}\r\n\r\n\t\t\t.format-value-select:focus {\r\n\t\t\t\toutline: none;\r\n\t\t\t\tborder-color: var(--uui-color-focus);\r\n\t\t\t}\r\n\r\n\t\t\t/* Part area (replaces old action area) */\r\n\t\t\t.part-area {\r\n\t\t\t\tdisplay: flex;\r\n\t\t\t\tflex-direction: column;\r\n\t\t\t\tgap: var(--uui-size-space-2);\r\n\t\t\t\tpadding: var(--uui-size-space-3) var(--uui-size-space-4);\r\n\t\t\t\tborder-top: 1px solid var(--uui-color-border);\r\n\t\t\t}\r\n\r\n\t\t\t.part-controls {\r\n\t\t\t\tdisplay: flex;\r\n\t\t\t\talign-items: center;\r\n\t\t\t\tgap: var(--uui-size-space-3);\r\n\t\t\t}\r\n\r\n\t\t\t.part-select {\r\n\t\t\t\tpadding: var(--uui-size-space-1) var(--uui-size-space-2);\r\n\t\t\t\tborder: 1px solid var(--uui-color-border);\r\n\t\t\t\tborder-radius: var(--uui-border-radius);\r\n\t\t\t\tfont-size: var(--uui-type-small-size);\r\n\t\t\t\tbackground: var(--uui-color-surface);\r\n\t\t\t\tcolor: var(--uui-color-text);\r\n\t\t\t}\r\n\r\n\t\t\t.part-select:focus {\r\n\t\t\t\toutline: none;\r\n\t\t\t\tborder-color: var(--uui-color-focus);\r\n\t\t\t}\r\n\r\n\t\t\t.part-select:disabled {\r\n\t\t\t\topacity: 0.5;\r\n\t\t\t}\r\n\r\n\t\t\t.exclude-label {\r\n\t\t\t\tdisplay: flex;\r\n\t\t\t\talign-items: center;\r\n\t\t\t\tgap: var(--uui-size-space-1);\r\n\t\t\t\tfont-size: var(--uui-type-small-size);\r\n\t\t\t\tcolor: var(--uui-color-text-alt);\r\n\t\t\t\tcursor: pointer;\r\n\t\t\t\tuser-select: none;\r\n\t\t\t}\r\n\r\n\t\t\t.move-to-group {\r\n\t\t\t\tdisplay: flex;\r\n\t\t\t\talign-items: center;\r\n\t\t\t\tgap: var(--uui-size-space-2);\r\n\t\t\t\tmargin-top: var(--uui-size-space-1);\r\n\t\t\t}\r\n\r\n\t\t\t.move-label {\r\n\t\t\t\tfont-size: var(--uui-type-small-size);\r\n\t\t\t\tcolor: var(--uui-color-text-alt);\r\n\t\t\t}\r\n\r\n\t\t\t.group-select {\r\n\t\t\t\tflex: 1;\r\n\t\t\t\tpadding: var(--uui-size-space-1) var(--uui-size-space-2);\r\n\t\t\t\tborder: 1px solid var(--uui-color-border);\r\n\t\t\t\tborder-radius: var(--uui-border-radius);\r\n\t\t\t\tfont-size: var(--uui-type-small-size);\r\n\t\t\t\tbackground: var(--uui-color-surface);\r\n\t\t\t\tcolor: var(--uui-color-text);\r\n\t\t\t}\r\n\r\n\t\t\t.group-select:focus {\r\n\t\t\t\toutline: none;\r\n\t\t\t\tborder-color: var(--uui-color-focus);\r\n\t\t\t}\r\n\r\n\t\t\t/* Format area */\r\n\t\t\t.format-area {\r\n\t\t\t\tdisplay: flex;\r\n\t\t\t\tflex-direction: column;\r\n\t\t\t\tgap: var(--uui-size-space-2);\r\n\t\t\t\tpadding: var(--uui-size-space-3) var(--uui-size-space-4);\r\n\t\t\t\tborder-top: 1px solid var(--uui-color-border);\r\n\t\t\t}\r\n\r\n\t\t\t/* Match preview */\r\n\t\t\t.match-preview {\r\n\t\t\t\tdisplay: flex;\r\n\t\t\t\talign-items: center;\r\n\t\t\t\tgap: var(--uui-size-space-2);\r\n\t\t\t\tpadding: var(--uui-size-space-2) var(--uui-size-space-4);\r\n\t\t\t\tfont-size: var(--uui-type-small-size);\r\n\t\t\t\tborder-top: 1px solid var(--uui-color-border);\r\n\t\t\t}\r\n\r\n\t\t\t.match-preview.matched {\r\n\t\t\t\tbackground: color-mix(in srgb, var(--uui-color-positive) 10%, transparent);\r\n\t\t\t\tcolor: var(--uui-color-positive-standalone);\r\n\t\t\t}\r\n\r\n\t\t\t.match-preview.excluded {\r\n\t\t\t\tbackground: color-mix(in srgb, var(--uui-color-danger) 10%, transparent);\r\n\t\t\t\tcolor: var(--uui-color-danger-standalone);\r\n\t\t\t}\r\n\r\n\t\t\t.match-preview.no-match {\r\n\t\t\t\tbackground: color-mix(in srgb, var(--uui-color-warning) 10%, transparent);\r\n\t\t\t\tcolor: var(--uui-color-warning-standalone);\r\n\t\t\t}\r\n\r\n\t\t\t.match-preview strong {\r\n\t\t\t\tfont-weight: 600;\r\n\t\t\t}\r\n\r\n\t\t\t/* Unmatched elements */\r\n\t\t\t.unmatched-section {\r\n\t\t\t\tborder: 1px dashed var(--uui-color-border);\r\n\t\t\t\tborder-radius: var(--uui-border-radius);\r\n\t\t\t\tpadding: var(--uui-size-space-3) var(--uui-size-space-4);\r\n\t\t\t}\r\n\r\n\t\t\t.unmatched-section h4 {\r\n\t\t\t\tmargin: 0 0 var(--uui-size-space-3);\r\n\t\t\t\tcolor: var(--uui-color-text-alt);\r\n\t\t\t\tfont-size: var(--uui-type-small-size);\r\n\t\t\t\ttext-transform: uppercase;\r\n\t\t\t\tletter-spacing: 0.5px;\r\n\t\t\t}\r\n\r\n\t\t\t.unmatched-element {\r\n\t\t\t\tdisplay: flex;\r\n\t\t\t\talign-items: center;\r\n\t\t\t\tgap: var(--uui-size-space-3);\r\n\t\t\t\tpadding: var(--uui-size-space-2) 0;\r\n\t\t\t\tborder-bottom: 1px solid var(--uui-color-border);\r\n\t\t\t}\r\n\r\n\t\t\t.unmatched-element:last-child {\r\n\t\t\t\tborder-bottom: none;\r\n\t\t\t}\r\n\r\n\t\t\t.unmatched-text {\r\n\t\t\t\tflex: 1;\r\n\t\t\t\tfont-size: var(--uui-type-small-size);\r\n\t\t\t\tmin-width: 0;\r\n\t\t\t\toverflow: hidden;\r\n\t\t\t\ttext-overflow: ellipsis;\r\n\t\t\t\twhite-space: nowrap;\r\n\t\t\t}\r\n\r\n\t\t\t.unmatched-meta {\r\n\t\t\t\tdisplay: flex;\r\n\t\t\t\tgap: var(--uui-size-space-1);\r\n\t\t\t\tflex-shrink: 0;\r\n\t\t\t}\r\n\t\t`,\r\n\t];\r\n}\r\n\r\nexport default UpDocSectionRulesEditorModalElement;\r\n\r\ndeclare global {\r\n\tinterface HTMLElementTagNameMap {\r\n\t\t'up-doc-section-rules-editor-modal': UpDocSectionRulesEditorModalElement;\r\n\t}\r\n}\r\n"],"names":["getEffectivePart","rule","getEffectiveFormat","_UpDocSectionRulesEditorModalElement_instances","isCollapsed_fn","toggleCollapsed_fn","isRuleExpanded_fn","toggleRuleExpanded_fn","expandRule_fn","normalizeRule_fn","elements_get","sectionHeading_get","groupedView_get","evaluateRules_fn","elementMatchesAllConditions_fn","elementMatchesCondition_fn","autoPopulateConditions_fn","addRule_fn","removeRule_fn","createRuleFromElement_fn","updateRoleName_fn","updatePart_fn","updateExclude_fn","addGroup_fn","startRenameGroup_fn","confirmRenameGroup_fn","cancelRenameGroup_fn","deleteGroup_fn","moveRuleToGroup_fn","addFormatEntry_fn","removeFormatEntry_fn","updateFormatEntryType_fn","updateFormatEntryValue_fn","addCondition_fn","removeCondition_fn","updateConditionType_fn","updateConditionValue_fn","addException_fn","removeException_fn","updateExceptionType_fn","updateExceptionValue_fn","cleanRule_fn","buildRulesValue_fn","onSave_fn","onSaveAndClose_fn","onClose_fn","renderConditionRow_fn","renderExceptionRow_fn","renderFormatRow_fn","renderRuleCard_fn","renderCollapsedRule_fn","renderExpandedRule_fn","truncate_fn","renderGroupHeader_fn","renderUnmatchedElements_fn","_nextRuleId","generateRuleId","CONDITION_LABELS","VALUELESS_CONDITIONS","ALL_CONDITION_TYPES","PART_LABELS","ALL_PARTS","FORMAT_ENTRY_TYPE_LABELS","ALL_FORMAT_ENTRY_TYPES","BLOCK_FORMAT_LABELS","ALL_BLOCK_FORMATS","STYLE_FORMAT_LABELS","ALL_STYLE_FORMATS","UpDocSectionRulesEditorModalElement","UmbModalBaseElement","__privateAdd","areaRules","editableRules","groupOrder","group","__privateMethod","claimed","ruleMatches","elId","ruleIdx","el","__privateGet","e","existing","groupedView","html","nothing","entry","flatIndex","section","key","next","ruleId","groupName","part","exclude","derived","formats","result","name","groupRules","r","i","ungrouped","elements","elIdx","exc","conditions","index","total","c","condition","val","numVal","elIndex","colonIdx","id","_","roleSuggestion","value","updated","counter","oldName","newName","n","fmtIdx","type","defaultValue","condIdx","cond","isNumeric","excIdx","blockEntry","f","_id","_groupName","action","clean","groups","ungroupedRules","rules","isValueless","t","exception","valueOptions","valueLabels","v","flatIdx","matchedElements","isExcluded","currentPart","partLabel","matchCount","roleName","moveOptions","cIdx","eIdx","p","opt","fmt","fIdx","text","max","unmatched","UmbTextStyles","css","__decorateClass","state","customElement","UpDocSectionRulesEditorModalElement_default"],"mappings":"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AA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAseD;AAr7CiBC,EAAA;AAAA,EAAhBC,EAAA;AAAM,GAFKnG,EAEK,WAAA,UAAA,CAAA;AAEAkG,EAAA;AAAA,EAAhBC,EAAA;AAAM,GAJKnG,EAIK,WAAA,eAAA,CAAA;AAEAkG,EAAA;AAAA,EAAhBC,EAAA;AAAM,GANKnG,EAMK,WAAA,cAAA,CAAA;AAEAkG,EAAA;AAAA,EAAhBC,EAAA;AAAM,GARKnG,EAQK,WAAA,kBAAA,CAAA;AAEAkG,EAAA;AAAA,EAAhBC,EAAA;AAAM,GAVKnG,EAUK,WAAA,kBAAA,CAAA;AACAkG,EAAA;AAAA,EAAhBC,EAAA;AAAM,GAXKnG,EAWK,WAAA,gBAAA,CAAA;AAXLA,IAANkG,EAAA;AAAA,EADNE,GAAc,mCAAmC;AAAA,GACrCpG,CAAA;AA07Cb,MAAAqG,KAAerG;"}