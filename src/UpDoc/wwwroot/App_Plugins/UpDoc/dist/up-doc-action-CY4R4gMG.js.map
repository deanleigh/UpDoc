{"version":3,"file":"up-doc-action-CY4R4gMG.js","sources":["../src/up-doc-action.ts"],"sourcesContent":["import { UMB_UP_DOC_MODAL } from './up-doc-modal.token.js';\r\nimport { UMB_BLUEPRINT_PICKER_MODAL } from './blueprint-picker-modal.token.js';\r\nimport type { DocumentTypeOption } from './blueprint-picker-modal.token.js';\r\nimport type { DocumentTypeConfig, MappingDestination } from './workflow.types.js';\r\nimport { fetchActiveWorkflows } from './workflow.service.js';\r\nimport { markdownToHtml, buildRteValue } from './transforms.js';\r\nimport { UmbEntityActionBase } from '@umbraco-cms/backoffice/entity-action';\r\nimport { umbOpenModal } from '@umbraco-cms/backoffice/modal';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport type { UmbEntityActionArgs } from '@umbraco-cms/backoffice/entity-action';\r\nimport { UMB_NOTIFICATION_CONTEXT } from '@umbraco-cms/backoffice/notification';\r\nimport { UMB_AUTH_CONTEXT } from '@umbraco-cms/backoffice/auth';\r\nimport { UmbDocumentTypeStructureRepository } from '@umbraco-cms/backoffice/document-type';\r\nimport { UmbDocumentBlueprintItemRepository } from '@umbraco-cms/backoffice/document-blueprint';\r\nimport { UmbDocumentItemRepository } from '@umbraco-cms/backoffice/document';\r\n\r\nexport class UpDocEntityAction extends UmbEntityActionBase<never> {\r\n\t#documentTypeStructureRepository = new UmbDocumentTypeStructureRepository(this);\r\n\t#blueprintItemRepository = new UmbDocumentBlueprintItemRepository(this);\r\n\t#documentItemRepository = new UmbDocumentItemRepository(this);\r\n\r\n\tconstructor(host: UmbControllerHost, args: UmbEntityActionArgs<never>) {\r\n\t\tsuper(host, args);\r\n\t}\r\n\r\n\toverride async execute() {\r\n\t\tconst notificationContext = await this.getContext(UMB_NOTIFICATION_CONTEXT);\r\n\t\tconst parentUnique = this.args.unique ?? null;\r\n\r\n\t\ttry {\r\n\t\t\t// Step 1: Get the parent document's document type\r\n\t\t\tlet parentDocTypeUnique: string | null = null;\r\n\r\n\t\t\tif (parentUnique) {\r\n\t\t\t\tconst { data: parentItems } = await this.#documentItemRepository.requestItems([parentUnique]);\r\n\t\t\t\tif (parentItems?.length) {\r\n\t\t\t\t\tparentDocTypeUnique = parentItems[0].documentType.unique;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t// Step 2: Get allowed child document types\r\n\t\t\tconst result = await this.#documentTypeStructureRepository.requestAllowedChildrenOf(\r\n\t\t\t\tparentDocTypeUnique,\r\n\t\t\t\tparentUnique\r\n\t\t\t);\r\n\t\t\tconst allowedTypes = result.data;\r\n\r\n\t\t\tif (!allowedTypes?.items?.length) {\r\n\t\t\t\tnotificationContext.peek('danger', {\r\n\t\t\t\t\tdata: { message: 'No document types are allowed as children of this page.' },\r\n\t\t\t\t});\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\t// Step 3: Discover blueprints for allowed child types, grouped by document type\r\n\t\t\tconst authContext = await this.getContext(UMB_AUTH_CONTEXT);\r\n\t\t\tconst token = await authContext.getLatestToken();\r\n\r\n\t\t\t// Fetch active workflows to filter blueprints\r\n\t\t\tconst activeWorkflows = await fetchActiveWorkflows(token);\r\n\t\t\tconst activeBlueprintIds = new Set(activeWorkflows.blueprintIds);\r\n\r\n\t\t\tconst documentTypeOptions: DocumentTypeOption[] = [];\r\n\r\n\t\t\tfor (const docType of allowedTypes.items) {\r\n\t\t\t\tconst { data: blueprints } = await this.#blueprintItemRepository.requestItemsByDocumentType(docType.unique);\r\n\t\t\t\tif (blueprints?.length) {\r\n\t\t\t\t\t// Only include blueprints that have complete workflows\r\n\t\t\t\t\tconst workflowBlueprints = blueprints.filter((bp) => activeBlueprintIds.has(bp.unique));\r\n\t\t\t\t\tif (workflowBlueprints.length) {\r\n\t\t\t\t\t\tdocumentTypeOptions.push({\r\n\t\t\t\t\t\t\tdocumentTypeUnique: docType.unique,\r\n\t\t\t\t\t\t\tdocumentTypeName: docType.name,\r\n\t\t\t\t\t\t\tdocumentTypeIcon: (docType as { icon?: string }).icon ?? null,\r\n\t\t\t\t\t\t\tblueprints: workflowBlueprints.map((bp) => ({\r\n\t\t\t\t\t\t\t\tblueprintUnique: bp.unique,\r\n\t\t\t\t\t\t\t\tblueprintName: bp.name,\r\n\t\t\t\t\t\t\t})),\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (!documentTypeOptions.length) {\r\n\t\t\t\tnotificationContext.peek('warning', {\r\n\t\t\t\t\tdata: { message: 'No workflows are configured for the document types allowed here.' },\r\n\t\t\t\t});\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\t// Step 4: Open blueprint picker dialog (doc type â†’ blueprint selection)\r\n\t\t\tlet blueprintSelection;\r\n\t\t\ttry {\r\n\t\t\t\tblueprintSelection = await umbOpenModal(this, UMB_BLUEPRINT_PICKER_MODAL, {\r\n\t\t\t\t\tdata: { documentTypes: documentTypeOptions },\r\n\t\t\t\t});\r\n\t\t\t} catch {\r\n\t\t\t\t// Dialog was cancelled\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tconst { blueprintUnique, documentTypeUnique } = blueprintSelection;\r\n\t\t\tconst selectedDocType = documentTypeOptions.find((dt) => dt.documentTypeUnique === documentTypeUnique);\r\n\t\t\tconst selectedBlueprint = selectedDocType?.blueprints.find((bp) => bp.blueprintUnique === blueprintUnique);\r\n\r\n\t\t\tconsole.log('Selected blueprint:', blueprintUnique, 'Document type:', documentTypeUnique);\r\n\r\n\t\t\t// Step 5: Open source sidebar modal (passes blueprintId for map file lookup)\r\n\t\t\tlet modalValue;\r\n\t\t\ttry {\r\n\t\t\t\tmodalValue = await umbOpenModal(this, UMB_UP_DOC_MODAL, {\r\n\t\t\t\t\tdata: {\r\n\t\t\t\t\t\tunique: parentUnique,\r\n\t\t\t\t\t\tdocumentTypeName: selectedDocType?.documentTypeName ?? '',\r\n\t\t\t\t\t\tblueprintName: selectedBlueprint?.blueprintName ?? '',\r\n\t\t\t\t\t\tblueprintId: blueprintUnique,\r\n\t\t\t\t\t},\r\n\t\t\t\t});\r\n\t\t\t} catch {\r\n\t\t\t\t// Modal was cancelled\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tconst { name, mediaUnique, extractedSections, config } = modalValue;\r\n\r\n\t\t\tif (!mediaUnique || !name || !config) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tconsole.log('Creating document with:', { name, sections: Object.keys(extractedSections) });\r\n\r\n\t\t\t// Step 6: Scaffold from the selected blueprint\r\n\t\t\tconst scaffoldResponse = await fetch(\r\n\t\t\t\t`/umbraco/management/api/v1/document-blueprint/${blueprintUnique}/scaffold`,\r\n\t\t\t\t{\r\n\t\t\t\t\tmethod: 'GET',\r\n\t\t\t\t\theaders: {\r\n\t\t\t\t\t\t'Content-Type': 'application/json',\r\n\t\t\t\t\t\tAuthorization: `Bearer ${token}`,\r\n\t\t\t\t\t},\r\n\t\t\t\t}\r\n\t\t\t);\r\n\r\n\t\t\tif (!scaffoldResponse.ok) {\r\n\t\t\t\tconst error = await scaffoldResponse.json();\r\n\t\t\t\tconsole.error('Scaffold failed:', error);\r\n\t\t\t\tnotificationContext.peek('danger', {\r\n\t\t\t\t\tdata: { message: `Failed to scaffold from blueprint: ${error.title || 'Unknown error'}` },\r\n\t\t\t\t});\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tconst scaffold = await scaffoldResponse.json();\r\n\t\t\tconsole.log('Scaffold response:', scaffold);\r\n\t\t\tconsole.log('Scaffold values aliases:', scaffold.values?.map((v: { alias: string }) => v.alias));\r\n\r\n\t\t\t// Step 7: Apply property mappings from the map file\r\n\t\t\t// Deep clone to avoid modifying the original scaffold\r\n\t\t\tconst values: Array<{ alias: string; value: unknown }> = scaffold.values\r\n\t\t\t\t? JSON.parse(JSON.stringify(scaffold.values))\r\n\t\t\t\t: [];\r\n\r\n\t\t\tconsole.log('Extracted sections available:', Object.keys(extractedSections));\r\n\t\t\tconsole.log('Mappings to apply:', config.map.mappings.map(m => `${m.source} -> ${m.destinations.map(d => d.target).join(', ')}`));\r\n\r\n\t\t\t// Apply each mapping from the config\r\n\t\t\tfor (const mapping of config.map.mappings) {\r\n\t\t\t\tif (mapping.enabled === false) {\r\n\t\t\t\t\tconsole.log(`Skipping disabled mapping for source: ${mapping.source}`);\r\n\t\t\t\t\tcontinue;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst sectionValue = extractedSections[mapping.source];\r\n\t\t\t\tif (!sectionValue) {\r\n\t\t\t\t\tconsole.log(`No extracted value for source: \"${mapping.source}\"`);\r\n\t\t\t\t\tcontinue;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconsole.log(`Applying mapping for \"${mapping.source}\" (${sectionValue.length} chars)`);\r\n\r\n\t\t\t\tfor (const dest of mapping.destinations) {\r\n\t\t\t\t\tthis.#applyDestinationMapping(values, dest, sectionValue, config);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tconsole.log('Values after all mappings applied:');\r\n\t\t\tfor (const v of values) {\r\n\t\t\t\tconst preview = typeof v.value === 'string'\r\n\t\t\t\t\t? v.value.substring(0, 60)\r\n\t\t\t\t\t: typeof v.value === 'object' ? '[object]' : v.value;\r\n\t\t\t\tconsole.log(`  ${v.alias}: ${preview}`);\r\n\t\t\t}\r\n\r\n\t\t\t// Build the create request\r\n\t\t\tconst createRequest = {\r\n\t\t\t\tparent: parentUnique ? { id: parentUnique } : null,\r\n\t\t\t\tdocumentType: { id: documentTypeUnique },\r\n\t\t\t\ttemplate: scaffold.template ? { id: scaffold.template.id } : null,\r\n\t\t\t\tvalues,\r\n\t\t\t\tvariants: [\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tname,\r\n\t\t\t\t\t\tculture: null,\r\n\t\t\t\t\t\tsegment: null,\r\n\t\t\t\t\t},\r\n\t\t\t\t],\r\n\t\t\t};\r\n\r\n\t\t\tconsole.log('Create request:', JSON.stringify(createRequest, null, 2));\r\n\r\n\t\t\t// Step 8: Create the document\r\n\t\t\tconst createResponse = await fetch('/umbraco/management/api/v1/document', {\r\n\t\t\t\tmethod: 'POST',\r\n\t\t\t\theaders: {\r\n\t\t\t\t\t'Content-Type': 'application/json',\r\n\t\t\t\t\tAuthorization: `Bearer ${token}`,\r\n\t\t\t\t},\r\n\t\t\t\tbody: JSON.stringify(createRequest),\r\n\t\t\t});\r\n\r\n\t\t\tif (!createResponse.ok) {\r\n\t\t\t\tconst error = await createResponse.json();\r\n\t\t\t\tconsole.error('Document creation failed:', error);\r\n\t\t\t\tnotificationContext.peek('danger', {\r\n\t\t\t\t\tdata: { message: `Failed to create document: ${error.title || error.detail || 'Unknown error'}` },\r\n\t\t\t\t});\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\t// Success!\r\n\t\t\tconst locationHeader = createResponse.headers.get('Location');\r\n\t\t\tconst newDocumentId = locationHeader?.split('/').pop();\r\n\r\n\t\t\tconsole.log('Document created successfully! ID:', newDocumentId);\r\n\r\n\t\t\t// Step 9: Save the document to properly persist it and trigger cache updates\r\n\t\t\tif (newDocumentId) {\r\n\t\t\t\tconst getResponse = await fetch(`/umbraco/management/api/v1/document/${newDocumentId}`, {\r\n\t\t\t\t\tmethod: 'GET',\r\n\t\t\t\t\theaders: {\r\n\t\t\t\t\t\t'Content-Type': 'application/json',\r\n\t\t\t\t\t\tAuthorization: `Bearer ${token}`,\r\n\t\t\t\t\t},\r\n\t\t\t\t});\r\n\r\n\t\t\t\tif (getResponse.ok) {\r\n\t\t\t\t\tconst documentData = await getResponse.json();\r\n\t\t\t\t\tconsole.log('Fetched document for save:', documentData);\r\n\r\n\t\t\t\t\tconst saveResponse = await fetch(`/umbraco/management/api/v1/document/${newDocumentId}`, {\r\n\t\t\t\t\t\tmethod: 'PUT',\r\n\t\t\t\t\t\theaders: {\r\n\t\t\t\t\t\t\t'Content-Type': 'application/json',\r\n\t\t\t\t\t\t\tAuthorization: `Bearer ${token}`,\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tbody: JSON.stringify(documentData),\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t\tif (saveResponse.ok) {\r\n\t\t\t\t\t\tconsole.log('Document saved successfully');\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tconsole.warn('Document save failed, but document was created:', await saveResponse.text());\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconsole.warn('Could not fetch document for save:', await getResponse.text());\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tnotificationContext.peek('positive', {\r\n\t\t\t\tdata: { message: `Document \"${name}\" created successfully!` },\r\n\t\t\t});\r\n\r\n\t\t\t// Navigate to the new document after a short delay\r\n\t\t\tif (newDocumentId) {\r\n\t\t\t\tconst newPath = `/umbraco/section/content/workspace/document/edit/${newDocumentId}`;\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\twindow.location.href = newPath;\r\n\t\t\t\t}, 150);\r\n\t\t\t}\r\n\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error('Error creating document:', error);\r\n\t\t\tnotificationContext.peek('danger', {\r\n\t\t\t\tdata: { message: 'An unexpected error occurred while creating the document.' },\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Applies a single destination mapping from the config.\r\n\t * Handles both simple field mappings and block grid mappings.\r\n\t */\r\n\t#applyDestinationMapping(\r\n\t\tvalues: Array<{ alias: string; value: unknown }>,\r\n\t\tdest: MappingDestination,\r\n\t\tsectionValue: string,\r\n\t\tconfig: DocumentTypeConfig\r\n\t) {\r\n\t\t// Apply transforms to the value\r\n\t\tlet transformedValue = sectionValue;\r\n\t\tconst shouldConvertMarkdown = dest.transforms?.some((t) => t.type === 'convertMarkdownToHtml');\r\n\r\n\t\t// Parse the target path\r\n\t\tconst pathParts = dest.target.split('.');\r\n\r\n\t\tif (pathParts.length === 1) {\r\n\t\t\t// Simple field mapping: \"pageTitle\"\r\n\t\t\tconst alias = pathParts[0];\r\n\t\t\tconst existing = values.find((v) => v.alias === alias);\r\n\t\t\tif (existing) {\r\n\t\t\t\texisting.value = transformedValue;\r\n\t\t\t} else {\r\n\t\t\t\tvalues.push({ alias, value: transformedValue });\r\n\t\t\t}\r\n\t\t\tconsole.log(`Set ${alias} = \"${transformedValue.substring(0, 50)}...\"`);\r\n\t\t} else if (pathParts.length === 3) {\r\n\t\t\t// Block grid mapping: \"contentGrid.itineraryBlock.richTextContent\"\r\n\t\t\tconst [gridKey, blockKey, propertyKey] = pathParts;\r\n\r\n\t\t\t// Look up block info from destination config\r\n\t\t\tconst blockGrid = config.destination.blockGrids?.find((g) => g.key === gridKey);\r\n\t\t\tconst block = blockGrid?.blocks.find((b) => b.key === blockKey);\r\n\r\n\t\t\tif (!blockGrid || !block) {\r\n\t\t\t\tconsole.log(`Block path ${dest.target} not found in destination config`);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tconst gridAlias = blockGrid.alias;\r\n\t\t\tconst targetProperty = block.properties?.find((p) => p.key === propertyKey)?.alias ?? propertyKey;\r\n\t\t\tconst blockSearch = block.identifyBy;\r\n\r\n\t\t\tif (!blockSearch) {\r\n\t\t\t\tconsole.log(`No identifyBy for block ${blockKey}`);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tthis.#applyBlockGridValue(values, gridAlias, blockSearch, targetProperty, transformedValue, shouldConvertMarkdown);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Applies a value to a property within a block grid.\r\n\t * Finds the block by searching for a property value match.\r\n\t */\r\n\t#applyBlockGridValue(\r\n\t\tvalues: Array<{ alias: string; value: unknown }>,\r\n\t\tgridAlias: string,\r\n\t\tblockSearch: { property: string; value: string },\r\n\t\ttargetProperty: string,\r\n\t\tvalue: string,\r\n\t\tconvertMarkdown: boolean | undefined\r\n\t) {\r\n\t\tconst contentGridValue = values.find((v) => v.alias === gridAlias);\r\n\t\tif (!contentGridValue || !contentGridValue.value) {\r\n\t\t\tconsole.log(`No ${gridAlias} found in scaffold values`);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\ttry {\r\n\t\t\tconst wasString = typeof contentGridValue.value === 'string';\r\n\t\t\tconst contentGrid = wasString\r\n\t\t\t\t? JSON.parse(contentGridValue.value as string)\r\n\t\t\t\t: contentGridValue.value;\r\n\r\n\t\t\tconst contentData = contentGrid.contentData as Array<{\r\n\t\t\t\tcontentTypeKey: string;\r\n\t\t\t\tkey: string;\r\n\t\t\t\tvalues: Array<{ alias: string; value: unknown }>;\r\n\t\t\t}>;\r\n\r\n\t\t\tif (!contentData) {\r\n\t\t\t\tconsole.log(`No contentData in ${gridAlias}`);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\t// Search for the matching block\r\n\t\t\tlet foundBlock = false;\r\n\t\t\tfor (const block of contentData) {\r\n\t\t\t\tconst searchValue = block.values?.find((v) => v.alias === blockSearch.property);\r\n\r\n\t\t\t\tif (searchValue && typeof searchValue.value === 'string' &&\r\n\t\t\t\t\tsearchValue.value.toLowerCase().includes(blockSearch.value.toLowerCase())) {\r\n\r\n\t\t\t\t\tconsole.log(`Found matching block for \"${blockSearch.value}\":`, block.key);\r\n\t\t\t\t\tfoundBlock = true;\r\n\r\n\t\t\t\t\tconst targetValue = block.values?.find((v) => v.alias === targetProperty);\r\n\t\t\t\t\tif (targetValue) {\r\n\t\t\t\t\t\tif (convertMarkdown) {\r\n\t\t\t\t\t\t\tconst htmlContent = markdownToHtml(value);\r\n\t\t\t\t\t\t\ttargetValue.value = buildRteValue(htmlContent);\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\ttargetValue.value = value;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tconsole.log(`Updated ${targetProperty} in block`);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (!foundBlock) {\r\n\t\t\t\tconsole.log(`WARNING: Did not find a block matching ${blockSearch.property} = \"${blockSearch.value}\"`);\r\n\t\t\t}\r\n\r\n\t\t\tcontentGridValue.value = wasString ? JSON.stringify(contentGrid) : contentGrid;\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error(`Failed to apply block mapping to ${gridAlias}:`, error);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport default UpDocEntityAction;\r\n"],"names":["UpDocEntityAction","UmbEntityActionBase","host","args","__privateAdd","_UpDocEntityAction_instances","_documentTypeStructureRepository","UmbDocumentTypeStructureRepository","_blueprintItemRepository","UmbDocumentBlueprintItemRepository","_documentItemRepository","UmbDocumentItemRepository","notificationContext","UMB_NOTIFICATION_CONTEXT","parentUnique","parentDocTypeUnique","parentItems","__privateGet","allowedTypes","_a","token","UMB_AUTH_CONTEXT","activeWorkflows","fetchActiveWorkflows","activeBlueprintIds","documentTypeOptions","docType","blueprints","workflowBlueprints","bp","blueprintSelection","umbOpenModal","UMB_BLUEPRINT_PICKER_MODAL","blueprintUnique","documentTypeUnique","selectedDocType","dt","selectedBlueprint","modalValue","UMB_UP_DOC_MODAL","name","mediaUnique","extractedSections","config","scaffoldResponse","error","scaffold","_b","v","values","m","d","mapping","sectionValue","dest","__privateMethod","applyDestinationMapping_fn","preview","createRequest","createResponse","locationHeader","newDocumentId","getResponse","documentData","saveResponse","newPath","transformedValue","shouldConvertMarkdown","t","pathParts","alias","existing","gridKey","blockKey","propertyKey","blockGrid","g","block","b","gridAlias","targetProperty","_d","_c","p","blockSearch","applyBlockGridValue_fn","value","convertMarkdown","contentGridValue","wasString","contentGrid","contentData","foundBlock","searchValue","targetValue","htmlContent","markdownToHtml","buildRteValue"],"mappings":"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"}