{"version":3,"file":"up-doc-has-workflows.condition-Dav2f0aX.js","sources":["../src/up-doc-has-workflows.condition.ts"],"sourcesContent":["import { UmbConditionBase } from '@umbraco-cms/backoffice/extension-registry';\r\nimport type {\r\n\tUmbConditionConfigBase,\r\n\tUmbConditionControllerArguments,\r\n\tUmbExtensionCondition,\r\n} from '@umbraco-cms/backoffice/extension-api';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport { UMB_AUTH_CONTEXT } from '@umbraco-cms/backoffice/auth';\r\nimport { UMB_ENTITY_CONTEXT } from '@umbraco-cms/backoffice/entity';\r\nimport { UmbDocumentTypeStructureRepository } from '@umbraco-cms/backoffice/document-type';\r\nimport { UmbDocumentBlueprintItemRepository } from '@umbraco-cms/backoffice/document-blueprint';\r\nimport { UmbDocumentItemRepository } from '@umbraco-cms/backoffice/document';\r\nimport { fetchActiveWorkflows } from './workflow.service.js';\r\n\r\nexport type UpDocHasWorkflowsConditionConfig =\r\n\tUmbConditionConfigBase<'UpDoc.Condition.HasAvailableWorkflows'>;\r\n\r\n/**\r\n * Custom condition that checks whether the current content node has any\r\n * allowed child document types with complete UpDoc workflows.\r\n *\r\n * This is a per-node check: the \"Create Document from Source\" entity action\r\n * only appears on nodes where at least one allowed child type has a blueprint\r\n * with a complete workflow (destination + map + source).\r\n */\r\nexport class UpDocHasWorkflowsCondition\r\n\textends UmbConditionBase<UpDocHasWorkflowsConditionConfig>\r\n\timplements UmbExtensionCondition\r\n{\r\n\t#documentTypeStructureRepository = new UmbDocumentTypeStructureRepository(this);\r\n\t#blueprintItemRepository = new UmbDocumentBlueprintItemRepository(this);\r\n\t#documentItemRepository = new UmbDocumentItemRepository(this);\r\n\r\n\t#authContext: typeof UMB_AUTH_CONTEXT.TYPE | null = null;\r\n\t#entityUnique: string | null | undefined = undefined; // undefined = not yet received\r\n\r\n\tconstructor(\r\n\t\thost: UmbControllerHost,\r\n\t\targs: UmbConditionControllerArguments<UpDocHasWorkflowsConditionConfig>\r\n\t) {\r\n\t\tsuper(host, args);\r\n\r\n\t\tthis.consumeContext(UMB_AUTH_CONTEXT, (authContext) => {\r\n\t\t\tthis.#authContext = authContext;\r\n\t\t\tthis.#tryEvaluate();\r\n\t\t});\r\n\r\n\t\tthis.consumeContext(UMB_ENTITY_CONTEXT, (entityContext) => {\r\n\t\t\tif (!entityContext) return;\r\n\t\t\tthis.observe(entityContext.unique, (unique) => {\r\n\t\t\t\tthis.#entityUnique = unique ?? null;\r\n\t\t\t\tthis.#tryEvaluate();\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\t#tryEvaluate() {\r\n\t\tif (this.#authContext && this.#entityUnique !== undefined) {\r\n\t\t\tthis.#evaluate(this.#authContext, this.#entityUnique);\r\n\t\t}\r\n\t}\r\n\r\n\tasync #evaluate(authContext: typeof UMB_AUTH_CONTEXT.TYPE, entityUnique: string | null) {\r\n\t\ttry {\r\n\t\t\tconst token = await authContext.getLatestToken();\r\n\t\t\tconst activeWorkflows = await fetchActiveWorkflows(token);\r\n\r\n\t\t\t// Quick exit: no complete workflows anywhere\r\n\t\t\tif (!activeWorkflows.blueprintIds.length) {\r\n\t\t\t\tthis.permitted = false;\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tconst activeBlueprintIds = new Set(activeWorkflows.blueprintIds);\r\n\r\n\t\t\t// Get the entity's document type\r\n\t\t\tlet parentDocTypeUnique: string | null = null;\r\n\t\t\tif (entityUnique) {\r\n\t\t\t\tconst { data: parentItems } = await this.#documentItemRepository.requestItems([entityUnique]);\r\n\t\t\t\tif (parentItems?.length) {\r\n\t\t\t\t\tparentDocTypeUnique = parentItems[0].documentType.unique;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t// Get allowed child document types for this node\r\n\t\t\tconst result = await this.#documentTypeStructureRepository.requestAllowedChildrenOf(\r\n\t\t\t\tparentDocTypeUnique,\r\n\t\t\t\tentityUnique\r\n\t\t\t);\r\n\t\t\tconst allowedTypes = result.data;\r\n\r\n\t\t\tif (!allowedTypes?.items?.length) {\r\n\t\t\t\tthis.permitted = false;\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\t// Check if any allowed child type has a blueprint with a complete workflow\r\n\t\t\tfor (const docType of allowedTypes.items) {\r\n\t\t\t\tconst { data: blueprints } = await this.#blueprintItemRepository.requestItemsByDocumentType(docType.unique);\r\n\t\t\t\tif (blueprints?.some((bp) => activeBlueprintIds.has(bp.unique))) {\r\n\t\t\t\t\tthis.permitted = true;\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tthis.permitted = false;\r\n\t\t} catch {\r\n\t\t\tthis.permitted = false;\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport default UpDocHasWorkflowsCondition;\r\n\r\ndeclare global {\r\n\tinterface UmbExtensionConditionConfigMap {\r\n\t\tUpDocHasWorkflowsConditionConfig: UpDocHasWorkflowsConditionConfig;\r\n\t}\r\n}\r\n"],"names":["UpDocHasWorkflowsCondition","UmbConditionBase","#documentTypeStructureRepository","UmbDocumentTypeStructureRepository","#blueprintItemRepository","UmbDocumentBlueprintItemRepository","#documentItemRepository","UmbDocumentItemRepository","#authContext","#entityUnique","host","args","UMB_AUTH_CONTEXT","authContext","#tryEvaluate","UMB_ENTITY_CONTEXT","entityContext","unique","#evaluate","entityUnique","token","activeWorkflows","fetchActiveWorkflows","activeBlueprintIds","parentDocTypeUnique","parentItems","allowedTypes","docType","blueprints","bp"],"mappings":";;;;;;;AAyBO,MAAMA,UACJC,EAET;AAAA,EACCC,KAAmC,IAAIC,EAAmC,IAAI;AAAA,EAC9EC,KAA2B,IAAIC,EAAmC,IAAI;AAAA,EACtEC,KAA0B,IAAIC,EAA0B,IAAI;AAAA,EAE5DC,KAAoD;AAAA,EACpDC,KAA2C;AAAA;AAAA,EAE3C,YACCC,GACAC,GACC;AACD,UAAMD,GAAMC,CAAI,GAEhB,KAAK,eAAeC,GAAkB,CAACC,MAAgB;AACtD,WAAKL,KAAeK,GACpB,KAAKC,GAAA;AAAA,IACN,CAAC,GAED,KAAK,eAAeC,GAAoB,CAACC,MAAkB;AAC1D,MAAKA,KACL,KAAK,QAAQA,EAAc,QAAQ,CAACC,MAAW;AAC9C,aAAKR,KAAgBQ,KAAU,MAC/B,KAAKH,GAAA;AAAA,MACN,CAAC;AAAA,IACF,CAAC;AAAA,EACF;AAAA,EAEAA,KAAe;AACd,IAAI,KAAKN,MAAgB,KAAKC,OAAkB,UAC/C,KAAKS,GAAU,KAAKV,IAAc,KAAKC,EAAa;AAAA,EAEtD;AAAA,EAEA,MAAMS,GAAUL,GAA2CM,GAA6B;AACvF,QAAI;AACH,YAAMC,IAAQ,MAAMP,EAAY,eAAA,GAC1BQ,IAAkB,MAAMC,EAAqBF,CAAK;AAGxD,UAAI,CAACC,EAAgB,aAAa,QAAQ;AACzC,aAAK,YAAY;AACjB;AAAA,MACD;AAEA,YAAME,IAAqB,IAAI,IAAIF,EAAgB,YAAY;AAG/D,UAAIG,IAAqC;AACzC,UAAIL,GAAc;AACjB,cAAM,EAAE,MAAMM,MAAgB,MAAM,KAAKnB,GAAwB,aAAa,CAACa,CAAY,CAAC;AAC5F,QAAIM,GAAa,WAChBD,IAAsBC,EAAY,CAAC,EAAE,aAAa;AAAA,MAEpD;AAOA,YAAMC,KAJS,MAAM,KAAKxB,GAAiC;AAAA,QAC1DsB;AAAA,QACAL;AAAA,MAAA,GAE2B;AAE5B,UAAI,CAACO,GAAc,OAAO,QAAQ;AACjC,aAAK,YAAY;AACjB;AAAA,MACD;AAGA,iBAAWC,KAAWD,EAAa,OAAO;AACzC,cAAM,EAAE,MAAME,MAAe,MAAM,KAAKxB,GAAyB,2BAA2BuB,EAAQ,MAAM;AAC1G,YAAIC,GAAY,KAAK,CAACC,MAAON,EAAmB,IAAIM,EAAG,MAAM,CAAC,GAAG;AAChE,eAAK,YAAY;AACjB;AAAA,QACD;AAAA,MACD;AAEA,WAAK,YAAY;AAAA,IAClB,QAAQ;AACP,WAAK,YAAY;AAAA,IAClB;AAAA,EACD;AACD;"}