{"version":3,"file":"up-doc-has-workflows.condition-DXeNAITS.js","sources":["../src/up-doc-has-workflows.condition.ts"],"sourcesContent":["import { UmbConditionBase } from '@umbraco-cms/backoffice/extension-registry';\r\nimport type {\r\n\tUmbConditionConfigBase,\r\n\tUmbConditionControllerArguments,\r\n\tUmbExtensionCondition,\r\n} from '@umbraco-cms/backoffice/extension-api';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport { UMB_AUTH_CONTEXT } from '@umbraco-cms/backoffice/auth';\r\nimport { UMB_ENTITY_CONTEXT } from '@umbraco-cms/backoffice/entity';\r\nimport { UmbDocumentTypeStructureRepository } from '@umbraco-cms/backoffice/document-type';\r\nimport { UmbDocumentBlueprintItemRepository } from '@umbraco-cms/backoffice/document-blueprint';\r\nimport { UmbDocumentItemRepository } from '@umbraco-cms/backoffice/document';\r\nimport { fetchActiveWorkflows } from './workflow.service.js';\r\n\r\nexport type UpDocHasWorkflowsConditionConfig =\r\n\tUmbConditionConfigBase<'UpDoc.Condition.HasAvailableWorkflows'>;\r\n\r\n/**\r\n * Custom condition that checks whether the current content node has any\r\n * allowed child document types with complete UpDoc workflows.\r\n *\r\n * This is a per-node check: the \"Create Document from Source\" entity action\r\n * only appears on nodes where at least one allowed child type has a blueprint\r\n * with a complete workflow (destination + map + source).\r\n */\r\nexport class UpDocHasWorkflowsCondition\r\n\textends UmbConditionBase<UpDocHasWorkflowsConditionConfig>\r\n\timplements UmbExtensionCondition\r\n{\r\n\t#documentTypeStructureRepository = new UmbDocumentTypeStructureRepository(this);\r\n\t#blueprintItemRepository = new UmbDocumentBlueprintItemRepository(this);\r\n\t#documentItemRepository = new UmbDocumentItemRepository(this);\r\n\r\n\t#authContext: typeof UMB_AUTH_CONTEXT.TYPE | null = null;\r\n\t#entityUnique: string | null | undefined = undefined; // undefined = not yet received\r\n\r\n\tconstructor(\r\n\t\thost: UmbControllerHost,\r\n\t\targs: UmbConditionControllerArguments<UpDocHasWorkflowsConditionConfig>\r\n\t) {\r\n\t\tsuper(host, args);\r\n\r\n\t\tthis.consumeContext(UMB_AUTH_CONTEXT, (authContext) => {\r\n\t\t\tthis.#authContext = authContext;\r\n\t\t\tthis.#tryEvaluate();\r\n\t\t});\r\n\r\n\t\tthis.consumeContext(UMB_ENTITY_CONTEXT, (entityContext) => {\r\n\t\t\tif (!entityContext) return;\r\n\t\t\tthis.observe(entityContext.unique, (unique) => {\r\n\t\t\t\tthis.#entityUnique = unique ?? null;\r\n\t\t\t\tthis.#tryEvaluate();\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\t#tryEvaluate() {\r\n\t\tif (this.#authContext && this.#entityUnique !== undefined) {\r\n\t\t\tthis.#evaluate(this.#authContext, this.#entityUnique);\r\n\t\t}\r\n\t}\r\n\r\n\tasync #evaluate(authContext: typeof UMB_AUTH_CONTEXT.TYPE, entityUnique: string | null) {\r\n\t\ttry {\r\n\t\t\tconst token = await authContext.getLatestToken();\r\n\t\t\tconst activeWorkflows = await fetchActiveWorkflows(token);\r\n\r\n\t\t\t// Quick exit: no complete workflows anywhere\r\n\t\t\tif (!activeWorkflows.blueprintIds.length) {\r\n\t\t\t\tthis.permitted = false;\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tconst activeBlueprintIds = new Set(activeWorkflows.blueprintIds);\r\n\r\n\t\t\t// Get the entity's document type\r\n\t\t\tlet parentDocTypeUnique: string | null = null;\r\n\t\t\tif (entityUnique) {\r\n\t\t\t\tconst { data: parentItems } = await this.#documentItemRepository.requestItems([entityUnique]);\r\n\t\t\t\tif (parentItems?.length) {\r\n\t\t\t\t\tparentDocTypeUnique = parentItems[0].documentType.unique;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t// Get allowed child document types for this node\r\n\t\t\tconst result = await this.#documentTypeStructureRepository.requestAllowedChildrenOf(\r\n\t\t\t\tparentDocTypeUnique,\r\n\t\t\t\tentityUnique\r\n\t\t\t);\r\n\t\t\tconst allowedTypes = result.data;\r\n\r\n\t\t\tif (!allowedTypes?.items?.length) {\r\n\t\t\t\tthis.permitted = false;\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\t// Check if any allowed child type has a blueprint with a complete workflow\r\n\t\t\tfor (const docType of allowedTypes.items) {\r\n\t\t\t\tconst { data: blueprints } = await this.#blueprintItemRepository.requestItemsByDocumentType(docType.unique);\r\n\t\t\t\tif (blueprints?.some((bp) => activeBlueprintIds.has(bp.unique))) {\r\n\t\t\t\t\tthis.permitted = true;\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tthis.permitted = false;\r\n\t\t} catch {\r\n\t\t\tthis.permitted = false;\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport default UpDocHasWorkflowsCondition;\r\n\r\ndeclare global {\r\n\tinterface UmbExtensionConditionConfigMap {\r\n\t\tUpDocHasWorkflowsConditionConfig: UpDocHasWorkflowsConditionConfig;\r\n\t}\r\n}\r\n"],"names":["UpDocHasWorkflowsCondition","UmbConditionBase","host","args","__privateAdd","_UpDocHasWorkflowsCondition_instances","_documentTypeStructureRepository","UmbDocumentTypeStructureRepository","_blueprintItemRepository","UmbDocumentBlueprintItemRepository","_documentItemRepository","UmbDocumentItemRepository","_authContext","_entityUnique","UMB_AUTH_CONTEXT","authContext","__privateSet","__privateMethod","tryEvaluate_fn","UMB_ENTITY_CONTEXT","entityContext","unique","__privateGet","evaluate_fn","entityUnique","token","activeWorkflows","fetchActiveWorkflows","activeBlueprintIds","parentDocTypeUnique","parentItems","allowedTypes","_a","docType","blueprints","bp"],"mappings":";;;;;;;;;;;;;AAyBO,MAAMA,UACJC,EAET;AAAA;AAAA,EAQC,YACCC,GACAC,GACC;AACD,UAAMD,GAAMC,CAAI;AAfX,IAAAC,EAAA,MAAAC;AAIN,IAAAD,EAAA,MAAAE,GAAmC,IAAIC,EAAmC,IAAI;AAC9E,IAAAH,EAAA,MAAAI,GAA2B,IAAIC,EAAmC,IAAI;AACtE,IAAAL,EAAA,MAAAM,GAA0B,IAAIC,EAA0B,IAAI;AAE5D,IAAAP,EAAA,MAAAQ,GAAoD;AACpD,IAAAR,EAAA,MAAAS;AAQC,SAAK,eAAeC,GAAkB,CAACC,MAAgB;AACtD,MAAAC,EAAA,MAAKJ,GAAeG,IACpBE,EAAA,MAAKZ,GAAAa,GAAL;AAAA,IACD,CAAC,GAED,KAAK,eAAeC,GAAoB,CAACC,MAAkB;AAC1D,MAAKA,KACL,KAAK,QAAQA,EAAc,QAAQ,CAACC,MAAW;AAC9C,QAAAL,EAAA,MAAKH,GAAgBQ,KAAU,OAC/BJ,EAAA,MAAKZ,GAAAa,GAAL;AAAA,MACD,CAAC;AAAA,IACF,CAAC;AAAA,EACF;AAwDD;AAjFCZ,IAAA,eACAE,IAAA,eACAE,IAAA,eAEAE,IAAA,eACAC,IAAA,eATMR,IAAA,eA+BNa,IAAA,WAAe;AACd,EAAII,EAAA,MAAKV,MAAgBU,EAAA,MAAKT,OAAkB,UAC/CI,EAAA,MAAKZ,GAAAkB,GAAL,WAAeD,EAAA,MAAKV,IAAcU,EAAA,MAAKT;AAEzC,GAEMU,IAAA,eAAUR,GAA2CS,GAA6B;;AACvF,MAAI;AACH,UAAMC,IAAQ,MAAMV,EAAY,eAAA,GAC1BW,IAAkB,MAAMC,EAAqBF,CAAK;AAGxD,QAAI,CAACC,EAAgB,aAAa,QAAQ;AACzC,WAAK,YAAY;AACjB;AAAA,IACD;AAEA,UAAME,IAAqB,IAAI,IAAIF,EAAgB,YAAY;AAG/D,QAAIG,IAAqC;AACzC,QAAIL,GAAc;AACjB,YAAM,EAAE,MAAMM,MAAgB,MAAMR,EAAA,MAAKZ,GAAwB,aAAa,CAACc,CAAY,CAAC;AAC5F,MAAIM,KAAA,QAAAA,EAAa,WAChBD,IAAsBC,EAAY,CAAC,EAAE,aAAa;AAAA,IAEpD;AAOA,UAAMC,KAJS,MAAMT,EAAA,MAAKhB,GAAiC;AAAA,MAC1DuB;AAAA,MACAL;AAAA,IAAA,GAE2B;AAE5B,QAAI,GAACQ,IAAAD,KAAA,gBAAAA,EAAc,UAAd,QAAAC,EAAqB,SAAQ;AACjC,WAAK,YAAY;AACjB;AAAA,IACD;AAGA,eAAWC,KAAWF,EAAa,OAAO;AACzC,YAAM,EAAE,MAAMG,MAAe,MAAMZ,EAAA,MAAKd,GAAyB,2BAA2ByB,EAAQ,MAAM;AAC1G,UAAIC,KAAA,QAAAA,EAAY,KAAK,CAACC,MAAOP,EAAmB,IAAIO,EAAG,MAAM,IAAI;AAChE,aAAK,YAAY;AACjB;AAAA,MACD;AAAA,IACD;AAEA,SAAK,YAAY;AAAA,EAClB,QAAQ;AACP,SAAK,YAAY;AAAA,EAClB;AACD;"}