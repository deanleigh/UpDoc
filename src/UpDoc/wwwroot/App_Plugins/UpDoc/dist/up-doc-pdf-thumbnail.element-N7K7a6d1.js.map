{"version":3,"file":"up-doc-pdf-thumbnail.element-N7K7a6d1.js","sources":["../src/up-doc-pdf-thumbnail.element.ts"],"sourcesContent":["import { html, customElement, css, property, state } from '@umbraco-cms/backoffice/external/lit';\r\nimport { UmbLitElement } from '@umbraco-cms/backoffice/lit-element';\r\nimport * as pdfjsLib from 'pdfjs-dist';\r\nimport type { RenderTask } from 'pdfjs-dist';\r\n\r\n// Configure PDF.js worker (same path as zone editor)\r\npdfjsLib.GlobalWorkerOptions.workerSrc = '/App_Plugins/UpDoc/dist/pdf.worker.min.mjs';\r\n\r\n// Simple in-memory cache: mediaKey → PDFDocumentProxy\r\nconst pdfCache = new Map<string, pdfjsLib.PDFDocumentProxy>();\r\n\r\n/**\r\n * Renders a single PDF page as an image thumbnail using PDF.js.\r\n * Renders to an offscreen canvas, then converts to a data URL so the\r\n * result is a standard <img> that works anywhere (uui-card-media, etc.).\r\n *\r\n * Usage:\r\n *   <up-doc-pdf-thumbnail mediaKey=\"guid\" page=\"1\" width=\"300\" token=\"bearer-token\"></up-doc-pdf-thumbnail>\r\n */\r\n@customElement('up-doc-pdf-thumbnail')\r\nexport class UpDocPdfThumbnailElement extends UmbLitElement {\r\n\t/** Umbraco media item GUID */\r\n\t@property({ type: String }) mediaKey = '';\r\n\r\n\t/** Page number to render (1-based) */\r\n\t@property({ type: Number }) page = 1;\r\n\r\n\t/** Thumbnail width in pixels */\r\n\t@property({ type: Number }) width = 300;\r\n\r\n\t/** Auth token for fetching the PDF */\r\n\t@property({ type: String }) token = '';\r\n\r\n\t@state() private _loading = true;\r\n\t@state() private _error = '';\r\n\t@state() private _imageUrl = '';\r\n\r\n\tprivate _currentRenderTask: RenderTask | null = null;\r\n\tprivate _rendering = false;\r\n\r\n\toverride updated(changedProperties: Map<string, unknown>) {\r\n\t\tsuper.updated(changedProperties);\r\n\r\n\t\t// Only re-render when key inputs change, not on internal state changes\r\n\t\tif (\r\n\t\t\tchangedProperties.has('mediaKey') ||\r\n\t\t\tchangedProperties.has('page') ||\r\n\t\t\tchangedProperties.has('token')\r\n\t\t) {\r\n\t\t\tthis.#renderPage();\r\n\t\t}\r\n\t}\r\n\r\n\tasync #renderPage() {\r\n\t\tif (!this.mediaKey || !this.token) return;\r\n\r\n\t\t// Cancel any in-progress render\r\n\t\tif (this._currentRenderTask) {\r\n\t\t\tthis._currentRenderTask.cancel();\r\n\t\t\tthis._currentRenderTask = null;\r\n\t\t}\r\n\r\n\t\t// Guard against concurrent calls\r\n\t\tif (this._rendering) return;\r\n\t\tthis._rendering = true;\r\n\r\n\t\tthis._loading = true;\r\n\t\tthis._error = '';\r\n\r\n\t\ttry {\r\n\t\t\tconst pdfDoc = await this.#loadPdf();\r\n\t\t\tif (!pdfDoc) {\r\n\t\t\t\tthis._rendering = false;\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tif (this.page < 1 || this.page > pdfDoc.numPages) {\r\n\t\t\t\tthis._error = `Page ${this.page} out of range (1-${pdfDoc.numPages})`;\r\n\t\t\t\tthis._loading = false;\r\n\t\t\t\tthis._rendering = false;\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tconst pdfPage = await pdfDoc.getPage(this.page);\r\n\t\t\tconst unscaledViewport = pdfPage.getViewport({ scale: 1 });\r\n\t\t\tconst scale = this.width / unscaledViewport.width;\r\n\t\t\tconst viewport = pdfPage.getViewport({ scale });\r\n\r\n\t\t\t// Render to an offscreen canvas\r\n\t\t\tconst offscreen = document.createElement('canvas');\r\n\t\t\toffscreen.width = viewport.width;\r\n\t\t\toffscreen.height = viewport.height;\r\n\r\n\t\t\tconst ctx = offscreen.getContext('2d');\r\n\t\t\tif (!ctx) {\r\n\t\t\t\tthis._rendering = false;\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tthis._currentRenderTask = pdfPage.render({ canvasContext: ctx, viewport });\r\n\t\t\tawait this._currentRenderTask.promise;\r\n\t\t\tthis._currentRenderTask = null;\r\n\r\n\t\t\t// Convert to data URL — now it's just a regular image\r\n\t\t\tthis._imageUrl = offscreen.toDataURL('image/png');\r\n\t\t} catch (err: unknown) {\r\n\t\t\t// Ignore cancellation errors\r\n\t\t\tif (err instanceof Error && err.message?.includes('cancelled')) {\r\n\t\t\t\t// Render was cancelled — a new render will follow\r\n\t\t\t} else {\r\n\t\t\t\tthis._error = 'Failed to render PDF page';\r\n\t\t\t\tconsole.error('PDF thumbnail render error:', err);\r\n\t\t\t}\r\n\t\t} finally {\r\n\t\t\tthis._loading = false;\r\n\t\t\tthis._rendering = false;\r\n\t\t}\r\n\t}\r\n\r\n\tasync #loadPdf(): Promise<pdfjsLib.PDFDocumentProxy | null> {\r\n\t\t// Check cache first\r\n\t\tconst cached = pdfCache.get(this.mediaKey);\r\n\t\tif (cached) return cached;\r\n\r\n\t\ttry {\r\n\t\t\tconst response = await fetch(\r\n\t\t\t\t`/umbraco/management/api/v1/updoc/workflows/media-pdf?mediaKey=${this.mediaKey}`,\r\n\t\t\t\t{\r\n\t\t\t\t\theaders: { Authorization: `Bearer ${this.token}` },\r\n\t\t\t\t}\r\n\t\t\t);\r\n\r\n\t\t\tif (!response.ok) {\r\n\t\t\t\tthis._error = 'Could not load PDF';\r\n\t\t\t\treturn null;\r\n\t\t\t}\r\n\r\n\t\t\tconst arrayBuffer = await response.arrayBuffer();\r\n\t\t\tconst loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });\r\n\t\t\tconst pdfDoc = await loadingTask.promise;\r\n\r\n\t\t\tpdfCache.set(this.mediaKey, pdfDoc);\r\n\t\t\treturn pdfDoc;\r\n\t\t} catch {\r\n\t\t\tthis._error = 'Could not load PDF';\r\n\t\t\treturn null;\r\n\t\t}\r\n\t}\r\n\r\n\toverride render() {\r\n\t\tif (this._error) {\r\n\t\t\treturn html`<div class=\"error\"><umb-icon name=\"icon-alert\"></umb-icon> ${this._error}</div>`;\r\n\t\t}\r\n\r\n\t\tif (this._loading) {\r\n\t\t\treturn html`<uui-loader-bar></uui-loader-bar>`;\r\n\t\t}\r\n\r\n\t\treturn html`<img src=${this._imageUrl} alt=\"PDF page ${this.page}\" />`;\r\n\t}\r\n\r\n\tstatic override styles = [\r\n\t\tcss`\r\n\t\t\t:host {\r\n\t\t\t\tdisplay: block;\r\n\t\t\t}\r\n\r\n\t\t\timg {\r\n\t\t\t\tdisplay: block;\r\n\t\t\t\twidth: 100%;\r\n\t\t\t\theight: auto;\r\n\t\t\t\tborder-radius: var(--uui-border-radius);\r\n\t\t\t}\r\n\r\n\t\t\t.error {\r\n\t\t\t\tdisplay: flex;\r\n\t\t\t\talign-items: center;\r\n\t\t\t\tgap: var(--uui-size-space-2);\r\n\t\t\t\tcolor: var(--uui-color-danger);\r\n\t\t\t\tfont-size: var(--uui-type-small-size);\r\n\t\t\t}\r\n\t\t`,\r\n\t];\r\n}\r\n\r\nexport default UpDocPdfThumbnailElement;\r\n\r\ndeclare global {\r\n\tinterface HTMLElementTagNameMap {\r\n\t\t'up-doc-pdf-thumbnail': UpDocPdfThumbnailElement;\r\n\t}\r\n}\r\n"],"names":["_UpDocPdfThumbnailElement_instances","renderPage_fn","loadPdf_fn","pdfjsLib.GlobalWorkerOptions","pdfCache","UpDocPdfThumbnailElement","UmbLitElement","__privateAdd","changedProperties","__privateMethod","html","pdfDoc","pdfPage","unscaledViewport","scale","viewport","offscreen","ctx","err","cached","response","arrayBuffer","pdfjsLib.getDocument","css","__decorateClass","property","state","customElement"],"mappings":"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"}