{"version":3,"file":"up-doc-action-B69TsjaD.js","sources":["../src/up-doc-action.ts"],"sourcesContent":["import { UMB_UP_DOC_MODAL } from './up-doc-modal.token.js';\r\nimport { UMB_BLUEPRINT_PICKER_MODAL } from './blueprint-picker-modal.token.js';\r\nimport type { DocumentTypeOption } from './blueprint-picker-modal.token.js';\r\nimport type { DocumentTypeConfig, MappingDestination } from './workflow.types.js';\r\nimport { fetchActiveWorkflows } from './workflow.service.js';\r\nimport { markdownToHtml, buildRteValue, stripMarkdown } from './transforms.js';\r\nimport { UmbEntityActionBase } from '@umbraco-cms/backoffice/entity-action';\r\nimport { umbOpenModal } from '@umbraco-cms/backoffice/modal';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport type { UmbEntityActionArgs } from '@umbraco-cms/backoffice/entity-action';\r\nimport { UMB_NOTIFICATION_CONTEXT } from '@umbraco-cms/backoffice/notification';\r\nimport { UMB_AUTH_CONTEXT } from '@umbraco-cms/backoffice/auth';\r\nimport { UmbDocumentTypeStructureRepository } from '@umbraco-cms/backoffice/document-type';\r\nimport { UmbDocumentBlueprintItemRepository } from '@umbraco-cms/backoffice/document-blueprint';\r\nimport { UmbDocumentItemRepository } from '@umbraco-cms/backoffice/document';\r\n\r\nexport class UpDocEntityAction extends UmbEntityActionBase<never> {\r\n\t#documentTypeStructureRepository = new UmbDocumentTypeStructureRepository(this);\r\n\t#blueprintItemRepository = new UmbDocumentBlueprintItemRepository(this);\r\n\t#documentItemRepository = new UmbDocumentItemRepository(this);\r\n\r\n\tconstructor(host: UmbControllerHost, args: UmbEntityActionArgs<never>) {\r\n\t\tsuper(host, args);\r\n\t}\r\n\r\n\toverride async execute() {\r\n\t\tconst notificationContext = await this.getContext(UMB_NOTIFICATION_CONTEXT);\r\n\t\tconst parentUnique = this.args.unique ?? null;\r\n\r\n\t\ttry {\r\n\t\t\t// Step 1: Get the parent document's document type\r\n\t\t\tlet parentDocTypeUnique: string | null = null;\r\n\r\n\t\t\tif (parentUnique) {\r\n\t\t\t\tconst { data: parentItems } = await this.#documentItemRepository.requestItems([parentUnique]);\r\n\t\t\t\tif (parentItems?.length) {\r\n\t\t\t\t\tparentDocTypeUnique = parentItems[0].documentType.unique;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t// Step 2: Get allowed child document types\r\n\t\t\tconst result = await this.#documentTypeStructureRepository.requestAllowedChildrenOf(\r\n\t\t\t\tparentDocTypeUnique,\r\n\t\t\t\tparentUnique\r\n\t\t\t);\r\n\t\t\tconst allowedTypes = result.data;\r\n\r\n\t\t\tif (!allowedTypes?.items?.length) {\r\n\t\t\t\tnotificationContext.peek('danger', {\r\n\t\t\t\t\tdata: { message: 'No document types are allowed as children of this page.' },\r\n\t\t\t\t});\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\t// Step 3: Discover blueprints for allowed child types, grouped by document type\r\n\t\t\tconst authContext = await this.getContext(UMB_AUTH_CONTEXT);\r\n\t\t\tconst token = await authContext.getLatestToken();\r\n\r\n\t\t\t// Fetch active workflows to filter blueprints\r\n\t\t\tconst activeWorkflows = await fetchActiveWorkflows(token);\r\n\t\t\tconst activeBlueprintIds = new Set(activeWorkflows.blueprintIds);\r\n\r\n\t\t\tconst documentTypeOptions: DocumentTypeOption[] = [];\r\n\r\n\t\t\tfor (const docType of allowedTypes.items) {\r\n\t\t\t\tconst { data: blueprints } = await this.#blueprintItemRepository.requestItemsByDocumentType(docType.unique);\r\n\t\t\t\tif (blueprints?.length) {\r\n\t\t\t\t\t// Only include blueprints that have complete workflows\r\n\t\t\t\t\tconst workflowBlueprints = blueprints.filter((bp) => activeBlueprintIds.has(bp.unique));\r\n\t\t\t\t\tif (workflowBlueprints.length) {\r\n\t\t\t\t\t\tdocumentTypeOptions.push({\r\n\t\t\t\t\t\t\tdocumentTypeUnique: docType.unique,\r\n\t\t\t\t\t\t\tdocumentTypeName: docType.name,\r\n\t\t\t\t\t\t\tdocumentTypeIcon: (docType as { icon?: string }).icon ?? null,\r\n\t\t\t\t\t\t\tblueprints: workflowBlueprints.map((bp) => ({\r\n\t\t\t\t\t\t\t\tblueprintUnique: bp.unique,\r\n\t\t\t\t\t\t\t\tblueprintName: bp.name,\r\n\t\t\t\t\t\t\t})),\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (!documentTypeOptions.length) {\r\n\t\t\t\tnotificationContext.peek('warning', {\r\n\t\t\t\t\tdata: { message: 'No workflows are configured for the document types allowed here.' },\r\n\t\t\t\t});\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\t// Step 4: Open blueprint picker dialog (doc type → blueprint selection)\r\n\t\t\tlet blueprintSelection;\r\n\t\t\ttry {\r\n\t\t\t\tblueprintSelection = await umbOpenModal(this, UMB_BLUEPRINT_PICKER_MODAL, {\r\n\t\t\t\t\tdata: { documentTypes: documentTypeOptions },\r\n\t\t\t\t});\r\n\t\t\t} catch {\r\n\t\t\t\t// Dialog was cancelled\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tconst { blueprintUnique, documentTypeUnique } = blueprintSelection;\r\n\t\t\tconst selectedDocType = documentTypeOptions.find((dt) => dt.documentTypeUnique === documentTypeUnique);\r\n\t\t\tconst selectedBlueprint = selectedDocType?.blueprints.find((bp) => bp.blueprintUnique === blueprintUnique);\r\n\r\n\t\t\t// Step 5: Open source sidebar modal (passes blueprintId for map file lookup)\r\n\t\t\tlet modalValue;\r\n\t\t\ttry {\r\n\t\t\t\tmodalValue = await umbOpenModal(this, UMB_UP_DOC_MODAL, {\r\n\t\t\t\t\tdata: {\r\n\t\t\t\t\t\tunique: parentUnique,\r\n\t\t\t\t\t\tdocumentTypeName: selectedDocType?.documentTypeName ?? '',\r\n\t\t\t\t\t\tblueprintName: selectedBlueprint?.blueprintName ?? '',\r\n\t\t\t\t\t\tblueprintId: blueprintUnique,\r\n\t\t\t\t\t},\r\n\t\t\t\t});\r\n\t\t\t} catch {\r\n\t\t\t\t// Modal was cancelled\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tconst { name, mediaUnique, sourceUrl, sectionLookup, config } = modalValue;\r\n\r\n\t\t\t// Web source uses URL (no media), others need media key\r\n\t\t\tif (!name || !config) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tif (!mediaUnique && !sourceUrl) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\t// Step 6: Scaffold from the selected blueprint\r\n\t\t\tconst scaffoldResponse = await fetch(\r\n\t\t\t\t`/umbraco/management/api/v1/document-blueprint/${blueprintUnique}/scaffold`,\r\n\t\t\t\t{\r\n\t\t\t\t\tmethod: 'GET',\r\n\t\t\t\t\theaders: {\r\n\t\t\t\t\t\t'Content-Type': 'application/json',\r\n\t\t\t\t\t\tAuthorization: `Bearer ${token}`,\r\n\t\t\t\t\t},\r\n\t\t\t\t}\r\n\t\t\t);\r\n\r\n\t\t\tif (!scaffoldResponse.ok) {\r\n\t\t\t\tconst error = await scaffoldResponse.json();\r\n\t\t\t\tconsole.error('Scaffold failed:', error);\r\n\t\t\t\tnotificationContext.peek('danger', {\r\n\t\t\t\t\tdata: { message: `Failed to scaffold from blueprint: ${error.title || 'Unknown error'}` },\r\n\t\t\t\t});\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tconst scaffold = await scaffoldResponse.json();\r\n\r\n\t\t\t// Step 7: Apply property mappings from the map file\r\n\t\t\t// Deep clone to avoid modifying the original scaffold\r\n\t\t\tconst values: Array<{ alias: string; value: unknown }> = scaffold.values\r\n\t\t\t\t? JSON.parse(JSON.stringify(scaffold.values))\r\n\t\t\t\t: [];\r\n\r\n\t\t\t// Track which fields have been written by our mappings.\r\n\t\t\t// First write replaces the blueprint default; subsequent writes concatenate.\r\n\t\t\tconst mappedFields = new Set<string>();\r\n\r\n\t\t\t// Apply each mapping from the config\r\n\t\t\tfor (const mapping of config.map.mappings) {\r\n\t\t\t\tif (mapping.enabled === false) continue;\r\n\r\n\t\t\t\tconst sectionValue = sectionLookup[mapping.source];\r\n\t\t\t\tif (!sectionValue) continue;\r\n\r\n\t\t\t\tfor (const dest of mapping.destinations) {\r\n\t\t\t\t\tthis.#applyDestinationMapping(values, dest, sectionValue, config, mappedFields);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t// Convert richText fields: markdown → HTML → RTE value object.\r\n\t\t\t// Done as a post-mapping pass so concatenation happens on raw strings first.\r\n\t\t\tthis.#convertRichTextFields(values, config, mappedFields);\r\n\r\n\t\t\t// Build the create request\r\n\t\t\tconst createRequest = {\r\n\t\t\t\tparent: parentUnique ? { id: parentUnique } : null,\r\n\t\t\t\tdocumentType: { id: documentTypeUnique },\r\n\t\t\t\ttemplate: scaffold.template ? { id: scaffold.template.id } : null,\r\n\t\t\t\tvalues,\r\n\t\t\t\tvariants: [\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tname,\r\n\t\t\t\t\t\tculture: null,\r\n\t\t\t\t\t\tsegment: null,\r\n\t\t\t\t\t},\r\n\t\t\t\t],\r\n\t\t\t};\r\n\r\n\t\t\t// Step 8: Create the document\r\n\t\t\tconst createResponse = await fetch('/umbraco/management/api/v1/document', {\r\n\t\t\t\tmethod: 'POST',\r\n\t\t\t\theaders: {\r\n\t\t\t\t\t'Content-Type': 'application/json',\r\n\t\t\t\t\tAuthorization: `Bearer ${token}`,\r\n\t\t\t\t},\r\n\t\t\t\tbody: JSON.stringify(createRequest),\r\n\t\t\t});\r\n\r\n\t\t\tif (!createResponse.ok) {\r\n\t\t\t\tconst error = await createResponse.json();\r\n\t\t\t\tconsole.error('Document creation failed:', error);\r\n\t\t\t\tnotificationContext.peek('danger', {\r\n\t\t\t\t\tdata: { message: `Failed to create document: ${error.title || error.detail || 'Unknown error'}` },\r\n\t\t\t\t});\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\t// Success!\r\n\t\t\tconst locationHeader = createResponse.headers.get('Location');\r\n\t\t\tconst newDocumentId = locationHeader?.split('/').pop();\r\n\r\n\t\t\t// Step 9: Save the document to properly persist it and trigger cache updates\r\n\t\t\tif (newDocumentId) {\r\n\t\t\t\tconst getResponse = await fetch(`/umbraco/management/api/v1/document/${newDocumentId}`, {\r\n\t\t\t\t\tmethod: 'GET',\r\n\t\t\t\t\theaders: {\r\n\t\t\t\t\t\t'Content-Type': 'application/json',\r\n\t\t\t\t\t\tAuthorization: `Bearer ${token}`,\r\n\t\t\t\t\t},\r\n\t\t\t\t});\r\n\r\n\t\t\t\tif (getResponse.ok) {\r\n\t\t\t\t\tconst documentData = await getResponse.json();\r\n\r\n\t\t\t\t\tconst saveResponse = await fetch(`/umbraco/management/api/v1/document/${newDocumentId}`, {\r\n\t\t\t\t\t\tmethod: 'PUT',\r\n\t\t\t\t\t\theaders: {\r\n\t\t\t\t\t\t\t'Content-Type': 'application/json',\r\n\t\t\t\t\t\t\tAuthorization: `Bearer ${token}`,\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tbody: JSON.stringify(documentData),\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t\tif (!saveResponse.ok) {\r\n\t\t\t\t\t\tconsole.warn('Document save failed, but document was created:', await saveResponse.text());\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconsole.warn('Could not fetch document for save:', await getResponse.text());\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tnotificationContext.peek('positive', {\r\n\t\t\t\tdata: { message: `Document \"${name}\" created successfully!` },\r\n\t\t\t});\r\n\r\n\t\t\t// Navigate to the new document after a short delay\r\n\t\t\tif (newDocumentId) {\r\n\t\t\t\tconst newPath = `/umbraco/section/content/workspace/document/edit/${newDocumentId}`;\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\twindow.location.href = newPath;\r\n\t\t\t\t}, 150);\r\n\t\t\t}\r\n\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error('Error creating document:', error);\r\n\t\t\tnotificationContext.peek('danger', {\r\n\t\t\t\tdata: { message: 'An unexpected error occurred while creating the document.' },\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Applies a single destination mapping from the config.\r\n\t * Handles both simple field mappings and block grid mappings.\r\n\t * mappedFields tracks which fields have been written by our mappings —\r\n\t * first write replaces the blueprint default, subsequent writes concatenate.\r\n\t */\r\n\t#applyDestinationMapping(\r\n\t\tvalues: Array<{ alias: string; value: unknown }>,\r\n\t\tdest: MappingDestination,\r\n\t\tsectionValue: string,\r\n\t\tconfig: DocumentTypeConfig,\r\n\t\tmappedFields: Set<string>\r\n\t) {\r\n\t\tconst transformedValue = sectionValue;\r\n\r\n\t\t// Block property with blockKey — find the specific block instance\r\n\t\tif (dest.blockKey) {\r\n\t\t\tfor (const container of [...(config.destination.blockGrids ?? []), ...(config.destination.blockLists ?? [])]) {\r\n\t\t\t\tconst block = container.blocks.find((b) => b.key === dest.blockKey);\r\n\t\t\t\tif (block) {\r\n\t\t\t\t\t// Match by contentTypeKey — Umbraco regenerates block instance keys when\r\n\t\t\t\t\t// creating documents from blueprints, so the blueprint key won't match.\r\n\t\t\t\t\t// contentTypeKey (element type GUID) is stable across all documents.\r\n\t\t\t\t\tconst contentTypeKey = block.contentTypeKey;\r\n\t\t\t\t\tif (contentTypeKey) {\r\n\t\t\t\t\t\tthis.#applyBlockValueByContentType(values, container.alias, contentTypeKey, dest.target, transformedValue, mappedFields);\r\n\t\t\t\t\t} else if (block.identifyBy) {\r\n\t\t\t\t\t\tthis.#applyBlockGridValue(values, container.alias, block.identifyBy, dest.target, transformedValue, mappedFields);\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tconsole.log(`Block ${dest.blockKey} not found in destination config`);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Parse the target path\r\n\t\tconst pathParts = dest.target.split('.');\r\n\r\n\t\tif (pathParts.length === 1) {\r\n\t\t\t// Simple field mapping: \"pageTitle\"\r\n\t\t\tconst alias = pathParts[0];\r\n\t\t\tconst existing = values.find((v) => v.alias === alias);\r\n\r\n\t\t\tif (existing) {\r\n\t\t\t\tif (mappedFields.has(alias)) {\r\n\t\t\t\t\t// Already written by a previous mapping — concatenate (e.g., title split across two lines)\r\n\t\t\t\t\tconst currentValue = typeof existing.value === 'string' ? existing.value : '';\r\n\t\t\t\t\texisting.value = `${currentValue} ${transformedValue}`;\r\n\t\t\t\t} else {\r\n\t\t\t\t\t// First write — replace the blueprint default\r\n\t\t\t\t\texisting.value = transformedValue;\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tvalues.push({ alias, value: transformedValue });\r\n\t\t\t}\r\n\t\t\tmappedFields.add(alias);\r\n\t\t} else if (pathParts.length === 3) {\r\n\t\t\t// Legacy dot-path: \"contentGrid.itineraryBlock.richTextContent\"\r\n\t\t\tconst [gridKey, blockKey, propertyKey] = pathParts;\r\n\r\n\t\t\t// Look up block info from destination config\r\n\t\t\tconst allContainers = [...(config.destination.blockGrids ?? []), ...(config.destination.blockLists ?? [])];\r\n\t\t\tconst blockGrid = allContainers.find((g) => g.key === gridKey);\r\n\t\t\tconst block = blockGrid?.blocks.find((b) => b.key === blockKey);\r\n\r\n\t\t\tif (!blockGrid || !block) return;\r\n\r\n\t\t\tconst gridAlias = blockGrid.alias;\r\n\t\t\tconst targetProperty = block.properties?.find((p) => p.key === propertyKey)?.alias ?? propertyKey;\r\n\t\t\tconst blockSearch = block.identifyBy;\r\n\r\n\t\t\tif (!blockSearch) return;\r\n\r\n\t\t\tthis.#applyBlockGridValue(values, gridAlias, blockSearch, targetProperty, transformedValue, mappedFields);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Applies a value to a property within a block grid.\r\n\t * Finds the block by searching for a property value match.\r\n\t * mappedFields tracks writes — first replaces blueprint default, subsequent concatenate.\r\n\t */\r\n\t#applyBlockGridValue(\r\n\t\tvalues: Array<{ alias: string; value: unknown }>,\r\n\t\tgridAlias: string,\r\n\t\tblockSearch: { property: string; value: string },\r\n\t\ttargetProperty: string,\r\n\t\tvalue: string,\r\n\t\tmappedFields: Set<string>\r\n\t) {\r\n\t\tconst contentGridValue = values.find((v) => v.alias === gridAlias);\r\n\t\tif (!contentGridValue || !contentGridValue.value) return;\r\n\r\n\t\ttry {\r\n\t\t\tconst wasString = typeof contentGridValue.value === 'string';\r\n\t\t\tconst contentGrid = wasString\r\n\t\t\t\t? JSON.parse(contentGridValue.value as string)\r\n\t\t\t\t: contentGridValue.value;\r\n\r\n\t\t\tconst contentData = contentGrid.contentData as Array<{\r\n\t\t\t\tcontentTypeKey: string;\r\n\t\t\t\tkey: string;\r\n\t\t\t\tvalues: Array<{ alias: string; value: unknown }>;\r\n\t\t\t}>;\r\n\r\n\t\t\tif (!contentData) return;\r\n\r\n\t\t\tfor (const block of contentData) {\r\n\t\t\t\tconst searchValue = block.values?.find((v) => v.alias === blockSearch.property);\r\n\r\n\t\t\t\tif (searchValue && typeof searchValue.value === 'string' &&\r\n\t\t\t\t\tsearchValue.value.toLowerCase().includes(blockSearch.value.toLowerCase())) {\r\n\r\n\t\t\t\t\tconst targetValue = block.values?.find((v) => v.alias === targetProperty);\r\n\t\t\t\t\tif (targetValue) {\r\n\t\t\t\t\t\tconst fieldKey = `${block.key}:${targetProperty}`;\r\n\r\n\t\t\t\t\t\tif (mappedFields.has(fieldKey)) {\r\n\t\t\t\t\t\t\tconst currentValue = typeof targetValue.value === 'string' ? targetValue.value : '';\r\n\t\t\t\t\t\t\ttargetValue.value = `${currentValue}\\n${value}`;\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\ttargetValue.value = value;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tmappedFields.add(fieldKey);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tcontentGridValue.value = wasString ? JSON.stringify(contentGrid) : contentGrid;\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error(`Failed to apply block mapping to ${gridAlias}:`, error);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Applies a value to a block property by matching the block's contentTypeKey in contentData.\r\n\t * Umbraco regenerates block instance keys when creating documents from blueprints,\r\n\t * so we match by element type GUID (contentTypeKey) which is stable across all documents.\r\n\t */\r\n\t#applyBlockValueByContentType(\r\n\t\tvalues: Array<{ alias: string; value: unknown }>,\r\n\t\tcontainerAlias: string,\r\n\t\tcontentTypeKey: string,\r\n\t\ttargetProperty: string,\r\n\t\tvalue: string,\r\n\t\tmappedFields: Set<string>\r\n\t) {\r\n\t\tconst containerValue = values.find((v) => v.alias === containerAlias);\r\n\t\tif (!containerValue || !containerValue.value) return;\r\n\r\n\t\ttry {\r\n\t\t\tconst wasString = typeof containerValue.value === 'string';\r\n\t\t\tconst containerData = wasString\r\n\t\t\t\t? JSON.parse(containerValue.value as string)\r\n\t\t\t\t: containerValue.value;\r\n\r\n\t\t\tconst contentData = containerData.contentData as Array<{\r\n\t\t\t\tcontentTypeKey: string;\r\n\t\t\t\tkey: string;\r\n\t\t\t\tvalues: Array<{ alias: string; value: unknown }>;\r\n\t\t\t}>;\r\n\r\n\t\t\tif (!contentData) return;\r\n\r\n\t\t\tconst block = contentData.find((b) => b.contentTypeKey === contentTypeKey);\r\n\t\t\tif (!block) return;\r\n\r\n\t\t\tconst targetValue = block.values?.find((v) => v.alias === targetProperty);\r\n\t\t\tif (targetValue) {\r\n\t\t\t\tconst fieldKey = `${block.key}:${targetProperty}`;\r\n\r\n\t\t\t\tif (mappedFields.has(fieldKey)) {\r\n\t\t\t\t\tconst currentValue = typeof targetValue.value === 'string' ? targetValue.value : '';\r\n\t\t\t\t\ttargetValue.value = `${currentValue}\\n${value}`;\r\n\t\t\t\t} else {\r\n\t\t\t\t\ttargetValue.value = value;\r\n\t\t\t\t}\r\n\t\t\t\tmappedFields.add(fieldKey);\r\n\t\t\t}\r\n\r\n\t\t\tcontainerValue.value = wasString ? JSON.stringify(containerData) : containerData;\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error(`Failed to apply block mapping by content type to ${containerAlias}:`, error);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Post-mapping pass: strips markdown from plain text fields and converts richText fields\r\n\t * from markdown to HTML + RTE value object.\r\n\t * Uses destination.json field types to auto-detect which fields need conversion.\r\n\t * Only converts fields that were written by our mappings (tracked by mappedFields).\r\n\t */\r\n\t#convertRichTextFields(\r\n\t\tvalues: Array<{ alias: string; value: unknown }>,\r\n\t\tconfig: DocumentTypeConfig,\r\n\t\tmappedFields: Set<string>\r\n\t) {\r\n\t\t// Strip markdown from plain text fields (text, textArea)\r\n\t\tfor (const field of config.destination.fields) {\r\n\t\t\tif ((field.type === 'text' || field.type === 'textArea') && mappedFields.has(field.alias)) {\r\n\t\t\t\tconst val = values.find((v) => v.alias === field.alias);\r\n\t\t\t\tif (val && typeof val.value === 'string') {\r\n\t\t\t\t\tval.value = stripMarkdown(val.value);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// Convert top-level richText fields\r\n\t\tfor (const field of config.destination.fields) {\r\n\t\t\tif (field.type === 'richText' && mappedFields.has(field.alias)) {\r\n\t\t\t\tconst val = values.find((v) => v.alias === field.alias);\r\n\t\t\t\tif (val && typeof val.value === 'string') {\r\n\t\t\t\t\tval.value = buildRteValue(markdownToHtml(val.value));\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// Convert block container (grid + list) richText properties\r\n\t\tconst allContainers = [...(config.destination.blockGrids ?? []), ...(config.destination.blockLists ?? [])];\r\n\t\tfor (const container of allContainers) {\r\n\t\t\tconst containerVal = values.find((v) => v.alias === container.alias);\r\n\t\t\tif (!containerVal?.value) continue;\r\n\r\n\t\t\tconst wasString = typeof containerVal.value === 'string';\r\n\t\t\tconst containerData = wasString ? JSON.parse(containerVal.value as string) : containerVal.value;\r\n\t\t\tconst contentData = containerData.contentData as Array<{\r\n\t\t\t\tkey: string;\r\n\t\t\t\tvalues: Array<{ alias: string; value: unknown }>;\r\n\t\t\t}> | undefined;\r\n\t\t\tif (!contentData) continue;\r\n\r\n\t\t\tfor (const block of contentData) {\r\n\t\t\t\tfor (const destBlock of container.blocks) {\r\n\t\t\t\t\t// Match by identifyBy text search, or by key directly for blocks without identifyBy\r\n\t\t\t\t\tconst matched = destBlock.identifyBy\r\n\t\t\t\t\t\t? (() => {\r\n\t\t\t\t\t\t\t\tconst searchVal = block.values?.find((v) => v.alias === destBlock.identifyBy!.property);\r\n\t\t\t\t\t\t\t\treturn searchVal &&\r\n\t\t\t\t\t\t\t\t\ttypeof searchVal.value === 'string' &&\r\n\t\t\t\t\t\t\t\t\tsearchVal.value.toLowerCase().includes(destBlock.identifyBy!.value.toLowerCase());\r\n\t\t\t\t\t\t\t})()\r\n\t\t\t\t\t\t: block.key === destBlock.key;\r\n\r\n\t\t\t\t\tif (matched) {\r\n\t\t\t\t\t\tfor (const prop of destBlock.properties ?? []) {\r\n\t\t\t\t\t\t\tconst fieldKey = `${block.key}:${prop.alias}`;\r\n\t\t\t\t\t\t\tif ((prop.type === 'text' || prop.type === 'textArea') && mappedFields.has(fieldKey)) {\r\n\t\t\t\t\t\t\t\tconst blockVal = block.values?.find((v) => v.alias === prop.alias);\r\n\t\t\t\t\t\t\t\tif (blockVal && typeof blockVal.value === 'string') {\r\n\t\t\t\t\t\t\t\t\tblockVal.value = stripMarkdown(blockVal.value);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tif (prop.type === 'richText' && mappedFields.has(fieldKey)) {\r\n\t\t\t\t\t\t\t\tconst blockVal = block.values?.find((v) => v.alias === prop.alias);\r\n\t\t\t\t\t\t\t\tif (blockVal && typeof blockVal.value === 'string') {\r\n\t\t\t\t\t\t\t\t\tblockVal.value = buildRteValue(markdownToHtml(blockVal.value as string));\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tcontainerVal.value = wasString ? JSON.stringify(containerData) : containerData;\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport default UpDocEntityAction;\r\n"],"names":["UpDocEntityAction","UmbEntityActionBase","#documentTypeStructureRepository","UmbDocumentTypeStructureRepository","#blueprintItemRepository","UmbDocumentBlueprintItemRepository","#documentItemRepository","UmbDocumentItemRepository","host","args","notificationContext","UMB_NOTIFICATION_CONTEXT","parentUnique","parentDocTypeUnique","parentItems","allowedTypes","token","UMB_AUTH_CONTEXT","activeWorkflows","fetchActiveWorkflows","activeBlueprintIds","documentTypeOptions","docType","blueprints","workflowBlueprints","bp","blueprintSelection","umbOpenModal","UMB_BLUEPRINT_PICKER_MODAL","blueprintUnique","documentTypeUnique","selectedDocType","dt","selectedBlueprint","modalValue","UMB_UP_DOC_MODAL","name","mediaUnique","sourceUrl","sectionLookup","config","scaffoldResponse","error","scaffold","values","mappedFields","mapping","sectionValue","dest","#applyDestinationMapping","#convertRichTextFields","createRequest","createResponse","newDocumentId","getResponse","documentData","saveResponse","newPath","transformedValue","container","block","b","contentTypeKey","#applyBlockValueByContentType","#applyBlockGridValue","pathParts","alias","existing","v","currentValue","gridKey","blockKey","propertyKey","blockGrid","gridAlias","targetProperty","p","blockSearch","value","contentGridValue","wasString","contentGrid","contentData","searchValue","targetValue","fieldKey","containerAlias","containerValue","containerData","field","val","stripMarkdown","buildRteValue","markdownToHtml","allContainers","containerVal","destBlock","searchVal","prop","blockVal"],"mappings":"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"}