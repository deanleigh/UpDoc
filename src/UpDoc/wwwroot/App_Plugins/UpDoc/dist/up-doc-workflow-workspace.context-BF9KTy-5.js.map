{"version":3,"file":"up-doc-workflow-workspace.context-BF9KTy-5.js","sources":["../src/up-doc-workflow-workspace.context.ts"],"sourcesContent":["import { UmbWorkspaceRouteManager, UMB_WORKSPACE_CONTEXT } from '@umbraco-cms/backoffice/workspace';\r\nimport { UmbObjectState } from '@umbraco-cms/backoffice/observable-api';\r\nimport type { UmbControllerHost } from '@umbraco-cms/backoffice/controller-api';\r\nimport { UmbContextBase } from '@umbraco-cms/backoffice/class-api';\r\nimport { UMB_AUTH_CONTEXT } from '@umbraco-cms/backoffice/auth';\r\nimport { html, css, state } from '@umbraco-cms/backoffice/external/lit';\r\nimport { customElement } from '@umbraco-cms/backoffice/external/lit';\r\nimport { UmbLitElement } from '@umbraco-cms/backoffice/lit-element';\r\nimport type { UmbInputWithAliasElement } from '@umbraco-cms/backoffice/components';\r\n\r\n@customElement('up-doc-workflow-workspace-editor')\r\nclass UpDocWorkflowWorkspaceEditorElement extends UmbLitElement {\r\n\t@state() private _name = '';\r\n\t@state() private _alias = '';\r\n\t@state() private _isNew = false;\r\n\t#ctx: UpDocWorkflowWorkspaceContext | null = null;\r\n\r\n\toverride connectedCallback() {\r\n\t\tsuper.connectedCallback();\r\n\t\tthis.consumeContext(UMB_WORKSPACE_CONTEXT, (context) => {\r\n\t\t\tif (!context) return;\r\n\t\t\tthis.#ctx = context as UpDocWorkflowWorkspaceContext;\r\n\t\t\tthis.observe(this.#ctx.name, (name: string) => {\r\n\t\t\t\tthis._name = name || 'Workflow';\r\n\t\t\t});\r\n\t\t\tthis.observe(this.#ctx.alias, (alias: string | undefined) => {\r\n\t\t\t\tthis._alias = alias || '';\r\n\t\t\t});\r\n\t\t\tthis.observe(this.#ctx.unique, (unique: string | undefined) => {\r\n\t\t\t\tif (unique) {\r\n\t\t\t\t\tthis.#fetchIdentity(decodeURIComponent(unique));\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tasync #fetchIdentity(workflowAlias: string) {\r\n\t\ttry {\r\n\t\t\tconst authContext = await this.getContext(UMB_AUTH_CONTEXT);\r\n\t\t\tconst token = await authContext.getLatestToken();\r\n\t\t\tconst response = await fetch('/umbraco/management/api/v1/updoc/workflows', {\r\n\t\t\t\theaders: { Authorization: `Bearer ${token}` },\r\n\t\t\t});\r\n\t\t\tif (response.ok) {\r\n\t\t\t\tconst summaries: Array<{ name: string; alias: string }> = await response.json();\r\n\t\t\t\tconst match = summaries.find((s) => s.alias === workflowAlias);\r\n\t\t\t\tif (match) {\r\n\t\t\t\t\tthis.#ctx?.setIdentity(match.name, match.alias);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} catch {\r\n\t\t\t// Fallback: keep alias as display name\r\n\t\t}\r\n\t}\r\n\r\n\tasync #onNameAndAliasChange(e: Event) {\r\n\t\tconst target = e.target as UmbInputWithAliasElement;\r\n\t\tconst newName = target.value as string;\r\n\t\tconst newAlias = target.alias;\r\n\r\n\t\tif (!newName.trim() || !newAlias.trim()) return;\r\n\t\tif (newName === this._name && newAlias === this._alias) return;\r\n\r\n\t\tconst currentAlias = this._alias;\r\n\r\n\t\ttry {\r\n\t\t\tconst authContext = await this.getContext(UMB_AUTH_CONTEXT);\r\n\t\t\tconst token = await authContext.getLatestToken();\r\n\r\n\t\t\tconst response = await fetch(\r\n\t\t\t\t`/umbraco/management/api/v1/updoc/workflows/${encodeURIComponent(currentAlias)}/identity`,\r\n\t\t\t\t{\r\n\t\t\t\t\tmethod: 'PUT',\r\n\t\t\t\t\theaders: {\r\n\t\t\t\t\t\t'Content-Type': 'application/json',\r\n\t\t\t\t\t\tAuthorization: `Bearer ${token}`,\r\n\t\t\t\t\t},\r\n\t\t\t\t\tbody: JSON.stringify({ name: newName.trim(), alias: newAlias.trim() }),\r\n\t\t\t\t},\r\n\t\t\t);\r\n\r\n\t\t\tif (!response.ok) {\r\n\t\t\t\tconst error = await response.json();\r\n\t\t\t\tconsole.error('Failed to update workflow identity:', error);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tconst result: { name: string; alias: string } = await response.json();\r\n\t\t\tthis.#ctx?.setIdentity(result.name, result.alias);\r\n\r\n\t\t\t// If alias changed, redirect to new URL\r\n\t\t\tif (result.alias !== currentAlias) {\r\n\t\t\t\tconst newUrl = `section/settings/workspace/updoc-workflow/edit/${encodeURIComponent(result.alias)}`;\r\n\t\t\t\twindow.history.replaceState({}, '', newUrl);\r\n\t\t\t}\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error('Failed to update workflow identity:', err);\r\n\t\t}\r\n\t}\r\n\r\n\toverride render() {\r\n\t\treturn html`\r\n\t\t\t<umb-workspace-editor>\r\n\t\t\t\t<div id=\"header\" slot=\"header\">\r\n\t\t\t\t\t<umb-input-with-alias\r\n\t\t\t\t\t\tid=\"name\"\r\n\t\t\t\t\t\tlabel=\"Workflow name\"\r\n\t\t\t\t\t\t.value=${this._name}\r\n\t\t\t\t\t\t.alias=${this._alias}\r\n\t\t\t\t\t\t?auto-generate-alias=${this._isNew}\r\n\t\t\t\t\t\t@change=${this.#onNameAndAliasChange}>\r\n\t\t\t\t\t</umb-input-with-alias>\r\n\t\t\t\t</div>\r\n\t\t\t</umb-workspace-editor>\r\n\t\t`;\r\n\t}\r\n\r\n\tstatic override styles = css`\r\n\t\t:host {\r\n\t\t\tdisplay: contents;\r\n\t\t}\r\n\r\n\t\t#header {\r\n\t\t\tdisplay: flex;\r\n\t\t\talign-items: center;\r\n\t\t\tgap: var(--uui-size-space-4);\r\n\t\t\twidth: 100%;\r\n\t\t}\r\n\r\n\t\t#name {\r\n\t\t\tflex: 1;\r\n\t\t}\r\n\t`;\r\n}\r\n\r\ninterface UpDocWorkflowData {\r\n\tunique: string;\r\n\tname?: string;\r\n\talias?: string;\r\n}\r\n\r\nexport class UpDocWorkflowWorkspaceContext extends UmbContextBase {\r\n\tpublic readonly workspaceAlias = 'UpDoc.WorkflowWorkspace';\r\n\r\n\t#data = new UmbObjectState<UpDocWorkflowData | undefined>(undefined);\r\n\treadonly data = this.#data.asObservable();\r\n\treadonly unique = this.#data.asObservablePart((data) => data?.unique);\r\n\treadonly name = this.#data.asObservablePart((data) => data?.name);\r\n\treadonly alias = this.#data.asObservablePart((data) => data?.alias);\r\n\r\n\t/** Callback registered by the active workspace view to handle save. */\r\n\t#saveHandler: (() => Promise<void>) | null = null;\r\n\r\n\t/** Callback registered by the active workspace view to handle refresh/re-extract. */\r\n\t#refreshHandler: (() => Promise<void>) | null = null;\r\n\r\n\t/** Register a save handler (called by workspace views like Source). */\r\n\tsetSaveHandler(handler: (() => Promise<void>) | null) {\r\n\t\tthis.#saveHandler = handler;\r\n\t}\r\n\r\n\t/** Register a refresh handler for re-extraction (called by workspace views like Source). */\r\n\tsetRefreshHandler(handler: (() => Promise<void>) | null) {\r\n\t\tthis.#refreshHandler = handler;\r\n\t}\r\n\r\n\t/** Called by the workspace action (Save button). Delegates to the registered handler. */\r\n\tasync save(): Promise<void> {\r\n\t\tif (this.#saveHandler) {\r\n\t\t\tawait this.#saveHandler();\r\n\t\t}\r\n\t}\r\n\r\n\t/** Called by the Refresh workspace action. Triggers re-extraction. */\r\n\tasync refresh(): Promise<void> {\r\n\t\tif (this.#refreshHandler) {\r\n\t\t\tawait this.#refreshHandler();\r\n\t\t}\r\n\t}\r\n\r\n\treadonly routes = new UmbWorkspaceRouteManager(this);\r\n\r\n\tconstructor(host: UmbControllerHost) {\r\n\t\tsuper(host, UMB_WORKSPACE_CONTEXT);\r\n\r\n\t\tthis.routes.setRoutes([\r\n\t\t\t{\r\n\t\t\t\tpath: 'edit/:unique',\r\n\t\t\t\tcomponent: UpDocWorkflowWorkspaceEditorElement,\r\n\t\t\t\tsetup: (_component: HTMLElement, info: any) => {\r\n\t\t\t\t\tconst unique = info.match.params.unique;\r\n\t\t\t\t\tthis.load(unique);\r\n\t\t\t\t},\r\n\t\t\t},\r\n\t\t]);\r\n\t}\r\n\r\n\tload(unique: string) {\r\n\t\tconst workflowAlias = decodeURIComponent(unique);\r\n\t\tthis.#data.setValue({ unique, name: workflowAlias, alias: workflowAlias });\r\n\t}\r\n\r\n\t/** Update the display name and alias (called by the workspace editor after fetching/saving). */\r\n\tsetIdentity(name: string, alias: string) {\r\n\t\tconst current = this.#data.getValue();\r\n\t\tif (current) {\r\n\t\t\tthis.#data.setValue({ ...current, name, alias, unique: alias });\r\n\t\t}\r\n\t}\r\n\r\n\tgetUnique() {\r\n\t\treturn this.#data.getValue()?.unique;\r\n\t}\r\n\r\n\tgetEntityType() {\r\n\t\treturn 'updoc-workflow';\r\n\t}\r\n\r\n\tpublic override destroy(): void {\r\n\t\tthis.#data.destroy();\r\n\t\tsuper.destroy();\r\n\t}\r\n}\r\n\r\nexport { UpDocWorkflowWorkspaceContext as api };\r\n"],"names":["_ctx","_UpDocWorkflowWorkspaceEditorElement_instances","fetchIdentity_fn","onNameAndAliasChange_fn","UpDocWorkflowWorkspaceEditorElement","UmbLitElement","__privateAdd","UMB_WORKSPACE_CONTEXT","context","__privateSet","__privateGet","name","alias","unique","__privateMethod","html","workflowAlias","token","UMB_AUTH_CONTEXT","response","match","s","e","target","newName","newAlias","currentAlias","error","result","newUrl","err","css","__decorateClass","state","customElement","UpDocWorkflowWorkspaceContext","UmbContextBase","host","#data","UmbObjectState","data","#saveHandler","#refreshHandler","UmbWorkspaceRouteManager","_component","info","handler","current"],"mappings":"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"}