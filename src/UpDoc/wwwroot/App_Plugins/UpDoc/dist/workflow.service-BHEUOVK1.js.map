{"version":3,"file":"workflow.service-BHEUOVK1.js","sources":["../src/workflow.service.ts"],"sourcesContent":["import type { DocumentTypeConfig, ExtractSectionsResponse } from './workflow.types.js';\r\n\r\nconst configCache = new Map<string, DocumentTypeConfig>();\r\n\r\nexport interface ActiveWorkflows {\r\n\tdocumentTypeAliases: string[];\r\n\tblueprintIds: string[];\r\n}\r\n\r\nlet activeWorkflowsCache: ActiveWorkflows | null = null;\r\nlet activeWorkflowsPromise: Promise<ActiveWorkflows> | null = null;\r\n\r\n/**\r\n * Fetches the list of document type aliases and blueprint IDs\r\n * that have complete workflows configured. Cached globally.\r\n */\r\nexport async function fetchActiveWorkflows(token: string): Promise<ActiveWorkflows> {\r\n\tif (activeWorkflowsCache) return activeWorkflowsCache;\r\n\r\n\tif (!activeWorkflowsPromise) {\r\n\t\tactiveWorkflowsPromise = (async () => {\r\n\t\t\ttry {\r\n\t\t\t\tconst response = await fetch('/umbraco/management/api/v1/updoc/workflows/active', {\r\n\t\t\t\t\tmethod: 'GET',\r\n\t\t\t\t\theaders: {\r\n\t\t\t\t\t\t'Content-Type': 'application/json',\r\n\t\t\t\t\t\tAuthorization: `Bearer ${token}`,\r\n\t\t\t\t\t},\r\n\t\t\t\t});\r\n\r\n\t\t\t\tif (response.ok) {\r\n\t\t\t\t\tactiveWorkflowsCache = await response.json();\r\n\t\t\t\t} else {\r\n\t\t\t\t\tactiveWorkflowsCache = { documentTypeAliases: [], blueprintIds: [] };\r\n\t\t\t\t}\r\n\t\t\t} catch {\r\n\t\t\t\tactiveWorkflowsCache = { documentTypeAliases: [], blueprintIds: [] };\r\n\t\t\t}\r\n\t\t\tactiveWorkflowsPromise = null;\r\n\t\t\treturn activeWorkflowsCache!;\r\n\t\t})();\r\n\t}\r\n\r\n\treturn activeWorkflowsPromise;\r\n}\r\n\r\n/**\r\n * Fetches the document type config for a given blueprint ID.\r\n * The config contains source.json, destination.json, and map.json data.\r\n */\r\nexport async function fetchConfig(blueprintId: string, token: string): Promise<DocumentTypeConfig | null> {\r\n\tconst cached = configCache.get(blueprintId);\r\n\tif (cached) return cached;\r\n\r\n\tconst response = await fetch(\r\n\t\t`/umbraco/management/api/v1/updoc/config/${blueprintId}`,\r\n\t\t{\r\n\t\t\tmethod: 'GET',\r\n\t\t\theaders: {\r\n\t\t\t\t'Content-Type': 'application/json',\r\n\t\t\t\tAuthorization: `Bearer ${token}`,\r\n\t\t\t},\r\n\t\t}\r\n\t);\r\n\r\n\tif (!response.ok) {\r\n\t\tconsole.warn(`No config found for blueprint ${blueprintId}`);\r\n\t\treturn null;\r\n\t}\r\n\r\n\tconst config: DocumentTypeConfig = await response.json();\r\n\tconfigCache.set(blueprintId, config);\r\n\treturn config;\r\n}\r\n\r\n/**\r\n * Extracts sections from a source document using the config for the given blueprint.\r\n * Returns extracted sections and the full config for property mapping.\r\n */\r\nexport async function extractSections(\r\n\tmediaKey: string,\r\n\tblueprintId: string,\r\n\ttoken: string,\r\n\tsourceType: string = 'pdf'\r\n): Promise<ExtractSectionsResponse | null> {\r\n\tconst response = await fetch(\r\n\t\t`/umbraco/management/api/v1/updoc/extract-sections?mediaKey=${mediaKey}&blueprintId=${blueprintId}&sourceType=${sourceType}`,\r\n\t\t{\r\n\t\t\tmethod: 'GET',\r\n\t\t\theaders: {\r\n\t\t\t\t'Content-Type': 'application/json',\r\n\t\t\t\tAuthorization: `Bearer ${token}`,\r\n\t\t\t},\r\n\t\t}\r\n\t);\r\n\r\n\tif (!response.ok) {\r\n\t\tconst error = await response.json();\r\n\t\tconsole.error('Extract sections failed:', error);\r\n\t\treturn null;\r\n\t}\r\n\r\n\t// API returns { sections, config } - pass through directly\r\n\treturn response.json();\r\n}\r\n\r\n/**\r\n * Clears all caches. Useful when configs have been modified.\r\n */\r\nexport function clearConfigCache(): void {\r\n\tconfigCache.clear();\r\n\tactiveWorkflowsCache = null;\r\n\tactiveWorkflowsPromise = null;\r\n}\r\n"],"names":["configCache","activeWorkflowsCache","activeWorkflowsPromise","fetchActiveWorkflows","token","response","fetchConfig","blueprintId","cached","config","extractSections","mediaKey","sourceType","error","clearConfigCache"],"mappings":"AAEA,MAAMA,wBAAkB,IAAA;AAOxB,IAAIC,IAA+C,MAC/CC,IAA0D;AAM9D,eAAsBC,EAAqBC,GAAyC;AACnF,SAAIH,MAECC,MACJA,KAA0B,YAAY;AACrC,QAAI;AACH,YAAMG,IAAW,MAAM,MAAM,qDAAqD;AAAA,QACjF,QAAQ;AAAA,QACR,SAAS;AAAA,UACR,gBAAgB;AAAA,UAChB,eAAe,UAAUD,CAAK;AAAA,QAAA;AAAA,MAC/B,CACA;AAED,MAAIC,EAAS,KACZJ,IAAuB,MAAMI,EAAS,KAAA,IAEtCJ,IAAuB,EAAE,qBAAqB,IAAI,cAAc,CAAA,EAAC;AAAA,IAEnE,QAAQ;AACP,MAAAA,IAAuB,EAAE,qBAAqB,IAAI,cAAc,CAAA,EAAC;AAAA,IAClE;AACA,WAAAC,IAAyB,MAClBD;AAAA,EACR,GAAA,IAGMC;AACR;AAMA,eAAsBI,EAAYC,GAAqBH,GAAmD;AACzG,QAAMI,IAASR,EAAY,IAAIO,CAAW;AAC1C,MAAIC,EAAQ,QAAOA;AAEnB,QAAMH,IAAW,MAAM;AAAA,IACtB,2CAA2CE,CAAW;AAAA,IACtD;AAAA,MACC,QAAQ;AAAA,MACR,SAAS;AAAA,QACR,gBAAgB;AAAA,QAChB,eAAe,UAAUH,CAAK;AAAA,MAAA;AAAA,IAC/B;AAAA,EACD;AAGD,MAAI,CAACC,EAAS;AACb,mBAAQ,KAAK,iCAAiCE,CAAW,EAAE,GACpD;AAGR,QAAME,IAA6B,MAAMJ,EAAS,KAAA;AAClD,SAAAL,EAAY,IAAIO,GAAaE,CAAM,GAC5BA;AACR;AAMA,eAAsBC,EACrBC,GACAJ,GACAH,GACAQ,IAAqB,OACqB;AAC1C,QAAMP,IAAW,MAAM;AAAA,IACtB,8DAA8DM,CAAQ,gBAAgBJ,CAAW,eAAeK,CAAU;AAAA,IAC1H;AAAA,MACC,QAAQ;AAAA,MACR,SAAS;AAAA,QACR,gBAAgB;AAAA,QAChB,eAAe,UAAUR,CAAK;AAAA,MAAA;AAAA,IAC/B;AAAA,EACD;AAGD,MAAI,CAACC,EAAS,IAAI;AACjB,UAAMQ,IAAQ,MAAMR,EAAS,KAAA;AAC7B,mBAAQ,MAAM,4BAA4BQ,CAAK,GACxC;AAAA,EACR;AAGA,SAAOR,EAAS,KAAA;AACjB;AAKO,SAASS,IAAyB;AACxC,EAAAd,EAAY,MAAA,GACZC,IAAuB,MACvBC,IAAyB;AAC1B;"}