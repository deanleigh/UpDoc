{"version":3,"file":"section-rules-editor-modal.element-D8Lfse4j.js","sources":["../src/rule-card-styles.ts","../src/sortable-rules-container.element.ts","../src/section-rules-editor-modal.element.ts"],"sourcesContent":["import { css } from '@umbraco-cms/backoffice/external/lit';\r\n\r\n/**\r\n * Shared styles for rule cards (collapsed rows + expanded cards).\r\n * Imported by both the section-rules-editor modal and the sortable-rules container\r\n * so styles apply across shadow DOM boundaries.\r\n */\r\nexport const ruleCardStyles = css`\r\n\t/* Collapsed rule row */\r\n\t.rule-row {\r\n\t\tdisplay: flex;\r\n\t\talign-items: center;\r\n\t\tgap: var(--uui-size-space-3);\r\n\t\tpadding: var(--uui-size-space-2) var(--uui-size-space-4);\r\n\t\tborder: 1px solid var(--uui-color-border);\r\n\t\tborder-radius: var(--uui-border-radius);\r\n\t\tcursor: pointer;\r\n\t\tuser-select: none;\r\n\t\tbackground: var(--uui-color-surface);\r\n\t\ttransition: background 120ms ease;\r\n\t}\r\n\r\n\t.rule-row:hover {\r\n\t\tbackground: var(--uui-color-surface-alt);\r\n\t}\r\n\r\n\t.rule-row-name {\r\n\t\tflex: 1;\r\n\t\tfont-size: var(--uui-type-default-size);\r\n\t\tfont-weight: 600;\r\n\t\tmin-width: 0;\r\n\t\toverflow: hidden;\r\n\t\ttext-overflow: ellipsis;\r\n\t\twhite-space: nowrap;\r\n\t}\r\n\r\n\t.rule-row-part {\r\n\t\tfont-size: 11px;\r\n\t\tfont-weight: 600;\r\n\t\tpadding: 1px 8px;\r\n\t\tborder-radius: var(--uui-border-radius);\r\n\t\tbackground: var(--uui-color-surface-alt);\r\n\t\tcolor: var(--uui-color-text-alt);\r\n\t\tflex-shrink: 0;\r\n\t}\r\n\r\n\t.rule-row-part.excluded {\r\n\t\tbackground: color-mix(in srgb, var(--uui-color-danger) 15%, transparent);\r\n\t\tcolor: var(--uui-color-danger-standalone);\r\n\t}\r\n\r\n\t.rule-row-match {\r\n\t\tfont-size: 11px;\r\n\t\tfont-weight: 700;\r\n\t\tpadding: 1px 6px;\r\n\t\tborder-radius: var(--uui-border-radius);\r\n\t\tflex-shrink: 0;\r\n\t}\r\n\r\n\t.rule-row-match.matched {\r\n\t\tbackground: color-mix(in srgb, var(--uui-color-positive) 15%, transparent);\r\n\t\tcolor: var(--uui-color-positive-standalone);\r\n\t}\r\n\r\n\t.rule-row-match.excluded {\r\n\t\tbackground: color-mix(in srgb, var(--uui-color-danger) 15%, transparent);\r\n\t\tcolor: var(--uui-color-danger-standalone);\r\n\t}\r\n\r\n\t.rule-row-match.no-match {\r\n\t\tbackground: color-mix(in srgb, var(--uui-color-warning) 15%, transparent);\r\n\t\tcolor: var(--uui-color-warning-standalone);\r\n\t}\r\n\r\n\t.rule-row-chevron {\r\n\t\tfont-size: 12px;\r\n\t\tcolor: var(--uui-color-text-alt);\r\n\t\tflex-shrink: 0;\r\n\t\ttransition: transform 120ms ease;\r\n\t}\r\n\r\n\t/* Action bar: hidden by default, appears on hover */\r\n\t.rule-row-actions {\r\n\t\tflex-shrink: 0;\r\n\t\topacity: 0;\r\n\t\ttransition: opacity 120ms ease;\r\n\t}\r\n\r\n\t.rule-row:hover .rule-row-actions {\r\n\t\topacity: 1;\r\n\t}\r\n\r\n\t/* Rule cards (expanded) */\r\n\t.rule-card {\r\n\t\tborder: 1px solid var(--uui-color-border);\r\n\t\tborder-radius: var(--uui-border-radius);\r\n\t\toverflow: hidden;\r\n\t}\r\n\r\n\t.rule-header {\r\n\t\tdisplay: flex;\r\n\t\talign-items: center;\r\n\t\tgap: var(--uui-size-space-3);\r\n\t\tpadding: var(--uui-size-space-3) var(--uui-size-space-4);\r\n\t\tbackground: var(--uui-color-surface-alt);\r\n\t\tborder-bottom: 1px solid var(--uui-color-border);\r\n\t}\r\n\r\n\t.rule-grip {\r\n\t\tcursor: grab;\r\n\t\tcolor: var(--uui-color-text-alt);\r\n\t\tfont-size: 14px;\r\n\t\tuser-select: none;\r\n\t\tflex-shrink: 0;\r\n\t}\r\n\r\n\t.rule-grip:active {\r\n\t\tcursor: grabbing;\r\n\t}\r\n\r\n\t.role-name-input {\r\n\t\tflex: 1;\r\n\t\tpadding: var(--uui-size-space-1) var(--uui-size-space-2);\r\n\t\tborder: 1px solid var(--uui-color-border);\r\n\t\tborder-radius: var(--uui-border-radius);\r\n\t\tfont-size: var(--uui-type-default-size);\r\n\t\tfont-family: monospace;\r\n\t\tbackground: var(--uui-color-surface);\r\n\t\tcolor: var(--uui-color-text);\r\n\t}\r\n\r\n\t.role-name-input:focus {\r\n\t\toutline: none;\r\n\t\tborder-color: var(--uui-color-focus);\r\n\t}\r\n\r\n\t/* Section headers within rule cards */\r\n\t.section-header {\r\n\t\tfont-size: 11px;\r\n\t\tfont-weight: 700;\r\n\t\ttext-transform: uppercase;\r\n\t\tletter-spacing: 0.5px;\r\n\t\tcolor: var(--uui-color-text-alt);\r\n\t\tmargin-bottom: var(--uui-size-space-1);\r\n\t}\r\n\r\n\t.section-header.collapsible {\r\n\t\tcursor: pointer;\r\n\t\tdisplay: flex;\r\n\t\talign-items: center;\r\n\t\tgap: var(--uui-size-space-1);\r\n\t\tuser-select: none;\r\n\t}\r\n\r\n\t.section-header.collapsible:hover {\r\n\t\tcolor: var(--uui-color-text);\r\n\t}\r\n\r\n\t.section-header.collapsible uui-icon {\r\n\t\tfont-size: 10px;\r\n\t}\r\n\r\n\t/* Conditions */\r\n\t.conditions-area {\r\n\t\tpadding: var(--uui-size-space-3) var(--uui-size-space-4);\r\n\t\tdisplay: flex;\r\n\t\tflex-direction: column;\r\n\t\tgap: var(--uui-size-space-2);\r\n\t}\r\n\r\n\t/* Exceptions */\r\n\t.exceptions-area {\r\n\t\tpadding: var(--uui-size-space-3) var(--uui-size-space-4);\r\n\t\tdisplay: flex;\r\n\t\tflex-direction: column;\r\n\t\tgap: var(--uui-size-space-2);\r\n\t\tborder-top: 1px solid var(--uui-color-border);\r\n\t}\r\n\r\n\t.condition-row {\r\n\t\tdisplay: flex;\r\n\t\talign-items: center;\r\n\t\tgap: var(--uui-size-space-2);\r\n\t}\r\n\r\n\t.condition-type-select {\r\n\t\tmin-width: 180px;\r\n\t\tpadding: var(--uui-size-space-1) var(--uui-size-space-2);\r\n\t\tborder: 1px solid var(--uui-color-border);\r\n\t\tborder-radius: var(--uui-border-radius);\r\n\t\tfont-size: var(--uui-type-small-size);\r\n\t\tbackground: var(--uui-color-surface);\r\n\t\tcolor: var(--uui-color-text);\r\n\t}\r\n\r\n\t.condition-type-select:focus {\r\n\t\toutline: none;\r\n\t\tborder-color: var(--uui-color-focus);\r\n\t}\r\n\r\n\t.condition-value-input {\r\n\t\tflex: 1;\r\n\t\tpadding: var(--uui-size-space-1) var(--uui-size-space-2);\r\n\t\tborder: 1px solid var(--uui-color-border);\r\n\t\tborder-radius: var(--uui-border-radius);\r\n\t\tfont-size: var(--uui-type-small-size);\r\n\t\tfont-family: monospace;\r\n\t\tbackground: var(--uui-color-surface);\r\n\t\tcolor: var(--uui-color-text);\r\n\t}\r\n\r\n\t.condition-value-input:focus {\r\n\t\toutline: none;\r\n\t\tborder-color: var(--uui-color-focus);\r\n\t}\r\n\r\n\t/* Format row selects */\r\n\t.format-type-select {\r\n\t\tmin-width: 100px;\r\n\t\tpadding: var(--uui-size-space-1) var(--uui-size-space-2);\r\n\t\tborder: 1px solid var(--uui-color-border);\r\n\t\tborder-radius: var(--uui-border-radius);\r\n\t\tfont-size: var(--uui-type-small-size);\r\n\t\tbackground: var(--uui-color-surface);\r\n\t\tcolor: var(--uui-color-text);\r\n\t}\r\n\r\n\t.format-type-select:focus {\r\n\t\toutline: none;\r\n\t\tborder-color: var(--uui-color-focus);\r\n\t}\r\n\r\n\t.format-value-select {\r\n\t\tflex: 1;\r\n\t\tpadding: var(--uui-size-space-1) var(--uui-size-space-2);\r\n\t\tborder: 1px solid var(--uui-color-border);\r\n\t\tborder-radius: var(--uui-border-radius);\r\n\t\tfont-size: var(--uui-type-small-size);\r\n\t\tbackground: var(--uui-color-surface);\r\n\t\tcolor: var(--uui-color-text);\r\n\t}\r\n\r\n\t.format-value-select:focus {\r\n\t\toutline: none;\r\n\t\tborder-color: var(--uui-color-focus);\r\n\t}\r\n\r\n\t/* Part area */\r\n\t.part-area {\r\n\t\tdisplay: flex;\r\n\t\tflex-direction: column;\r\n\t\tgap: var(--uui-size-space-2);\r\n\t\tpadding: var(--uui-size-space-3) var(--uui-size-space-4);\r\n\t\tborder-top: 1px solid var(--uui-color-border);\r\n\t}\r\n\r\n\t.part-controls {\r\n\t\tdisplay: flex;\r\n\t\talign-items: center;\r\n\t\tgap: var(--uui-size-space-3);\r\n\t}\r\n\r\n\t.part-select {\r\n\t\tpadding: var(--uui-size-space-1) var(--uui-size-space-2);\r\n\t\tborder: 1px solid var(--uui-color-border);\r\n\t\tborder-radius: var(--uui-border-radius);\r\n\t\tfont-size: var(--uui-type-small-size);\r\n\t\tbackground: var(--uui-color-surface);\r\n\t\tcolor: var(--uui-color-text);\r\n\t}\r\n\r\n\t.part-select:focus {\r\n\t\toutline: none;\r\n\t\tborder-color: var(--uui-color-focus);\r\n\t}\r\n\r\n\t.part-select:disabled {\r\n\t\topacity: 0.5;\r\n\t}\r\n\r\n\t.exclude-label {\r\n\t\tdisplay: flex;\r\n\t\talign-items: center;\r\n\t\tgap: var(--uui-size-space-1);\r\n\t\tfont-size: var(--uui-type-small-size);\r\n\t\tcolor: var(--uui-color-text-alt);\r\n\t\tcursor: pointer;\r\n\t\tuser-select: none;\r\n\t}\r\n\r\n\t/* Format area */\r\n\t.format-area {\r\n\t\tdisplay: flex;\r\n\t\tflex-direction: column;\r\n\t\tgap: var(--uui-size-space-2);\r\n\t\tpadding: var(--uui-size-space-3) var(--uui-size-space-4);\r\n\t\tborder-top: 1px solid var(--uui-color-border);\r\n\t}\r\n\r\n\t/* Find & Replace entries */\r\n\t.find-replace-entry {\r\n\t\tdisplay: flex;\r\n\t\tflex-direction: column;\r\n\t\tgap: var(--uui-size-space-1);\r\n\t\tpadding: var(--uui-size-space-2);\r\n\t\tborder: 1px solid var(--uui-color-border);\r\n\t\tborder-radius: var(--uui-border-radius);\r\n\t\tbackground: var(--uui-color-surface);\r\n\t}\r\n\r\n\t.replace-label {\r\n\t\tmin-width: 180px;\r\n\t\tpadding: var(--uui-size-space-1) var(--uui-size-space-2);\r\n\t\tfont-size: var(--uui-type-small-size);\r\n\t\tcolor: var(--uui-color-text-alt);\r\n\t\tfont-weight: 600;\r\n\t}\r\n\r\n\t/* Match preview */\r\n\t.match-preview {\r\n\t\tdisplay: flex;\r\n\t\talign-items: center;\r\n\t\tgap: var(--uui-size-space-2);\r\n\t\tpadding: var(--uui-size-space-2) var(--uui-size-space-4);\r\n\t\tfont-size: var(--uui-type-small-size);\r\n\t\tborder-top: 1px solid var(--uui-color-border);\r\n\t}\r\n\r\n\t.match-preview.matched {\r\n\t\tbackground: color-mix(in srgb, var(--uui-color-positive) 10%, transparent);\r\n\t\tcolor: var(--uui-color-positive-standalone);\r\n\t}\r\n\r\n\t.match-preview.excluded {\r\n\t\tbackground: color-mix(in srgb, var(--uui-color-danger) 10%, transparent);\r\n\t\tcolor: var(--uui-color-danger-standalone);\r\n\t}\r\n\r\n\t.match-preview.no-match {\r\n\t\tbackground: color-mix(in srgb, var(--uui-color-warning) 10%, transparent);\r\n\t\tcolor: var(--uui-color-warning-standalone);\r\n\t}\r\n\r\n\t.match-preview strong {\r\n\t\tfont-weight: 600;\r\n\t}\r\n`;\r\n","import { UmbSorterController } from '@umbraco-cms/backoffice/sorter';\r\nimport { html, css, nothing, repeat } from '@umbraco-cms/backoffice/external/lit';\r\nimport { customElement, property, state } from '@umbraco-cms/backoffice/external/lit';\r\nimport { UmbLitElement } from '@umbraco-cms/backoffice/lit-element';\r\nimport { ruleCardStyles } from './rule-card-styles.js';\r\n\r\n/**\r\n * Minimal interface for sortable rules — must have _id for unique identification.\r\n */\r\nexport interface SortableRule {\r\n\t_id: string;\r\n\t[key: string]: unknown;\r\n}\r\n\r\n/**\r\n * Event detail emitted on sort-change.\r\n */\r\nexport interface SortChangeDetail {\r\n\trules: SortableRule[];\r\n}\r\n\r\n/**\r\n * Lightweight container for sortable rules. One instance per group (+ one for ungrouped).\r\n * All instances share the same `identifier` so rules can be dragged between groups.\r\n *\r\n * Uses shadow DOM (required by UmbSorterController) with shared ruleCardStyles\r\n * so rendered rule cards are styled correctly.\r\n *\r\n * Uses `handleSelector` to restrict drag initiation to the grip element.\r\n * Uses `disabledItemSelector` to prevent expanded rules from being dragged.\r\n */\r\n@customElement('updoc-sortable-rules')\r\nexport class UpdocSortableRulesElement extends UmbLitElement {\r\n\t#sorter = new UmbSorterController<SortableRule, HTMLElement>(this, {\r\n\t\tgetUniqueOfElement: (el) => el.dataset.sortId ?? '',\r\n\t\tgetUniqueOfModel: (rule) => rule._id,\r\n\t\tidentifier: 'updoc-rules-sorter',\r\n\t\titemSelector: '.sortable-rule',\r\n\t\tcontainerSelector: '.rules-container',\r\n\t\thandleSelector: '.rule-grip',\r\n\t\tdisabledItemSelector: '[data-expanded]',\r\n\t\tplaceholderAttr: 'drag-placeholder',\r\n\t\tonChange: ({ model }) => {\r\n\t\t\tthis._rules = model;\r\n\t\t\tthis.dispatchEvent(new CustomEvent<SortChangeDetail>('sort-change', {\r\n\t\t\t\tdetail: { rules: model },\r\n\t\t\t\tbubbles: true,\r\n\t\t\t\tcomposed: true,\r\n\t\t\t}));\r\n\t\t},\r\n\t});\r\n\r\n\t@property({ attribute: false })\r\n\tset rules(val: SortableRule[]) {\r\n\t\tthis._rules = val;\r\n\t\tthis.#sorter.setModel(val);\r\n\t}\r\n\tget rules(): SortableRule[] { return this._rules; }\r\n\t@state() private _rules: SortableRule[] = [];\r\n\r\n\t/** Set of rule _ids that are currently expanded (and thus not draggable). */\r\n\t@property({ attribute: false })\r\n\texpandedIds: Set<string> = new Set();\r\n\r\n\t/** Render callback provided by the parent modal. */\r\n\t@property({ attribute: false })\r\n\trenderItem?: (rule: SortableRule) => unknown;\r\n\r\n\toverride render() {\r\n\t\tif (this._rules.length === 0 && !this.renderItem) {\r\n\t\t\treturn nothing;\r\n\t\t}\r\n\r\n\t\treturn html`\r\n\t\t\t<div class=\"rules-container\">\r\n\t\t\t\t${repeat(\r\n\t\t\t\t\tthis._rules,\r\n\t\t\t\t\t(rule) => rule._id,\r\n\t\t\t\t\t(rule) => html`\r\n\t\t\t\t\t\t<div class=\"sortable-rule\"\r\n\t\t\t\t\t\t\tdata-sort-id=${rule._id}\r\n\t\t\t\t\t\t\t?data-expanded=${this.expandedIds.has(rule._id)}>\r\n\t\t\t\t\t\t\t${this.renderItem?.(rule) ?? html`<span>${rule._id}</span>`}\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t`,\r\n\t\t\t\t)}\r\n\t\t\t</div>\r\n\t\t`;\r\n\t}\r\n\r\n\tstatic override styles = [\r\n\t\truleCardStyles,\r\n\t\tcss`\r\n\t\t\t:host {\r\n\t\t\t\tdisplay: block;\r\n\t\t\t}\r\n\r\n\t\t\t.rules-container {\r\n\t\t\t\tdisplay: flex;\r\n\t\t\t\tflex-direction: column;\r\n\t\t\t\tgap: var(--uui-size-space-3, 12px);\r\n\t\t\t\tmin-height: 8px;\r\n\t\t\t}\r\n\r\n\t\t\t.sortable-rule[drag-placeholder] {\r\n\t\t\t\topacity: 0.2;\r\n\t\t\t}\r\n\t\t`,\r\n\t];\r\n}\r\n\r\ndeclare global {\r\n\tinterface HTMLElementTagNameMap {\r\n\t\t'updoc-sortable-rules': UpdocSortableRulesElement;\r\n\t}\r\n}\r\n","import type { SectionRulesEditorModalData, SectionRulesEditorModalValue } from './section-rules-editor-modal.token.js';\r\nimport type { SectionRule, RuleCondition, RuleConditionType, RulePart, BlockFormat, FormatEntry, FormatEntryType, AreaElement, AreaRules, RuleGroup, TextReplacement, FindType, ReplaceType } from './workflow.types.js';\r\nimport type { SortChangeDetail, SortableRule } from './sortable-rules-container.element.js';\r\nimport { getEffectivePart, getEffectiveFormat } from './workflow.types.js';\r\nimport './sortable-rules-container.element.js';\r\nimport { ruleCardStyles } from './rule-card-styles.js';\r\nimport { html, css, state, nothing } from '@umbraco-cms/backoffice/external/lit';\r\nimport { customElement } from '@umbraco-cms/backoffice/external/lit';\r\nimport { UmbModalBaseElement } from '@umbraco-cms/backoffice/modal';\r\nimport { UmbTextStyles } from '@umbraco-cms/backoffice/style';\r\n\r\n/**\r\n * Editable rule: SectionRule + transient tracking fields for the modal.\r\n * _id is used for drag-and-drop tracking. _groupName tracks which group the rule belongs to.\r\n */\r\ninterface EditableRule extends SectionRule {\r\n\t_id: string;\r\n\t_groupName: string | null;\r\n}\r\n\r\nlet _nextRuleId = 0;\r\nfunction generateRuleId(): string {\r\n\treturn `r-${++_nextRuleId}`;\r\n}\r\n\r\n/** Friendly labels for condition types */\r\nconst CONDITION_LABELS: Record<RuleConditionType, string> = {\r\n\ttextBeginsWith: 'Text begins with',\r\n\ttextEndsWith: 'Text ends with',\r\n\ttextContains: 'Text contains',\r\n\ttextEquals: 'Text equals',\r\n\ttextMatchesPattern: 'Text matches pattern',\r\n\tfontSizeEquals: 'Font size equals',\r\n\tfontSizeAbove: 'Font size above',\r\n\tfontSizeBelow: 'Font size below',\r\n\tfontNameContains: 'Font name contains',\r\n\tfontNameEquals: 'Font name equals',\r\n\tcolorEquals: 'Color equals',\r\n\tpositionFirst: 'Position: first',\r\n\tpositionLast: 'Position: last',\r\n};\r\n\r\n/** Condition types that don't need a value input */\r\nconst VALUELESS_CONDITIONS: RuleConditionType[] = ['positionFirst', 'positionLast'];\r\n\r\n/** All available condition types */\r\nconst ALL_CONDITION_TYPES: RuleConditionType[] = [\r\n\t'textBeginsWith', 'textEndsWith', 'textContains', 'textEquals', 'textMatchesPattern',\r\n\t'fontSizeEquals', 'fontSizeAbove', 'fontSizeBelow',\r\n\t'fontNameContains', 'fontNameEquals', 'colorEquals',\r\n\t'positionFirst', 'positionLast',\r\n];\r\n\r\n/** Friendly labels for rule parts */\r\nconst PART_LABELS: Record<RulePart, string> = {\r\n\ttitle: 'Title',\r\n\tcontent: 'Content',\r\n\tdescription: 'Description',\r\n\tsummary: 'Summary',\r\n};\r\n\r\n/** All available rule parts */\r\nconst ALL_PARTS: RulePart[] = ['title', 'content', 'description', 'summary'];\r\n\r\n/** Format entry type labels */\r\nconst FORMAT_ENTRY_TYPE_LABELS: Record<FormatEntryType, string> = {\r\n\tblock: 'Block',\r\n\tstyle: 'Style',\r\n};\r\n\r\nconst ALL_FORMAT_ENTRY_TYPES: FormatEntryType[] = ['block', 'style'];\r\n\r\n/** Block format value labels (block-level Markdown elements) */\r\nconst BLOCK_FORMAT_LABELS: Record<string, string> = {\r\n\tauto: 'Auto',\r\n\tparagraph: 'Paragraph',\r\n\theading1: 'Heading 1',\r\n\theading2: 'Heading 2',\r\n\theading3: 'Heading 3',\r\n\theading4: 'Heading 4',\r\n\theading5: 'Heading 5',\r\n\theading6: 'Heading 6',\r\n\tbulletListItem: 'Bullet List',\r\n\tnumberedListItem: 'Numbered List',\r\n\tquote: 'Quote',\r\n};\r\n\r\nconst ALL_BLOCK_FORMATS: string[] = [\r\n\t'auto', 'paragraph', 'heading1', 'heading2', 'heading3', 'heading4', 'heading5', 'heading6',\r\n\t'bulletListItem', 'numberedListItem', 'quote',\r\n];\r\n\r\n/** Style format value labels (inline Markdown decorations) */\r\nconst STYLE_FORMAT_LABELS: Record<string, string> = {\r\n\tbold: 'Bold',\r\n\titalic: 'Italic',\r\n\tstrikethrough: 'Strikethrough',\r\n\tcode: 'Code',\r\n\thighlight: 'Highlight',\r\n};\r\n\r\nconst ALL_STYLE_FORMATS: string[] = ['bold', 'italic', 'strikethrough', 'code', 'highlight'];\r\n\r\n/** Find type labels for text replacements */\r\nconst FIND_TYPE_LABELS: Record<FindType, string> = {\r\n\ttextBeginsWith: 'Text begins with',\r\n\ttextEndsWith: 'Text ends with',\r\n\ttextContains: 'Text contains',\r\n};\r\n\r\nconst ALL_FIND_TYPES: FindType[] = ['textBeginsWith', 'textEndsWith', 'textContains'];\r\n\r\n/** Replace type labels — contextual based on find type */\r\nconst REPLACE_TYPE_LABELS: Record<ReplaceType, string> = {\r\n\treplaceWith: 'Replace with',\r\n\treplaceAll: 'Replace all with',\r\n};\r\n\r\n@customElement('up-doc-section-rules-editor-modal')\r\nexport class UpDocSectionRulesEditorModalElement extends UmbModalBaseElement<SectionRulesEditorModalData, SectionRulesEditorModalValue> {\r\n\t/** Flat array of all rules (grouped + ungrouped). Each carries _groupName for grouping. */\r\n\t@state() private _rules: EditableRule[] = [];\r\n\t/** Ordered list of group names. */\r\n\t@state() private _groupOrder: string[] = [];\r\n\t/** Track which inner sections are expanded (by \"section-ruleId\" key). All collapsed by default. */\r\n\t@state() private _expandedSections: Set<string> = new Set();\r\n\t/** Track which rules are expanded (by _id). All collapsed by default. */\r\n\t@state() private _expandedRules: Set<string> = new Set();\r\n\t/** Group currently being renamed (null = none). */\r\n\t@state() private _renamingGroup: string | null = null;\r\n\t@state() private _renameValue = '';\r\n\r\n\t#isSectionExpanded(section: string, ruleId: string): boolean {\r\n\t\treturn this._expandedSections.has(`${section}-${ruleId}`);\r\n\t}\r\n\r\n\t#toggleSection(section: string, ruleId: string) {\r\n\t\tconst key = `${section}-${ruleId}`;\r\n\t\tconst next = new Set(this._expandedSections);\r\n\t\tif (next.has(key)) {\r\n\t\t\tnext.delete(key);\r\n\t\t} else {\r\n\t\t\tnext.add(key);\r\n\t\t}\r\n\t\tthis._expandedSections = next;\r\n\t}\r\n\r\n\t#isRuleExpanded(ruleId: string): boolean {\r\n\t\treturn this._expandedRules.has(ruleId);\r\n\t}\r\n\r\n\t#toggleRuleExpanded(ruleId: string) {\r\n\t\tconst next = new Set(this._expandedRules);\r\n\t\tif (next.has(ruleId)) {\r\n\t\t\tnext.delete(ruleId);\r\n\t\t} else {\r\n\t\t\tnext.add(ruleId);\r\n\t\t}\r\n\t\tthis._expandedRules = next;\r\n\t}\r\n\r\n\t#expandRule(ruleId: string) {\r\n\t\tif (!this._expandedRules.has(ruleId)) {\r\n\t\t\tconst next = new Set(this._expandedRules);\r\n\t\t\tnext.add(ruleId);\r\n\t\t\tthis._expandedRules = next;\r\n\t\t}\r\n\t}\r\n\r\n\toverride firstUpdated() {\r\n\t\tconst areaRules = this.data?.existingRules;\r\n\t\tif (!areaRules) return;\r\n\r\n\t\tconst editableRules: EditableRule[] = [];\r\n\t\tconst groupOrder: string[] = [];\r\n\r\n\t\t// Grouped rules first\r\n\t\tfor (const group of (areaRules.groups ?? [])) {\r\n\t\t\tgroupOrder.push(group.name);\r\n\t\t\tfor (const rule of group.rules) {\r\n\t\t\t\teditableRules.push(this.#normalizeRule(rule, group.name));\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// Ungrouped rules\r\n\t\tfor (const rule of (areaRules.rules ?? [])) {\r\n\t\t\teditableRules.push(this.#normalizeRule(rule, null));\r\n\t\t}\r\n\r\n\t\tthis._rules = editableRules;\r\n\t\tthis._groupOrder = groupOrder;\r\n\t}\r\n\r\n\t/** Normalize a rule on load: derive part from legacy action, migrate formats. */\r\n\t#normalizeRule(rule: SectionRule, groupName: string | null): EditableRule {\r\n\t\tlet part = rule.part as RulePart | undefined;\r\n\t\tlet exclude = rule.exclude ?? false;\r\n\r\n\t\t// Normalize from legacy action field\r\n\t\tif (!part && !exclude) {\r\n\t\t\tconst derived = getEffectivePart(rule);\r\n\t\t\tif (derived === 'exclude') {\r\n\t\t\t\texclude = true;\r\n\t\t\t} else {\r\n\t\t\t\tpart = derived as RulePart;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// Migrate old single format to formats array\r\n\t\tlet formats = rule.formats;\r\n\t\tif (!formats || formats.length === 0) {\r\n\t\t\tconst blockValue = rule.format ?? getEffectiveFormat(rule);\r\n\t\t\tformats = [{ type: 'block' as FormatEntryType, value: blockValue }];\r\n\t\t}\r\n\r\n\t\treturn {\r\n\t\t\t...rule,\r\n\t\t\tpart,\r\n\t\t\texclude,\r\n\t\t\tformats,\r\n\t\t\t_id: generateRuleId(),\r\n\t\t\t_groupName: groupName,\r\n\t\t};\r\n\t}\r\n\r\n\tget #elements(): AreaElement[] {\r\n\t\treturn this.data?.elements ?? [];\r\n\t}\r\n\r\n\tget #sectionHeading(): string {\r\n\t\treturn this.data?.sectionHeading ?? 'Section';\r\n\t}\r\n\r\n\t/**\r\n\t * Returns a grouped view for rendering: groups in order, then ungrouped.\r\n\t */\r\n\tget #groupedView(): Array<{ group: string | null; rules: EditableRule[] }> {\r\n\t\tconst result: Array<{ group: string | null; rules: EditableRule[] }> = [];\r\n\r\n\t\t// Groups in order\r\n\t\tfor (const name of this._groupOrder) {\r\n\t\t\tresult.push({\r\n\t\t\t\tgroup: name,\r\n\t\t\t\trules: this._rules.filter((r) => r._groupName === name),\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\t// Ungrouped\r\n\t\tresult.push({\r\n\t\t\tgroup: null,\r\n\t\t\trules: this._rules.filter((r) => r._groupName === null),\r\n\t\t});\r\n\r\n\t\treturn result;\r\n\t}\r\n\r\n\t// ===== Rule evaluation (first-match-wins) =====\r\n\r\n\t/** Evaluate all rules against elements. Returns a map of elementId -> rule _id */\r\n\t#evaluateRules(): Map<string, string> {\r\n\t\tconst claimed = new Map<string, string>();\r\n\t\tconst elements = this.#elements;\r\n\r\n\t\tfor (const rule of this._rules) {\r\n\t\t\tif (rule.conditions.length === 0) continue;\r\n\r\n\t\t\tfor (let elIdx = 0; elIdx < elements.length; elIdx++) {\r\n\t\t\t\tconst el = elements[elIdx];\r\n\t\t\t\tif (claimed.has(el.id)) continue; // already claimed by an earlier rule\r\n\r\n\t\t\t\tif (this.#elementMatchesAllConditions(el, rule.conditions, elIdx, elements.length)) {\r\n\t\t\t\t\t// Check exceptions — if any exception matches, skip this element for this rule\r\n\t\t\t\t\tif (rule.exceptions?.length) {\r\n\t\t\t\t\t\tconst anyExceptionMatches = rule.exceptions.some((exc) =>\r\n\t\t\t\t\t\t\tthis.#elementMatchesCondition(el, exc, elIdx, elements.length),\r\n\t\t\t\t\t\t);\r\n\t\t\t\t\t\tif (anyExceptionMatches) continue;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tclaimed.set(el.id, rule._id);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn claimed;\r\n\t}\r\n\r\n\t#elementMatchesAllConditions(el: AreaElement, conditions: RuleCondition[], index: number, total: number): boolean {\r\n\t\treturn conditions.every((c) => this.#elementMatchesCondition(el, c, index, total));\r\n\t}\r\n\r\n\t#elementMatchesCondition(el: AreaElement, condition: RuleCondition, index: number, total: number): boolean {\r\n\t\tconst val = String(condition.value ?? '');\r\n\t\tconst numVal = Number(condition.value);\r\n\r\n\t\tswitch (condition.type) {\r\n\t\t\tcase 'textBeginsWith':\r\n\t\t\t\treturn el.text.toLowerCase().startsWith(val.toLowerCase());\r\n\t\t\tcase 'textEndsWith':\r\n\t\t\t\treturn el.text.toLowerCase().endsWith(val.toLowerCase());\r\n\t\t\tcase 'textContains':\r\n\t\t\t\treturn el.text.toLowerCase().includes(val.toLowerCase());\r\n\t\t\tcase 'textMatchesPattern':\r\n\t\t\t\ttry { return new RegExp(val, 'i').test(el.text); } catch { return false; }\r\n\t\t\tcase 'fontSizeEquals':\r\n\t\t\t\treturn !isNaN(numVal) && Math.abs(el.fontSize - numVal) < 0.5;\r\n\t\t\tcase 'fontSizeAbove':\r\n\t\t\t\treturn !isNaN(numVal) && el.fontSize > numVal;\r\n\t\t\tcase 'fontSizeBelow':\r\n\t\t\t\treturn !isNaN(numVal) && el.fontSize < numVal;\r\n\t\t\tcase 'fontNameContains':\r\n\t\t\t\treturn el.fontName.toLowerCase().includes(val.toLowerCase());\r\n\t\t\tcase 'colorEquals':\r\n\t\t\t\treturn el.color.toLowerCase() === val.toLowerCase();\r\n\t\t\tcase 'positionFirst':\r\n\t\t\t\treturn index === 0;\r\n\t\t\tcase 'positionLast':\r\n\t\t\t\treturn index === total - 1;\r\n\t\t\tdefault:\r\n\t\t\t\treturn false;\r\n\t\t}\r\n\t}\r\n\r\n\t// ===== Auto-populate conditions from an element =====\r\n\r\n\t#autoPopulateConditions(el: AreaElement, elIndex: number, total: number): RuleCondition[] {\r\n\t\tconst conditions: RuleCondition[] = [];\r\n\r\n\t\t// Font size\r\n\t\tconditions.push({ type: 'fontSizeEquals', value: el.fontSize });\r\n\r\n\t\t// Font name — strip PDF subset prefix (e.g. \"GHEALP+Clarendon\" → \"Clarendon\")\r\n\t\tif (el.fontName) {\r\n\t\t\tconst fontName = el.fontName.includes('+') ? el.fontName.substring(el.fontName.indexOf('+') + 1) : el.fontName;\r\n\t\t\tconditions.push({ type: 'fontNameContains', value: fontName });\r\n\t\t}\r\n\r\n\t\t// Color (skip black/very dark as it's the default)\r\n\t\tif (el.color && el.color.toLowerCase() !== '#000000' && el.color.toLowerCase() !== '#000') {\r\n\t\t\tconditions.push({ type: 'colorEquals', value: el.color });\r\n\t\t}\r\n\r\n\t\t// Text prefix — if text contains a colon, use \"begins with\" up to the colon\r\n\t\tconst colonIdx = el.text.indexOf(':');\r\n\t\tif (colonIdx > 0 && colonIdx < 30) {\r\n\t\t\tconditions.push({ type: 'textBeginsWith', value: el.text.substring(0, colonIdx + 1) });\r\n\t\t}\r\n\r\n\t\t// Position\r\n\t\tif (elIndex === 0) {\r\n\t\t\tconditions.push({ type: 'positionFirst' });\r\n\t\t} else if (elIndex === total - 1) {\r\n\t\t\tconditions.push({ type: 'positionLast' });\r\n\t\t}\r\n\r\n\t\treturn conditions;\r\n\t}\r\n\r\n\t// ===== Rule CRUD =====\r\n\r\n\t/** Generic helper: update a single rule by _id. */\r\n\t#updateRuleById(id: string, updater: (rule: EditableRule) => EditableRule) {\r\n\t\tthis._rules = this._rules.map((r) => r._id === id ? updater(r) : r);\r\n\t}\r\n\r\n\t#addRule(groupName: string | null = null) {\r\n\t\tconst id = generateRuleId();\r\n\t\tthis._rules = [...this._rules, {\r\n\t\t\trole: '',\r\n\t\t\tpart: 'content' as RulePart,\r\n\t\t\tconditions: [],\r\n\t\t\tformats: [{ type: 'block' as FormatEntryType, value: 'auto' }],\r\n\t\t\t_id: id,\r\n\t\t\t_groupName: groupName,\r\n\t\t}];\r\n\t\t// Auto-expand new rules so user can fill in details\r\n\t\tthis.#expandRule(id);\r\n\t}\r\n\r\n\t#removeRuleById(id: string) {\r\n\t\tthis._rules = this._rules.filter((r) => r._id !== id);\r\n\t}\r\n\r\n\t#createRuleFromElement(el: AreaElement, elIndex: number) {\r\n\t\tconst conditions = this.#autoPopulateConditions(el, elIndex, this.#elements.length);\r\n\t\t// Derive a role name suggestion from text (kebab-case first few words)\r\n\t\tconst roleSuggestion = el.text\r\n\t\t\t.split(/[\\s:,]+/)\r\n\t\t\t.slice(0, 3)\r\n\t\t\t.join('-')\r\n\t\t\t.toLowerCase()\r\n\t\t\t.replace(/[^a-z0-9-]/g, '');\r\n\t\tconst id = generateRuleId();\r\n\t\tthis._rules = [...this._rules, {\r\n\t\t\trole: roleSuggestion,\r\n\t\t\tpart: 'content' as RulePart,\r\n\t\t\tconditions,\r\n\t\t\tformats: [{ type: 'block' as FormatEntryType, value: 'auto' }],\r\n\t\t\t_id: id,\r\n\t\t\t_groupName: null,\r\n\t\t}];\r\n\t\t// Auto-expand so user can review auto-populated conditions\r\n\t\tthis.#expandRule(id);\r\n\t}\r\n\r\n\t#updateRoleName(id: string, value: string) {\r\n\t\tthis.#updateRuleById(id, (r) => ({ ...r, role: value }));\r\n\t}\r\n\r\n\t#updatePart(id: string, value: RulePart) {\r\n\t\tthis.#updateRuleById(id, (r) => ({ ...r, part: value }));\r\n\t}\r\n\r\n\t#updateExclude(id: string, value: boolean) {\r\n\t\tthis.#updateRuleById(id, (r) => ({ ...r, exclude: value }));\r\n\t}\r\n\r\n\t// ===== Group CRUD =====\r\n\r\n\t#addGroup() {\r\n\t\tlet name = 'New Group';\r\n\t\tlet counter = 1;\r\n\t\twhile (this._groupOrder.includes(name)) {\r\n\t\t\tname = `New Group ${++counter}`;\r\n\t\t}\r\n\t\tthis._groupOrder = [...this._groupOrder, name];\r\n\t\t// Immediately enter rename mode\r\n\t\tthis._renamingGroup = name;\r\n\t\tthis._renameValue = name;\r\n\t}\r\n\r\n\t#startRenameGroup(name: string) {\r\n\t\tthis._renamingGroup = name;\r\n\t\tthis._renameValue = name;\r\n\t}\r\n\r\n\t#confirmRenameGroup() {\r\n\t\tif (!this._renamingGroup || !this._renameValue.trim()) return;\r\n\t\tconst oldName = this._renamingGroup;\r\n\t\tconst newName = this._renameValue.trim();\r\n\r\n\t\tif (oldName !== newName) {\r\n\t\t\t// Update group order\r\n\t\t\tthis._groupOrder = this._groupOrder.map((n) => n === oldName ? newName : n);\r\n\t\t\t// Update all rules in this group\r\n\t\t\tthis._rules = this._rules.map((r) =>\r\n\t\t\t\tr._groupName === oldName ? { ...r, _groupName: newName } : r,\r\n\t\t\t);\r\n\t\t}\r\n\t\tthis._renamingGroup = null;\r\n\t\tthis._renameValue = '';\r\n\t}\r\n\r\n\t#cancelRenameGroup() {\r\n\t\tthis._renamingGroup = null;\r\n\t\tthis._renameValue = '';\r\n\t}\r\n\r\n\t#deleteGroup(name: string) {\r\n\t\t// Move all rules from this group to ungrouped\r\n\t\tthis._rules = this._rules.map((r) =>\r\n\t\t\tr._groupName === name ? { ...r, _groupName: null } : r,\r\n\t\t);\r\n\t\tthis._groupOrder = this._groupOrder.filter((n) => n !== name);\r\n\t}\r\n\r\n\t// ===== Drag-and-drop sort handling =====\r\n\r\n\t/**\r\n\t * Handles sort-change from an <updoc-sortable-rules> container.\r\n\t * Rebuilds the flat _rules array: rules arriving in this container get\r\n\t * their _groupName set; rules no longer in this container but still in\r\n\t * _rules keep their existing _groupName.\r\n\t */\r\n\t#onSortChange(groupName: string | null, e: CustomEvent<SortChangeDetail>) {\r\n\t\tconst newRules = e.detail.rules as EditableRule[];\r\n\t\tconst newRuleIds = new Set(newRules.map((r) => r._id));\r\n\r\n\t\t// Rebuild flat array: groups in order, then ungrouped\r\n\t\tconst allRules: EditableRule[] = [];\r\n\r\n\t\tfor (const gName of this._groupOrder) {\r\n\t\t\tif (gName === groupName) {\r\n\t\t\t\t// Use the new order for this group, set _groupName\r\n\t\t\t\tallRules.push(...newRules.map((r) => ({ ...r, _groupName: gName })));\r\n\t\t\t} else {\r\n\t\t\t\t// Keep existing rules for other groups, exclude any that moved into the changed container\r\n\t\t\t\tallRules.push(...this._rules.filter((r) => r._groupName === gName && !newRuleIds.has(r._id)));\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// Ungrouped\r\n\t\tif (groupName === null) {\r\n\t\t\tallRules.push(...newRules.map((r) => ({ ...r, _groupName: null })));\r\n\t\t} else {\r\n\t\t\tallRules.push(...this._rules.filter((r) => r._groupName === null && !newRuleIds.has(r._id)));\r\n\t\t}\r\n\r\n\t\tthis._rules = allRules;\r\n\t}\r\n\r\n\t// ===== Format entry CRUD =====\r\n\r\n\t#addFormatEntry(id: string) {\r\n\t\tthis.#updateRuleById(id, (r) => ({\r\n\t\t\t...r,\r\n\t\t\tformats: [...(r.formats ?? []), { type: 'block' as FormatEntryType, value: 'auto' }],\r\n\t\t}));\r\n\t}\r\n\r\n\t#removeFormatEntry(id: string, fmtIdx: number) {\r\n\t\tthis.#updateRuleById(id, (r) => ({\r\n\t\t\t...r,\r\n\t\t\tformats: (r.formats ?? []).filter((_, i) => i !== fmtIdx),\r\n\t\t}));\r\n\t}\r\n\r\n\t#updateFormatEntryType(id: string, fmtIdx: number, type: FormatEntryType) {\r\n\t\tconst defaultValue = type === 'block' ? 'auto' : 'bold';\r\n\t\tthis.#updateRuleById(id, (r) => {\r\n\t\t\tconst formats = [...(r.formats ?? [])];\r\n\t\t\tformats[fmtIdx] = { type, value: defaultValue };\r\n\t\t\treturn { ...r, formats };\r\n\t\t});\r\n\t}\r\n\r\n\t#updateFormatEntryValue(id: string, fmtIdx: number, value: string) {\r\n\t\tthis.#updateRuleById(id, (r) => {\r\n\t\t\tconst formats = [...(r.formats ?? [])];\r\n\t\t\tformats[fmtIdx] = { ...formats[fmtIdx], value: value as FormatEntry['value'] };\r\n\t\t\treturn { ...r, formats };\r\n\t\t});\r\n\t}\r\n\r\n\t#addCondition(id: string) {\r\n\t\tthis.#updateRuleById(id, (r) => ({\r\n\t\t\t...r,\r\n\t\t\tconditions: [...r.conditions, { type: 'textBeginsWith' as RuleConditionType, value: '' }],\r\n\t\t}));\r\n\t}\r\n\r\n\t#removeCondition(id: string, condIdx: number) {\r\n\t\tthis.#updateRuleById(id, (r) => ({\r\n\t\t\t...r,\r\n\t\t\tconditions: r.conditions.filter((_, i) => i !== condIdx),\r\n\t\t}));\r\n\t}\r\n\r\n\t#updateConditionType(id: string, condIdx: number, type: RuleConditionType) {\r\n\t\tthis.#updateRuleById(id, (r) => {\r\n\t\t\tconst conditions = [...r.conditions];\r\n\t\t\tconditions[condIdx] = {\r\n\t\t\t\ttype,\r\n\t\t\t\tvalue: VALUELESS_CONDITIONS.includes(type) ? undefined : conditions[condIdx].value,\r\n\t\t\t};\r\n\t\t\treturn { ...r, conditions };\r\n\t\t});\r\n\t}\r\n\r\n\t#updateConditionValue(id: string, condIdx: number, value: string) {\r\n\t\tthis.#updateRuleById(id, (r) => {\r\n\t\t\tconst conditions = [...r.conditions];\r\n\t\t\tconst cond = conditions[condIdx];\r\n\t\t\tconst isNumeric = cond.type === 'fontSizeEquals' || cond.type === 'fontSizeAbove' || cond.type === 'fontSizeBelow';\r\n\t\t\tconditions[condIdx] = { ...cond, value: isNumeric && !isNaN(Number(value)) ? Number(value) : value };\r\n\t\t\treturn { ...r, conditions };\r\n\t\t});\r\n\t}\r\n\r\n\t// ===== Exception CRUD =====\r\n\r\n\t#addException(id: string) {\r\n\t\tthis.#updateRuleById(id, (r) => ({\r\n\t\t\t...r,\r\n\t\t\texceptions: [...(r.exceptions ?? []), { type: 'textContains' as RuleConditionType, value: '' }],\r\n\t\t}));\r\n\t}\r\n\r\n\t#removeException(id: string, excIdx: number) {\r\n\t\tthis.#updateRuleById(id, (r) => ({\r\n\t\t\t...r,\r\n\t\t\texceptions: (r.exceptions ?? []).filter((_, i) => i !== excIdx),\r\n\t\t}));\r\n\t}\r\n\r\n\t#updateExceptionType(id: string, excIdx: number, type: RuleConditionType) {\r\n\t\tthis.#updateRuleById(id, (r) => {\r\n\t\t\tconst exceptions = [...(r.exceptions ?? [])];\r\n\t\t\texceptions[excIdx] = {\r\n\t\t\t\ttype,\r\n\t\t\t\tvalue: VALUELESS_CONDITIONS.includes(type) ? undefined : exceptions[excIdx].value,\r\n\t\t\t};\r\n\t\t\treturn { ...r, exceptions };\r\n\t\t});\r\n\t}\r\n\r\n\t#updateExceptionValue(id: string, excIdx: number, value: string) {\r\n\t\tthis.#updateRuleById(id, (r) => {\r\n\t\t\tconst exceptions = [...(r.exceptions ?? [])];\r\n\t\t\tconst exc = exceptions[excIdx];\r\n\t\t\tconst isNumeric = exc.type === 'fontSizeEquals' || exc.type === 'fontSizeAbove' || exc.type === 'fontSizeBelow';\r\n\t\t\texceptions[excIdx] = { ...exc, value: isNumeric && !isNaN(Number(value)) ? Number(value) : value };\r\n\t\t\treturn { ...r, exceptions };\r\n\t\t});\r\n\t}\r\n\r\n\t// ===== Text Replacement CRUD =====\r\n\r\n\t#addTextReplacement(id: string) {\r\n\t\tthis.#updateRuleById(id, (r) => ({\r\n\t\t\t...r,\r\n\t\t\ttextReplacements: [...(r.textReplacements ?? []), { findType: 'textBeginsWith' as FindType, find: '', replaceType: 'replaceWith' as ReplaceType, replace: '' }],\r\n\t\t}));\r\n\t}\r\n\r\n\t#removeTextReplacement(id: string, trIdx: number) {\r\n\t\tthis.#updateRuleById(id, (r) => ({\r\n\t\t\t...r,\r\n\t\t\ttextReplacements: (r.textReplacements ?? []).filter((_, i) => i !== trIdx),\r\n\t\t}));\r\n\t}\r\n\r\n\t#updateTextReplacementFindType(id: string, trIdx: number, findType: FindType) {\r\n\t\tthis.#updateRuleById(id, (r) => {\r\n\t\t\tconst trs = [...(r.textReplacements ?? [])];\r\n\t\t\t// Auto-set replaceType based on findType\r\n\t\t\tconst replaceType: ReplaceType = findType === 'textContains' ? 'replaceAll' : 'replaceWith';\r\n\t\t\ttrs[trIdx] = { ...trs[trIdx], findType, replaceType };\r\n\t\t\treturn { ...r, textReplacements: trs };\r\n\t\t});\r\n\t}\r\n\r\n\t#updateTextReplacementFind(id: string, trIdx: number, find: string) {\r\n\t\tthis.#updateRuleById(id, (r) => {\r\n\t\t\tconst trs = [...(r.textReplacements ?? [])];\r\n\t\t\ttrs[trIdx] = { ...trs[trIdx], find };\r\n\t\t\treturn { ...r, textReplacements: trs };\r\n\t\t});\r\n\t}\r\n\r\n\t#updateTextReplacementReplaceType(id: string, trIdx: number, replaceType: ReplaceType) {\r\n\t\tthis.#updateRuleById(id, (r) => {\r\n\t\t\tconst trs = [...(r.textReplacements ?? [])];\r\n\t\t\ttrs[trIdx] = { ...trs[trIdx], replaceType };\r\n\t\t\treturn { ...r, textReplacements: trs };\r\n\t\t});\r\n\t}\r\n\r\n\t#updateTextReplacementReplace(id: string, trIdx: number, replace: string) {\r\n\t\tthis.#updateRuleById(id, (r) => {\r\n\t\t\tconst trs = [...(r.textReplacements ?? [])];\r\n\t\t\ttrs[trIdx] = { ...trs[trIdx], replace };\r\n\t\t\treturn { ...r, textReplacements: trs };\r\n\t\t});\r\n\t}\r\n\r\n\t// ===== Submit =====\r\n\r\n\t/** Strip transient fields and sync format for C# compatibility. */\r\n\t#cleanRule(rule: EditableRule): SectionRule {\r\n\t\tconst blockEntry = (rule.formats ?? []).find((f) => f.type === 'block');\r\n\t\t// eslint-disable-next-line @typescript-eslint/no-unused-vars\r\n\t\tconst { _id, _groupName, action, ...clean } = rule;\r\n\t\treturn {\r\n\t\t\t...clean,\r\n\t\t\tformat: (blockEntry?.value ?? 'auto') as BlockFormat,\r\n\t\t};\r\n\t}\r\n\r\n\t#buildRulesValue(): AreaRules {\r\n\t\t// Auto-confirm any pending group rename before building value\r\n\t\tif (this._renamingGroup) {\r\n\t\t\tthis.#confirmRenameGroup();\r\n\t\t}\r\n\r\n\t\tconst groups: RuleGroup[] = [];\r\n\t\tfor (const name of this._groupOrder) {\r\n\t\t\tconst groupRules = this._rules\r\n\t\t\t\t.filter((r) => r._groupName === name)\r\n\t\t\t\t.map((r) => this.#cleanRule(r));\r\n\t\t\tgroups.push({ name, rules: groupRules });\r\n\t\t}\r\n\t\tconst ungroupedRules = this._rules\r\n\t\t\t.filter((r) => r._groupName === null)\r\n\t\t\t.map((r) => this.#cleanRule(r));\r\n\r\n\t\treturn { groups, rules: ungroupedRules };\r\n\t}\r\n\r\n\tasync #onSave() {\r\n\t\tconst rules = this.#buildRulesValue();\r\n\t\tif (this.data?.onSave) {\r\n\t\t\tawait this.data.onSave(rules);\r\n\t\t}\r\n\t}\r\n\r\n\t#onSaveAndClose() {\r\n\t\tconst rules = this.#buildRulesValue();\r\n\t\tthis.value = { rules };\r\n\t\tthis.modalContext?.submit();\r\n\t}\r\n\r\n\t#onClose() {\r\n\t\tthis.modalContext?.reject();\r\n\t}\r\n\r\n\t// ===== Rendering =====\r\n\r\n\t#renderConditionRow(ruleId: string, condIdx: number, condition: RuleCondition) {\r\n\t\tconst isValueless = VALUELESS_CONDITIONS.includes(condition.type);\r\n\t\treturn html`\r\n\t\t\t<div class=\"condition-row\">\r\n\t\t\t\t<select\r\n\t\t\t\t\tclass=\"condition-type-select\"\r\n\t\t\t\t\t.value=${condition.type}\r\n\t\t\t\t\t@change=${(e: Event) => this.#updateConditionType(ruleId, condIdx, (e.target as HTMLSelectElement).value as RuleConditionType)}>\r\n\t\t\t\t\t${ALL_CONDITION_TYPES.map((t) => html`\r\n\t\t\t\t\t\t<option value=${t} ?selected=${t === condition.type}>${CONDITION_LABELS[t]}</option>\r\n\t\t\t\t\t`)}\r\n\t\t\t\t</select>\r\n\t\t\t\t${isValueless ? nothing : html`\r\n\t\t\t\t\t<input\r\n\t\t\t\t\t\ttype=\"text\"\r\n\t\t\t\t\t\tclass=\"condition-value-input\"\r\n\t\t\t\t\t\tplaceholder=\"Value...\"\r\n\t\t\t\t\t\t.value=${String(condition.value ?? '')}\r\n\t\t\t\t\t\t@input=${(e: Event) => this.#updateConditionValue(ruleId, condIdx, (e.target as HTMLInputElement).value)} />\r\n\t\t\t\t`}\r\n\t\t\t\t<uui-button\r\n\t\t\t\t\tcompact\r\n\t\t\t\t\tlook=\"secondary\"\r\n\t\t\t\t\tlabel=\"Remove condition\"\r\n\t\t\t\t\t@click=${() => this.#removeCondition(ruleId, condIdx)}>\r\n\t\t\t\t\t<uui-icon name=\"icon-trash\"></uui-icon>\r\n\t\t\t\t</uui-button>\r\n\t\t\t</div>\r\n\t\t`;\r\n\t}\r\n\r\n\t#renderExceptionRow(ruleId: string, excIdx: number, exception: RuleCondition) {\r\n\t\tconst isValueless = VALUELESS_CONDITIONS.includes(exception.type);\r\n\t\treturn html`\r\n\t\t\t<div class=\"condition-row\">\r\n\t\t\t\t<select\r\n\t\t\t\t\tclass=\"condition-type-select\"\r\n\t\t\t\t\t.value=${exception.type}\r\n\t\t\t\t\t@change=${(e: Event) => this.#updateExceptionType(ruleId, excIdx, (e.target as HTMLSelectElement).value as RuleConditionType)}>\r\n\t\t\t\t\t${ALL_CONDITION_TYPES.map((t) => html`\r\n\t\t\t\t\t\t<option value=${t} ?selected=${t === exception.type}>${CONDITION_LABELS[t]}</option>\r\n\t\t\t\t\t`)}\r\n\t\t\t\t</select>\r\n\t\t\t\t${isValueless ? nothing : html`\r\n\t\t\t\t\t<input\r\n\t\t\t\t\t\ttype=\"text\"\r\n\t\t\t\t\t\tclass=\"condition-value-input\"\r\n\t\t\t\t\t\tplaceholder=\"Value...\"\r\n\t\t\t\t\t\t.value=${String(exception.value ?? '')}\r\n\t\t\t\t\t\t@input=${(e: Event) => this.#updateExceptionValue(ruleId, excIdx, (e.target as HTMLInputElement).value)} />\r\n\t\t\t\t`}\r\n\t\t\t\t<uui-button\r\n\t\t\t\t\tcompact\r\n\t\t\t\t\tlook=\"secondary\"\r\n\t\t\t\t\tlabel=\"Remove exception\"\r\n\t\t\t\t\t@click=${() => this.#removeException(ruleId, excIdx)}>\r\n\t\t\t\t\t<uui-icon name=\"icon-trash\"></uui-icon>\r\n\t\t\t\t</uui-button>\r\n\t\t\t</div>\r\n\t\t`;\r\n\t}\r\n\r\n\t#renderFormatRow(ruleId: string, fmtIdx: number, entry: FormatEntry) {\r\n\t\tconst valueOptions = entry.type === 'block' ? ALL_BLOCK_FORMATS : ALL_STYLE_FORMATS;\r\n\t\tconst valueLabels = entry.type === 'block' ? BLOCK_FORMAT_LABELS : STYLE_FORMAT_LABELS;\r\n\r\n\t\treturn html`\r\n\t\t\t<div class=\"condition-row\">\r\n\t\t\t\t<select\r\n\t\t\t\t\tclass=\"format-type-select\"\r\n\t\t\t\t\t.value=${entry.type}\r\n\t\t\t\t\t@change=${(e: Event) => this.#updateFormatEntryType(ruleId, fmtIdx, (e.target as HTMLSelectElement).value as FormatEntryType)}>\r\n\t\t\t\t\t${ALL_FORMAT_ENTRY_TYPES.map((t) => html`\r\n\t\t\t\t\t\t<option value=${t} ?selected=${t === entry.type}>${FORMAT_ENTRY_TYPE_LABELS[t]}</option>\r\n\t\t\t\t\t`)}\r\n\t\t\t\t</select>\r\n\t\t\t\t<select\r\n\t\t\t\t\tclass=\"format-value-select\"\r\n\t\t\t\t\t.value=${entry.value}\r\n\t\t\t\t\t@change=${(e: Event) => this.#updateFormatEntryValue(ruleId, fmtIdx, (e.target as HTMLSelectElement).value)}>\r\n\t\t\t\t\t${valueOptions.map((v) => html`\r\n\t\t\t\t\t\t<option value=${v} ?selected=${v === entry.value}>${valueLabels[v]}</option>\r\n\t\t\t\t\t`)}\r\n\t\t\t\t</select>\r\n\t\t\t\t<uui-button\r\n\t\t\t\t\tcompact\r\n\t\t\t\t\tlook=\"secondary\"\r\n\t\t\t\t\tlabel=\"Remove format\"\r\n\t\t\t\t\t@click=${() => this.#removeFormatEntry(ruleId, fmtIdx)}>\r\n\t\t\t\t\t<uui-icon name=\"icon-trash\"></uui-icon>\r\n\t\t\t\t</uui-button>\r\n\t\t\t</div>\r\n\t\t`;\r\n\t}\r\n\r\n\t#renderTextReplacementRow(ruleId: string, trIdx: number, tr: TextReplacement) {\r\n\t\tconst replaceLabel = tr.findType === 'textContains'\r\n\t\t\t? REPLACE_TYPE_LABELS['replaceAll']\r\n\t\t\t: REPLACE_TYPE_LABELS['replaceWith'];\r\n\r\n\t\treturn html`\r\n\t\t\t<div class=\"find-replace-entry\">\r\n\t\t\t\t<div class=\"condition-row\">\r\n\t\t\t\t\t<select\r\n\t\t\t\t\t\tclass=\"condition-type-select\"\r\n\t\t\t\t\t\t.value=${tr.findType}\r\n\t\t\t\t\t\t@change=${(e: Event) => this.#updateTextReplacementFindType(ruleId, trIdx, (e.target as HTMLSelectElement).value as FindType)}>\r\n\t\t\t\t\t\t${ALL_FIND_TYPES.map((t) => html`\r\n\t\t\t\t\t\t\t<option value=${t} ?selected=${t === tr.findType}>${FIND_TYPE_LABELS[t]}</option>\r\n\t\t\t\t\t\t`)}\r\n\t\t\t\t\t</select>\r\n\t\t\t\t\t<input\r\n\t\t\t\t\t\ttype=\"text\"\r\n\t\t\t\t\t\tclass=\"condition-value-input\"\r\n\t\t\t\t\t\tplaceholder=\"Find...\"\r\n\t\t\t\t\t\t.value=${tr.find}\r\n\t\t\t\t\t\t@input=${(e: Event) => this.#updateTextReplacementFind(ruleId, trIdx, (e.target as HTMLInputElement).value)} />\r\n\t\t\t\t\t<uui-button\r\n\t\t\t\t\t\tcompact\r\n\t\t\t\t\t\tlook=\"secondary\"\r\n\t\t\t\t\t\tlabel=\"Remove replacement\"\r\n\t\t\t\t\t\t@click=${() => this.#removeTextReplacement(ruleId, trIdx)}>\r\n\t\t\t\t\t\t<uui-icon name=\"icon-trash\"></uui-icon>\r\n\t\t\t\t\t</uui-button>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div class=\"condition-row\">\r\n\t\t\t\t\t<span class=\"replace-label\">${replaceLabel}</span>\r\n\t\t\t\t\t<input\r\n\t\t\t\t\t\ttype=\"text\"\r\n\t\t\t\t\t\tclass=\"condition-value-input\"\r\n\t\t\t\t\t\tplaceholder=\"(empty = remove)\"\r\n\t\t\t\t\t\t.value=${tr.replace}\r\n\t\t\t\t\t\t@input=${(e: Event) => this.#updateTextReplacementReplace(ruleId, trIdx, (e.target as HTMLInputElement).value)} />\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t`;\r\n\t}\r\n\r\n\t#renderRuleCard(rule: EditableRule, matchedElements: AreaElement[]) {\r\n\t\tconst isExpanded = this.#isRuleExpanded(rule._id);\r\n\r\n\t\tif (!isExpanded) {\r\n\t\t\treturn this.#renderCollapsedRule(rule, matchedElements);\r\n\t\t}\r\n\r\n\t\treturn this.#renderExpandedRule(rule, matchedElements);\r\n\t}\r\n\r\n\t#renderCollapsedRule(rule: EditableRule, matchedElements: AreaElement[]) {\r\n\t\tconst isExcluded = rule.exclude;\r\n\t\tconst currentPart = rule.part ?? 'content';\r\n\t\tconst partLabel = isExcluded ? 'Exclude' : PART_LABELS[currentPart] ?? currentPart;\r\n\t\tconst matchCount = matchedElements.length;\r\n\t\tconst roleName = rule.role || '(unnamed rule)';\r\n\r\n\t\treturn html`\r\n\t\t\t<div class=\"rule-row\" @click=${() => this.#toggleRuleExpanded(rule._id)}>\r\n\t\t\t\t<span class=\"rule-grip\" title=\"Drag to reorder\" @click=${(e: Event) => e.stopPropagation()}>⠿</span>\r\n\t\t\t\t<span class=\"rule-row-name\">${roleName}</span>\r\n\t\t\t\t<span class=\"rule-row-part ${isExcluded ? 'excluded' : ''}\">${partLabel}</span>\r\n\t\t\t\t${matchCount > 0\r\n\t\t\t\t\t? html`<span class=\"rule-row-match ${isExcluded ? 'excluded' : 'matched'}\">${matchCount}&times;</span>`\r\n\t\t\t\t\t: html`<span class=\"rule-row-match no-match\">0</span>`}\r\n\t\t\t\t<uui-action-bar class=\"rule-row-actions\"\r\n\t\t\t\t\t@click=${(e: Event) => e.stopPropagation()}>\r\n\t\t\t\t\t<uui-button pristine look=\"primary\" label=\"Edit rule\"\r\n\t\t\t\t\t\t@click=${() => this.#toggleRuleExpanded(rule._id)}>\r\n\t\t\t\t\t\t<uui-icon name=\"icon-edit\"></uui-icon>\r\n\t\t\t\t\t</uui-button>\r\n\t\t\t\t\t<uui-button pristine look=\"primary\" label=\"Delete rule\"\r\n\t\t\t\t\t\t@click=${() => this.#removeRuleById(rule._id)}>\r\n\t\t\t\t\t\t<uui-icon name=\"icon-trash\"></uui-icon>\r\n\t\t\t\t\t</uui-button>\r\n\t\t\t\t</uui-action-bar>\r\n\t\t\t</div>\r\n\t\t`;\r\n\t}\r\n\r\n\t#renderExpandedRule(rule: EditableRule, matchedElements: AreaElement[]) {\r\n\t\tconst isExcluded = rule.exclude;\r\n\t\tconst currentPart = rule.part ?? 'content';\r\n\t\tconst id = rule._id;\r\n\r\n\t\treturn html`\r\n\t\t\t<div class=\"rule-card\">\r\n\t\t\t\t<div class=\"rule-header\">\r\n\t\t\t\t\t<uui-icon class=\"rule-row-chevron expanded\" name=\"icon-navigation-down\"\r\n\t\t\t\t\t\t@click=${() => this.#toggleRuleExpanded(id)}\r\n\t\t\t\t\t\tstyle=\"cursor:pointer\"></uui-icon>\r\n\t\t\t\t\t<input\r\n\t\t\t\t\t\ttype=\"text\"\r\n\t\t\t\t\t\tclass=\"role-name-input\"\r\n\t\t\t\t\t\tplaceholder=\"Section name (e.g. tour-title)\"\r\n\t\t\t\t\t\t.value=${rule.role}\r\n\t\t\t\t\t\t@input=${(e: Event) => this.#updateRoleName(id, (e.target as HTMLInputElement).value)} />\r\n\t\t\t\t\t<uui-button\r\n\t\t\t\t\t\tcompact\r\n\t\t\t\t\t\tlook=\"secondary\"\r\n\t\t\t\t\t\tcolor=\"danger\"\r\n\t\t\t\t\t\tlabel=\"Remove rule\"\r\n\t\t\t\t\t\t@click=${() => this.#removeRuleById(id)}>\r\n\t\t\t\t\t\t<uui-icon name=\"icon-trash\"></uui-icon>\r\n\t\t\t\t\t</uui-button>\r\n\t\t\t\t</div>\r\n\r\n\t\t\t\t<div class=\"conditions-area\">\r\n\t\t\t\t\t<div class=\"section-header collapsible\" @click=${() => this.#toggleSection('conditions', id)}>\r\n\t\t\t\t\t\t<uui-icon name=${this.#isSectionExpanded('conditions', id) ? 'icon-navigation-down' : 'icon-navigation-right'}></uui-icon>\r\n\t\t\t\t\t\tConditions${rule.conditions.length > 0 ? ` (${rule.conditions.length})` : ''}\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t${this.#isSectionExpanded('conditions', id) ? html`\r\n\t\t\t\t\t\t${rule.conditions.map((cond, cIdx) => this.#renderConditionRow(id, cIdx, cond))}\r\n\t\t\t\t\t\t<uui-button\r\n\t\t\t\t\t\t\tcompact\r\n\t\t\t\t\t\t\tlook=\"placeholder\"\r\n\t\t\t\t\t\t\tlabel=\"Add condition\"\r\n\t\t\t\t\t\t\t@click=${() => this.#addCondition(id)}>\r\n\t\t\t\t\t\t\t+ Add condition\r\n\t\t\t\t\t\t</uui-button>\r\n\t\t\t\t\t` : nothing}\r\n\t\t\t\t</div>\r\n\r\n\t\t\t\t<div class=\"exceptions-area\">\r\n\t\t\t\t\t<div class=\"section-header collapsible\" @click=${() => this.#toggleSection('exceptions', id)}>\r\n\t\t\t\t\t\t<uui-icon name=${this.#isSectionExpanded('exceptions', id) ? 'icon-navigation-down' : 'icon-navigation-right'}></uui-icon>\r\n\t\t\t\t\t\tExceptions${(rule.exceptions ?? []).length > 0 ? ` (${(rule.exceptions ?? []).length})` : ''}\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t${this.#isSectionExpanded('exceptions', id) ? html`\r\n\t\t\t\t\t\t${(rule.exceptions ?? []).map((exc, eIdx) => this.#renderExceptionRow(id, eIdx, exc))}\r\n\t\t\t\t\t\t<uui-button\r\n\t\t\t\t\t\t\tcompact\r\n\t\t\t\t\t\t\tlook=\"placeholder\"\r\n\t\t\t\t\t\t\tlabel=\"Add exception\"\r\n\t\t\t\t\t\t\t@click=${() => this.#addException(id)}>\r\n\t\t\t\t\t\t\t+ Add exception\r\n\t\t\t\t\t\t</uui-button>\r\n\t\t\t\t\t` : nothing}\r\n\t\t\t\t</div>\r\n\r\n\t\t\t\t<div class=\"part-area\">\r\n\t\t\t\t\t<div class=\"section-header collapsible\" @click=${() => this.#toggleSection('part', id)}>\r\n\t\t\t\t\t\t<uui-icon name=${this.#isSectionExpanded('part', id) ? 'icon-navigation-down' : 'icon-navigation-right'}></uui-icon>\r\n\t\t\t\t\t\tPart\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t${this.#isSectionExpanded('part', id) ? html`\r\n\t\t\t\t\t\t<div class=\"part-controls\">\r\n\t\t\t\t\t\t\t<select\r\n\t\t\t\t\t\t\t\tclass=\"part-select\"\r\n\t\t\t\t\t\t\t\t.value=${currentPart}\r\n\t\t\t\t\t\t\t\t?disabled=${isExcluded}\r\n\t\t\t\t\t\t\t\t@change=${(e: Event) => this.#updatePart(id, (e.target as HTMLSelectElement).value as RulePart)}>\r\n\t\t\t\t\t\t\t\t${ALL_PARTS.map((p) => html`\r\n\t\t\t\t\t\t\t\t\t<option value=${p} ?selected=${p === currentPart}>${PART_LABELS[p]}</option>\r\n\t\t\t\t\t\t\t\t`)}\r\n\t\t\t\t\t\t\t</select>\r\n\t\t\t\t\t\t\t<label class=\"exclude-label\">\r\n\t\t\t\t\t\t\t\t<input\r\n\t\t\t\t\t\t\t\t\ttype=\"checkbox\"\r\n\t\t\t\t\t\t\t\t\t.checked=${isExcluded}\r\n\t\t\t\t\t\t\t\t\t@change=${(e: Event) => this.#updateExclude(id, (e.target as HTMLInputElement).checked)} />\r\n\t\t\t\t\t\t\t\tExclude\r\n\t\t\t\t\t\t\t</label>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t` : nothing}\r\n\t\t\t\t</div>\r\n\r\n\t\t\t\t${!isExcluded ? html`\r\n\t\t\t\t<div class=\"format-area\">\r\n\t\t\t\t\t<div class=\"section-header collapsible\" @click=${() => this.#toggleSection('format', id)}>\r\n\t\t\t\t\t\t<uui-icon name=${this.#isSectionExpanded('format', id) ? 'icon-navigation-down' : 'icon-navigation-right'}></uui-icon>\r\n\t\t\t\t\t\tFormat${(rule.formats ?? []).length > 0 ? ` (${(rule.formats ?? []).length})` : ''}\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t${this.#isSectionExpanded('format', id) ? html`\r\n\t\t\t\t\t\t${(rule.formats ?? []).map((fmt, fIdx) => this.#renderFormatRow(id, fIdx, fmt))}\r\n\t\t\t\t\t\t<uui-button\r\n\t\t\t\t\t\t\tcompact\r\n\t\t\t\t\t\t\tlook=\"placeholder\"\r\n\t\t\t\t\t\t\tlabel=\"Add format\"\r\n\t\t\t\t\t\t\t@click=${() => this.#addFormatEntry(id)}>\r\n\t\t\t\t\t\t\t+ Add format\r\n\t\t\t\t\t\t</uui-button>\r\n\t\t\t\t\t` : nothing}\r\n\t\t\t\t</div>\r\n\t\t\t\t` : nothing}\r\n\r\n\t\t\t\t${!isExcluded ? html`\r\n\t\t\t\t<div class=\"format-area\">\r\n\t\t\t\t\t<div class=\"section-header collapsible\" @click=${() => this.#toggleSection('findReplace', id)}>\r\n\t\t\t\t\t\t<uui-icon name=${this.#isSectionExpanded('findReplace', id) ? 'icon-navigation-down' : 'icon-navigation-right'}></uui-icon>\r\n\t\t\t\t\t\tFind &amp; Replace${(rule.textReplacements ?? []).length > 0 ? ` (${(rule.textReplacements ?? []).length})` : ''}\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t${this.#isSectionExpanded('findReplace', id) ? html`\r\n\t\t\t\t\t\t${(rule.textReplacements ?? []).map((tr, trIdx) => this.#renderTextReplacementRow(id, trIdx, tr))}\r\n\t\t\t\t\t\t<uui-button\r\n\t\t\t\t\t\t\tcompact\r\n\t\t\t\t\t\t\tlook=\"placeholder\"\r\n\t\t\t\t\t\t\tlabel=\"Add find & replace\"\r\n\t\t\t\t\t\t\t@click=${() => this.#addTextReplacement(id)}>\r\n\t\t\t\t\t\t\t+ Add find &amp; replace\r\n\t\t\t\t\t\t</uui-button>\r\n\t\t\t\t\t` : nothing}\r\n\t\t\t\t</div>\r\n\t\t\t\t` : nothing}\r\n\r\n\t\t\t\t<div class=\"match-preview ${matchedElements.length > 0 ? (isExcluded ? 'excluded' : 'matched') : 'no-match'}\">\r\n\t\t\t\t\t${matchedElements.length > 0\r\n\t\t\t\t\t\t? html`<uui-icon name=${isExcluded ? 'icon-block' : 'icon-check'}></uui-icon> ${isExcluded ? 'Excluded' : 'Matched'} <strong>${matchedElements.length}&times;</strong>${matchedElements.length <= 5 ? html`: ${matchedElements.map((el, i) => html`${i > 0 ? html`, ` : nothing}<strong>${this.#truncate(el.text, 40)}</strong>`)}` : nothing}`\r\n\t\t\t\t\t\t: html`<uui-icon name=\"icon-alert\"></uui-icon> ${rule.conditions.length === 0 ? 'Add conditions to match elements' : 'No match'}`}\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t`;\r\n\t}\r\n\r\n\t#truncate(text: string, max: number): string {\r\n\t\treturn text.length > max ? text.substring(0, max) + '...' : text;\r\n\t}\r\n\r\n\t#renderGroupHeader(name: string) {\r\n\t\tif (this._renamingGroup === name) {\r\n\t\t\treturn html`\r\n\t\t\t\t<div class=\"group-header\">\r\n\t\t\t\t\t<input\r\n\t\t\t\t\t\ttype=\"text\"\r\n\t\t\t\t\t\tclass=\"group-rename-input\"\r\n\t\t\t\t\t\t.value=${this._renameValue}\r\n\t\t\t\t\t\t@input=${(e: Event) => { this._renameValue = (e.target as HTMLInputElement).value; }}\r\n\t\t\t\t\t\t@keydown=${(e: KeyboardEvent) => {\r\n\t\t\t\t\t\t\tif (e.key === 'Enter') this.#confirmRenameGroup();\r\n\t\t\t\t\t\t\tif (e.key === 'Escape') this.#cancelRenameGroup();\r\n\t\t\t\t\t\t}} />\r\n\t\t\t\t\t<uui-button compact look=\"primary\" label=\"Confirm\" @click=${() => this.#confirmRenameGroup()}>\r\n\t\t\t\t\t\t<uui-icon name=\"icon-check\"></uui-icon>\r\n\t\t\t\t\t</uui-button>\r\n\t\t\t\t\t<uui-button compact look=\"secondary\" label=\"Cancel\" @click=${() => this.#cancelRenameGroup()}>\r\n\t\t\t\t\t\t<uui-icon name=\"icon-wrong\"></uui-icon>\r\n\t\t\t\t\t</uui-button>\r\n\t\t\t\t</div>\r\n\t\t\t`;\r\n\t\t}\r\n\r\n\t\treturn html`\r\n\t\t\t<div class=\"group-header\">\r\n\t\t\t\t<strong class=\"group-name\">${name}</strong>\r\n\t\t\t\t<span class=\"header-spacer\"></span>\r\n\t\t\t\t<uui-action-bar class=\"group-header-actions\">\r\n\t\t\t\t\t<uui-button pristine look=\"primary\" label=\"Rename\" @click=${() => this.#startRenameGroup(name)}>\r\n\t\t\t\t\t\t<uui-icon name=\"icon-edit\"></uui-icon>\r\n\t\t\t\t\t</uui-button>\r\n\t\t\t\t\t<uui-button pristine look=\"primary\" label=\"Delete group\"\r\n\t\t\t\t\t\ttitle=\"Delete group (rules move to ungrouped)\"\r\n\t\t\t\t\t\t@click=${() => this.#deleteGroup(name)}>\r\n\t\t\t\t\t\t<uui-icon name=\"icon-trash\"></uui-icon>\r\n\t\t\t\t\t</uui-button>\r\n\t\t\t\t</uui-action-bar>\r\n\t\t\t</div>\r\n\t\t`;\r\n\t}\r\n\r\n\t#renderUnmatchedElements(claimed: Map<string, number>) {\r\n\t\tconst elements = this.#elements;\r\n\t\tconst unmatched = elements.filter((el) => !claimed.has(el.id));\r\n\t\tif (unmatched.length === 0) return nothing;\r\n\r\n\t\treturn html`\r\n\t\t\t<div class=\"unmatched-section\">\r\n\t\t\t\t<h4>Unmatched elements (${unmatched.length})</h4>\r\n\t\t\t\t${unmatched.map((el) => {\r\n\t\t\t\t\tconst elIndex = elements.indexOf(el);\r\n\t\t\t\t\treturn html`\r\n\t\t\t\t\t\t<div class=\"unmatched-element\">\r\n\t\t\t\t\t\t\t<div class=\"unmatched-text\">${this.#truncate(el.text, 80)}</div>\r\n\t\t\t\t\t\t\t<div class=\"unmatched-meta\">\r\n\t\t\t\t\t\t\t\t<span class=\"meta-badge\">${el.fontSize}pt</span>\r\n\t\t\t\t\t\t\t\t<span class=\"meta-badge\">${el.fontName}</span>\r\n\t\t\t\t\t\t\t\t${el.color !== '#000000' ? html`<span class=\"meta-badge\" style=\"border-left: 3px solid ${el.color};\">${el.color}</span>` : nothing}\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t<uui-button\r\n\t\t\t\t\t\t\t\tcompact\r\n\t\t\t\t\t\t\t\tlook=\"outline\"\r\n\t\t\t\t\t\t\t\tlabel=\"Define rule from this\"\r\n\t\t\t\t\t\t\t\t@click=${() => this.#createRuleFromElement(el, elIndex)}>\r\n\t\t\t\t\t\t\t\tDefine rule\r\n\t\t\t\t\t\t\t</uui-button>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t`;\r\n\t\t\t\t})}\r\n\t\t\t</div>\r\n\t\t`;\r\n\t}\r\n\r\n\toverride render() {\r\n\t\tconst claimed = this.#evaluateRules();\r\n\r\n\t\t// Build rule _id -> all matched elements lookup\r\n\t\tconst ruleMatches = new Map<string, AreaElement[]>();\r\n\t\tfor (const [elId, ruleId] of claimed) {\r\n\t\t\tconst el = this.#elements.find((e) => e.id === elId);\r\n\t\t\tif (el) {\r\n\t\t\t\tconst existing = ruleMatches.get(ruleId) ?? [];\r\n\t\t\t\texisting.push(el);\r\n\t\t\t\truleMatches.set(ruleId, existing);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tconst groupedView = this.#groupedView;\r\n\r\n\t\treturn html`\r\n\t\t\t<umb-body-layout headline=\"Edit Sections: ${this.#sectionHeading}\">\r\n\t\t\t\t<div id=\"main\">\r\n\t\t\t\t\t<div class=\"section-info\">\r\n\t\t\t\t\t\t<span class=\"meta-badge\">${this.#elements.length} elements</span>\r\n\t\t\t\t\t\t<span class=\"meta-badge\">${this._rules.length} rules</span>\r\n\t\t\t\t\t\t<span class=\"meta-badge\">${claimed.size} matched</span>\r\n\t\t\t\t\t\t<span class=\"meta-badge\">${this.#elements.length - claimed.size} unmatched</span>\r\n\t\t\t\t\t\t${this._groupOrder.length > 0\r\n\t\t\t\t\t\t\t? html`<span class=\"meta-badge\">${this._groupOrder.length} group${this._groupOrder.length !== 1 ? 's' : ''}</span>`\r\n\t\t\t\t\t\t\t: nothing}\r\n\t\t\t\t\t</div>\r\n\r\n\t\t\t\t\t${groupedView.map((entry) => {\r\n\t\t\t\t\t\tconst renderItemCb = (rule: SortableRule) =>\r\n\t\t\t\t\t\t\tthis.#renderRuleCard(rule as EditableRule, ruleMatches.get(rule._id) ?? []);\r\n\r\n\t\t\t\t\t\tif (entry.group !== null) {\r\n\t\t\t\t\t\t\t// Render a named group\r\n\t\t\t\t\t\t\treturn html`\r\n\t\t\t\t\t\t\t\t<div class=\"group-container\">\r\n\t\t\t\t\t\t\t\t\t${this.#renderGroupHeader(entry.group)}\r\n\t\t\t\t\t\t\t\t\t<div class=\"group-rules\">\r\n\t\t\t\t\t\t\t\t\t\t<updoc-sortable-rules\r\n\t\t\t\t\t\t\t\t\t\t\t.rules=${entry.rules}\r\n\t\t\t\t\t\t\t\t\t\t\t.expandedIds=${this._expandedRules}\r\n\t\t\t\t\t\t\t\t\t\t\t.renderItem=${renderItemCb}\r\n\t\t\t\t\t\t\t\t\t\t\t@sort-change=${(e: CustomEvent<SortChangeDetail>) => this.#onSortChange(entry.group, e)}\r\n\t\t\t\t\t\t\t\t\t\t></updoc-sortable-rules>\r\n\t\t\t\t\t\t\t\t\t\t<uui-button\r\n\t\t\t\t\t\t\t\t\t\t\tlook=\"placeholder\"\r\n\t\t\t\t\t\t\t\t\t\t\tlabel=\"Add rule to ${entry.group}\"\r\n\t\t\t\t\t\t\t\t\t\t\t@click=${() => this.#addRule(entry.group)}>\r\n\t\t\t\t\t\t\t\t\t\t\t+ Add rule\r\n\t\t\t\t\t\t\t\t\t\t</uui-button>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t`;\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t// Render ungrouped rules\r\n\t\t\t\t\t\treturn html`\r\n\t\t\t\t\t\t\t${this._groupOrder.length > 0 ? html`\r\n\t\t\t\t\t\t\t\t<div class=\"ungrouped-label\">Ungrouped</div>\r\n\t\t\t\t\t\t\t` : nothing}\r\n\t\t\t\t\t\t\t<updoc-sortable-rules\r\n\t\t\t\t\t\t\t\t.rules=${entry.rules}\r\n\t\t\t\t\t\t\t\t.expandedIds=${this._expandedRules}\r\n\t\t\t\t\t\t\t\t.renderItem=${renderItemCb}\r\n\t\t\t\t\t\t\t\t@sort-change=${(e: CustomEvent<SortChangeDetail>) => this.#onSortChange(null, e)}\r\n\t\t\t\t\t\t\t></updoc-sortable-rules>\r\n\t\t\t\t\t\t\t<uui-button\r\n\t\t\t\t\t\t\t\tlook=\"placeholder\"\r\n\t\t\t\t\t\t\t\tlabel=\"Add rule\"\r\n\t\t\t\t\t\t\t\t@click=${() => this.#addRule(null)}>\r\n\t\t\t\t\t\t\t\t+ Add rule\r\n\t\t\t\t\t\t\t</uui-button>\r\n\t\t\t\t\t\t`;\r\n\t\t\t\t\t})}\r\n\r\n\t\t\t\t\t<uui-button\r\n\t\t\t\t\t\tlook=\"outline\"\r\n\t\t\t\t\t\tlabel=\"Add group\"\r\n\t\t\t\t\t\t@click=${() => this.#addGroup()}>\r\n\t\t\t\t\t\t<uui-icon name=\"icon-add\"></uui-icon>\r\n\t\t\t\t\t\tAdd group\r\n\t\t\t\t\t</uui-button>\r\n\r\n\t\t\t\t\t${this.#renderUnmatchedElements(claimed)}\r\n\t\t\t\t</div>\r\n\r\n\t\t\t\t<div slot=\"actions\">\r\n\t\t\t\t\t<uui-button label=\"Close\" @click=${this.#onClose}>Close</uui-button>\r\n\t\t\t\t\t<uui-button\r\n\t\t\t\t\t\tlabel=\"Save\"\r\n\t\t\t\t\t\tlook=\"secondary\"\r\n\t\t\t\t\t\t@click=${this.#onSave}>\r\n\t\t\t\t\t\tSave\r\n\t\t\t\t\t</uui-button>\r\n\t\t\t\t\t<uui-button\r\n\t\t\t\t\t\tlabel=\"Save and Close\"\r\n\t\t\t\t\t\tlook=\"primary\"\r\n\t\t\t\t\t\tcolor=\"positive\"\r\n\t\t\t\t\t\t@click=${this.#onSaveAndClose}>\r\n\t\t\t\t\t\tSave and Close\r\n\t\t\t\t\t</uui-button>\r\n\t\t\t\t</div>\r\n\t\t\t</umb-body-layout>\r\n\t\t`;\r\n\t}\r\n\r\n\tstatic override styles = [\r\n\t\tUmbTextStyles,\r\n\t\truleCardStyles,\r\n\t\tcss`\r\n\t\t\t:host {\r\n\t\t\t\tdisplay: block;\r\n\t\t\t\theight: 100%;\r\n\t\t\t}\r\n\r\n\t\t\t#main {\r\n\t\t\t\tpadding: var(--uui-size-space-4);\r\n\t\t\t\tdisplay: flex;\r\n\t\t\t\tflex-direction: column;\r\n\t\t\t\tgap: var(--uui-size-space-4);\r\n\t\t\t}\r\n\r\n\t\t\t.section-info {\r\n\t\t\t\tdisplay: flex;\r\n\t\t\t\tgap: var(--uui-size-space-2);\r\n\t\t\t\tflex-wrap: wrap;\r\n\t\t\t}\r\n\r\n\t\t\t.meta-badge {\r\n\t\t\t\tfont-size: 11px;\r\n\t\t\t\tfont-family: monospace;\r\n\t\t\t\tpadding: 1px 6px;\r\n\t\t\t\tborder-radius: var(--uui-border-radius);\r\n\t\t\t\tbackground: var(--uui-color-surface-alt);\r\n\t\t\t\tcolor: var(--uui-color-text-alt);\r\n\t\t\t}\r\n\r\n\t\t\t/* Group containers */\r\n\t\t\t.group-container {\r\n\t\t\t\tborder: 2px solid var(--uui-color-border);\r\n\t\t\t\tborder-radius: var(--uui-border-radius);\r\n\t\t\t\toverflow: hidden;\r\n\t\t\t}\r\n\r\n\t\t\t.group-header {\r\n\t\t\t\tdisplay: flex;\r\n\t\t\t\talign-items: center;\r\n\t\t\t\tgap: var(--uui-size-space-2);\r\n\t\t\t\tpadding: var(--uui-size-space-3) var(--uui-size-space-4);\r\n\t\t\t\tbackground: var(--uui-color-surface-alt);\r\n\t\t\t\tborder-bottom: 1px solid var(--uui-color-border);\r\n\t\t\t}\r\n\r\n\t\t\t.group-name {\r\n\t\t\t\tfont-size: var(--uui-type-default-size);\r\n\t\t\t\tcolor: var(--uui-color-text);\r\n\t\t\t}\r\n\r\n\t\t\t.group-header-actions {\r\n\t\t\t\topacity: 0;\r\n\t\t\t\ttransition: opacity 120ms ease;\r\n\t\t\t}\r\n\r\n\t\t\t.group-header:hover .group-header-actions {\r\n\t\t\t\topacity: 1;\r\n\t\t\t}\r\n\r\n\t\t\t.group-rename-input {\r\n\t\t\t\tflex: 1;\r\n\t\t\t\tpadding: var(--uui-size-space-1) var(--uui-size-space-2);\r\n\t\t\t\tborder: 1px solid var(--uui-color-focus);\r\n\t\t\t\tborder-radius: var(--uui-border-radius);\r\n\t\t\t\tfont-size: var(--uui-type-default-size);\r\n\t\t\t\tbackground: var(--uui-color-surface);\r\n\t\t\t\tcolor: var(--uui-color-text);\r\n\t\t\t}\r\n\r\n\t\t\t.group-rename-input:focus {\r\n\t\t\t\toutline: none;\r\n\t\t\t}\r\n\r\n\t\t\t.header-spacer {\r\n\t\t\t\tflex: 1;\r\n\t\t\t}\r\n\r\n\t\t\t.group-rules {\r\n\t\t\t\tpadding: var(--uui-size-space-3);\r\n\t\t\t\tdisplay: flex;\r\n\t\t\t\tflex-direction: column;\r\n\t\t\t\tgap: var(--uui-size-space-3);\r\n\t\t\t}\r\n\r\n\t\t\t.ungrouped-label {\r\n\t\t\t\tfont-size: 11px;\r\n\t\t\t\tfont-weight: 700;\r\n\t\t\t\ttext-transform: uppercase;\r\n\t\t\t\tletter-spacing: 0.5px;\r\n\t\t\t\tcolor: var(--uui-color-text-alt);\r\n\t\t\t\tpadding-top: var(--uui-size-space-2);\r\n\t\t\t}\r\n\r\n\t\t\t/* Unmatched elements */\r\n\t\t\t.unmatched-section {\r\n\t\t\t\tborder: 1px dashed var(--uui-color-border);\r\n\t\t\t\tborder-radius: var(--uui-border-radius);\r\n\t\t\t\tpadding: var(--uui-size-space-3) var(--uui-size-space-4);\r\n\t\t\t}\r\n\r\n\t\t\t.unmatched-section h4 {\r\n\t\t\t\tmargin: 0 0 var(--uui-size-space-3);\r\n\t\t\t\tcolor: var(--uui-color-text-alt);\r\n\t\t\t\tfont-size: var(--uui-type-small-size);\r\n\t\t\t\ttext-transform: uppercase;\r\n\t\t\t\tletter-spacing: 0.5px;\r\n\t\t\t}\r\n\r\n\t\t\t.unmatched-element {\r\n\t\t\t\tdisplay: flex;\r\n\t\t\t\talign-items: center;\r\n\t\t\t\tgap: var(--uui-size-space-3);\r\n\t\t\t\tpadding: var(--uui-size-space-2) 0;\r\n\t\t\t\tborder-bottom: 1px solid var(--uui-color-border);\r\n\t\t\t}\r\n\r\n\t\t\t.unmatched-element:last-child {\r\n\t\t\t\tborder-bottom: none;\r\n\t\t\t}\r\n\r\n\t\t\t.unmatched-text {\r\n\t\t\t\tflex: 1;\r\n\t\t\t\tfont-size: var(--uui-type-small-size);\r\n\t\t\t\tmin-width: 0;\r\n\t\t\t\toverflow: hidden;\r\n\t\t\t\ttext-overflow: ellipsis;\r\n\t\t\t\twhite-space: nowrap;\r\n\t\t\t}\r\n\r\n\t\t\t.unmatched-meta {\r\n\t\t\t\tdisplay: flex;\r\n\t\t\t\tgap: var(--uui-size-space-1);\r\n\t\t\t\tflex-shrink: 0;\r\n\t\t\t}\r\n\t\t`,\r\n\t];\r\n}\r\n\r\nexport default UpDocSectionRulesEditorModalElement;\r\n\r\ndeclare global {\r\n\tinterface HTMLElementTagNameMap {\r\n\t\t'up-doc-section-rules-editor-modal': UpDocSectionRulesEditorModalElement;\r\n\t}\r\n}\r\n"],"names":["ruleCardStyles","css","_sorter","UpdocSortableRulesElement","UmbLitElement","__privateAdd","UmbSorterController","el","rule","model","val","__privateGet","nothing","html","repeat","__decorateClass","property","state","customElement","_UpDocSectionRulesEditorModalElement_instances","isSectionExpanded_fn","toggleSection_fn","isRuleExpanded_fn","toggleRuleExpanded_fn","expandRule_fn","normalizeRule_fn","elements_get","sectionHeading_get","groupedView_get","evaluateRules_fn","elementMatchesAllConditions_fn","elementMatchesCondition_fn","autoPopulateConditions_fn","updateRuleById_fn","addRule_fn","removeRuleById_fn","createRuleFromElement_fn","updateRoleName_fn","updatePart_fn","updateExclude_fn","addGroup_fn","startRenameGroup_fn","confirmRenameGroup_fn","cancelRenameGroup_fn","deleteGroup_fn","onSortChange_fn","addFormatEntry_fn","removeFormatEntry_fn","updateFormatEntryType_fn","updateFormatEntryValue_fn","addCondition_fn","removeCondition_fn","updateConditionType_fn","updateConditionValue_fn","addException_fn","removeException_fn","updateExceptionType_fn","updateExceptionValue_fn","addTextReplacement_fn","removeTextReplacement_fn","updateTextReplacementFindType_fn","updateTextReplacementFind_fn","updateTextReplacementReplace_fn","cleanRule_fn","buildRulesValue_fn","onSave_fn","onSaveAndClose_fn","onClose_fn","renderConditionRow_fn","renderExceptionRow_fn","renderFormatRow_fn","renderTextReplacementRow_fn","renderRuleCard_fn","renderCollapsedRule_fn","renderExpandedRule_fn","truncate_fn","renderGroupHeader_fn","renderUnmatchedElements_fn","_nextRuleId","generateRuleId","CONDITION_LABELS","VALUELESS_CONDITIONS","ALL_CONDITION_TYPES","PART_LABELS","ALL_PARTS","FORMAT_ENTRY_TYPE_LABELS","ALL_FORMAT_ENTRY_TYPES","BLOCK_FORMAT_LABELS","ALL_BLOCK_FORMATS","STYLE_FORMAT_LABELS","ALL_STYLE_FORMATS","FIND_TYPE_LABELS","ALL_FIND_TYPES","REPLACE_TYPE_LABELS","UpDocSectionRulesEditorModalElement","UmbModalBaseElement","areaRules","editableRules","groupOrder","group","__privateMethod","claimed","ruleMatches","elId","ruleId","e","existing","groupedView","entry","renderItemCb","section","key","next","groupName","part","exclude","derived","getEffectivePart","formats","getEffectiveFormat","result","name","r","elements","elIdx","exc","conditions","index","total","c","condition","numVal","elIndex","fontName","colonIdx","id","updater","roleSuggestion","value","counter","oldName","newName","n","newRules","newRuleIds","allRules","gName","fmtIdx","_","type","defaultValue","condIdx","cond","isNumeric","excIdx","exceptions","trIdx","findType","trs","replaceType","find","replace","blockEntry","f","_id","_groupName","action","clean","groups","groupRules","ungroupedRules","rules","isValueless","t","exception","valueOptions","valueLabels","v","tr","replaceLabel","matchedElements","isExcluded","currentPart","partLabel","matchCount","roleName","cIdx","eIdx","p","fmt","fIdx","i","text","max","unmatched","UmbTextStyles","UpDocSectionRulesEditorModalElement_default"],"mappings":";;;;;;AAOO,MAAMA,IAAiBC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;A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"}