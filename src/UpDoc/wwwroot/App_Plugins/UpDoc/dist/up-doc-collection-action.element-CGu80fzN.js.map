{"version":3,"file":"up-doc-collection-action.element-CGu80fzN.js","sources":["../src/up-doc-collection-action.element.ts"],"sourcesContent":["import { UMB_BLUEPRINT_PICKER_MODAL } from './blueprint-picker-modal.token.js';\r\nimport { UMB_UP_DOC_MODAL } from './up-doc-modal.token.js';\r\nimport type { DocumentTypeOption } from './blueprint-picker-modal.token.js';\r\nimport type { DocumentTypeConfig, MappingDestination } from './workflow.types.js';\r\nimport { fetchActiveWorkflows } from './workflow.service.js';\r\nimport { markdownToHtml, buildRteValue } from './transforms.js';\r\nimport { css, customElement, html, state } from '@umbraco-cms/backoffice/external/lit';\r\nimport { UmbLitElement } from '@umbraco-cms/backoffice/lit-element';\r\nimport { UMB_DOCUMENT_WORKSPACE_CONTEXT } from '@umbraco-cms/backoffice/document';\r\nimport { UMB_AUTH_CONTEXT } from '@umbraco-cms/backoffice/auth';\r\nimport { UMB_NOTIFICATION_CONTEXT } from '@umbraco-cms/backoffice/notification';\r\nimport { umbOpenModal } from '@umbraco-cms/backoffice/modal';\r\nimport { UmbDocumentTypeStructureRepository } from '@umbraco-cms/backoffice/document-type';\r\nimport { UmbDocumentBlueprintItemRepository } from '@umbraco-cms/backoffice/document-blueprint';\r\nimport type { UmbEntityUnique } from '@umbraco-cms/backoffice/entity';\r\n\r\n@customElement('up-doc-collection-action')\r\nexport class UpDocCollectionActionElement extends UmbLitElement {\r\n\t#documentTypeStructureRepository = new UmbDocumentTypeStructureRepository(this);\r\n\t#blueprintItemRepository = new UmbDocumentBlueprintItemRepository(this);\r\n\r\n\t@state()\r\n\tprivate _documentUnique?: UmbEntityUnique;\r\n\r\n\t@state()\r\n\tprivate _documentTypeUnique?: string;\r\n\r\n\t@state()\r\n\tprivate _hasWorkflows = false;\r\n\r\n\tconstructor() {\r\n\t\tsuper();\r\n\r\n\t\tthis.consumeContext(UMB_DOCUMENT_WORKSPACE_CONTEXT, (workspaceContext) => {\r\n\t\t\tthis.observe(workspaceContext?.unique, (unique) => {\r\n\t\t\t\tthis._documentUnique = unique;\r\n\t\t\t\tthis.#checkWorkflows();\r\n\t\t\t});\r\n\t\t\tthis.observe(workspaceContext?.contentTypeUnique, (documentTypeUnique) => {\r\n\t\t\t\tthis._documentTypeUnique = documentTypeUnique;\r\n\t\t\t\tthis.#checkWorkflows();\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tasync #checkWorkflows() {\r\n\t\tif (!this._documentTypeUnique) return;\r\n\r\n\t\ttry {\r\n\t\t\tconst authContext = await this.getContext(UMB_AUTH_CONTEXT);\r\n\t\t\tconst token = await authContext.getLatestToken();\r\n\t\t\tconst activeWorkflows = await fetchActiveWorkflows(token);\r\n\t\t\tconst activeBlueprintIds = new Set(activeWorkflows.blueprintIds);\r\n\r\n\t\t\t// Check if any allowed child types have blueprints with workflows\r\n\t\t\tconst { data } = await this.#documentTypeStructureRepository.requestAllowedChildrenOf(\r\n\t\t\t\tthis._documentTypeUnique,\r\n\t\t\t\tthis._documentUnique || null,\r\n\t\t\t);\r\n\r\n\t\t\tif (!data?.items?.length) return;\r\n\r\n\t\t\tfor (const docType of data.items) {\r\n\t\t\t\tconst { data: blueprints } = await this.#blueprintItemRepository.requestItemsByDocumentType(docType.unique);\r\n\t\t\t\tif (blueprints?.some((bp) => activeBlueprintIds.has(bp.unique))) {\r\n\t\t\t\t\tthis._hasWorkflows = true;\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} catch {\r\n\t\t\t// Silently fail — button stays hidden\r\n\t\t}\r\n\t}\r\n\r\n\tasync #onClick() {\r\n\t\tif (!this._documentTypeUnique) return;\r\n\r\n\t\tconst notificationContext = await this.getContext(UMB_NOTIFICATION_CONTEXT);\r\n\t\tconst authContext = await this.getContext(UMB_AUTH_CONTEXT);\r\n\t\tconst token = await authContext.getLatestToken();\r\n\t\tconst parentUnique = this._documentUnique ?? null;\r\n\r\n\t\ttry {\r\n\t\t\t// Discover allowed child types with workflow blueprints\r\n\t\t\tconst activeWorkflows = await fetchActiveWorkflows(token);\r\n\t\t\tconst activeBlueprintIds = new Set(activeWorkflows.blueprintIds);\r\n\r\n\t\t\tconst { data: allowedTypes } = await this.#documentTypeStructureRepository.requestAllowedChildrenOf(\r\n\t\t\t\tthis._documentTypeUnique,\r\n\t\t\t\tparentUnique,\r\n\t\t\t);\r\n\r\n\t\t\tif (!allowedTypes?.items?.length) {\r\n\t\t\t\tnotificationContext.peek('danger', {\r\n\t\t\t\t\tdata: { message: 'No document types are allowed as children of this page.' },\r\n\t\t\t\t});\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tconst documentTypeOptions: DocumentTypeOption[] = [];\r\n\r\n\t\t\tfor (const docType of allowedTypes.items) {\r\n\t\t\t\tconst { data: blueprints } = await this.#blueprintItemRepository.requestItemsByDocumentType(docType.unique);\r\n\t\t\t\tif (blueprints?.length) {\r\n\t\t\t\t\tconst workflowBlueprints = blueprints.filter((bp) => activeBlueprintIds.has(bp.unique));\r\n\t\t\t\t\tif (workflowBlueprints.length) {\r\n\t\t\t\t\t\tdocumentTypeOptions.push({\r\n\t\t\t\t\t\t\tdocumentTypeUnique: docType.unique,\r\n\t\t\t\t\t\t\tdocumentTypeName: docType.name,\r\n\t\t\t\t\t\t\tdocumentTypeIcon: (docType as { icon?: string }).icon ?? null,\r\n\t\t\t\t\t\t\tblueprints: workflowBlueprints.map((bp) => ({\r\n\t\t\t\t\t\t\t\tblueprintUnique: bp.unique,\r\n\t\t\t\t\t\t\t\tblueprintName: bp.name,\r\n\t\t\t\t\t\t\t})),\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (!documentTypeOptions.length) {\r\n\t\t\t\tnotificationContext.peek('warning', {\r\n\t\t\t\t\tdata: { message: 'No workflows are configured for the document types allowed here.' },\r\n\t\t\t\t});\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\t// Open blueprint picker\r\n\t\t\tlet blueprintSelection;\r\n\t\t\ttry {\r\n\t\t\t\tblueprintSelection = await umbOpenModal(this, UMB_BLUEPRINT_PICKER_MODAL, {\r\n\t\t\t\t\tdata: { documentTypes: documentTypeOptions },\r\n\t\t\t\t});\r\n\t\t\t} catch {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tconst { blueprintUnique, documentTypeUnique } = blueprintSelection;\r\n\t\t\tconst selectedDocType = documentTypeOptions.find((dt) => dt.documentTypeUnique === documentTypeUnique);\r\n\t\t\tconst selectedBlueprint = selectedDocType?.blueprints.find((bp) => bp.blueprintUnique === blueprintUnique);\r\n\r\n\t\t\t// Open source sidebar modal\r\n\t\t\tlet modalValue;\r\n\t\t\ttry {\r\n\t\t\t\tmodalValue = await umbOpenModal(this, UMB_UP_DOC_MODAL, {\r\n\t\t\t\t\tdata: {\r\n\t\t\t\t\t\tunique: parentUnique,\r\n\t\t\t\t\t\tblueprintName: selectedBlueprint?.blueprintName ?? '',\r\n\t\t\t\t\t\tblueprintId: blueprintUnique,\r\n\t\t\t\t\t},\r\n\t\t\t\t});\r\n\t\t\t} catch {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tconst { name, mediaUnique, sectionLookup, config } = modalValue;\r\n\r\n\t\t\tif (!mediaUnique || !name || !config) return;\r\n\r\n\t\t\t// Scaffold from blueprint\r\n\t\t\tconst scaffoldResponse = await fetch(\r\n\t\t\t\t`/umbraco/management/api/v1/document-blueprint/${blueprintUnique}/scaffold`,\r\n\t\t\t\t{\r\n\t\t\t\t\tmethod: 'GET',\r\n\t\t\t\t\theaders: {\r\n\t\t\t\t\t\t'Content-Type': 'application/json',\r\n\t\t\t\t\t\tAuthorization: `Bearer ${token}`,\r\n\t\t\t\t\t},\r\n\t\t\t\t},\r\n\t\t\t);\r\n\r\n\t\t\tif (!scaffoldResponse.ok) {\r\n\t\t\t\tconst error = await scaffoldResponse.json();\r\n\t\t\t\tnotificationContext.peek('danger', {\r\n\t\t\t\t\tdata: { message: `Failed to scaffold from blueprint: ${error.title || 'Unknown error'}` },\r\n\t\t\t\t});\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tconst scaffold = await scaffoldResponse.json();\r\n\r\n\t\t\t// Apply property mappings\r\n\t\t\tconst values: Array<{ alias: string; value: unknown }> = scaffold.values\r\n\t\t\t\t? JSON.parse(JSON.stringify(scaffold.values))\r\n\t\t\t\t: [];\r\n\r\n\t\t\t// Track which fields have been written by our mappings.\r\n\t\t\t// First write replaces the blueprint default; subsequent writes concatenate.\r\n\t\t\tconst mappedFields = new Set<string>();\r\n\r\n\t\t\tfor (const mapping of config.map.mappings) {\r\n\t\t\t\tif (mapping.enabled === false) continue;\r\n\t\t\t\tconst sectionValue = sectionLookup[mapping.source];\r\n\t\t\t\tif (!sectionValue) continue;\r\n\r\n\t\t\t\tfor (const dest of mapping.destinations) {\r\n\t\t\t\t\tthis.#applyDestinationMapping(values, dest, sectionValue, config, mappedFields);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t// Convert richText fields: markdown → HTML → RTE value object.\r\n\t\t\t// Done as a post-mapping pass so concatenation happens on raw strings first.\r\n\t\t\tthis.#convertRichTextFields(values, config, mappedFields);\r\n\r\n\t\t\t// Create the document\r\n\t\t\tconst createRequest = {\r\n\t\t\t\tparent: parentUnique ? { id: parentUnique } : null,\r\n\t\t\t\tdocumentType: { id: documentTypeUnique },\r\n\t\t\t\ttemplate: scaffold.template ? { id: scaffold.template.id } : null,\r\n\t\t\t\tvalues,\r\n\t\t\t\tvariants: [{ name, culture: null, segment: null }],\r\n\t\t\t};\r\n\r\n\t\t\tconst createResponse = await fetch('/umbraco/management/api/v1/document', {\r\n\t\t\t\tmethod: 'POST',\r\n\t\t\t\theaders: {\r\n\t\t\t\t\t'Content-Type': 'application/json',\r\n\t\t\t\t\tAuthorization: `Bearer ${token}`,\r\n\t\t\t\t},\r\n\t\t\t\tbody: JSON.stringify(createRequest),\r\n\t\t\t});\r\n\r\n\t\t\tif (!createResponse.ok) {\r\n\t\t\t\tconst error = await createResponse.json();\r\n\t\t\t\tnotificationContext.peek('danger', {\r\n\t\t\t\t\tdata: { message: `Failed to create document: ${error.title || error.detail || 'Unknown error'}` },\r\n\t\t\t\t});\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tconst locationHeader = createResponse.headers.get('Location');\r\n\t\t\tconst newDocumentId = locationHeader?.split('/').pop();\r\n\r\n\t\t\t// Save to persist\r\n\t\t\tif (newDocumentId) {\r\n\t\t\t\tconst getResponse = await fetch(`/umbraco/management/api/v1/document/${newDocumentId}`, {\r\n\t\t\t\t\tmethod: 'GET',\r\n\t\t\t\t\theaders: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },\r\n\t\t\t\t});\r\n\r\n\t\t\t\tif (getResponse.ok) {\r\n\t\t\t\t\tconst documentData = await getResponse.json();\r\n\t\t\t\t\tawait fetch(`/umbraco/management/api/v1/document/${newDocumentId}`, {\r\n\t\t\t\t\t\tmethod: 'PUT',\r\n\t\t\t\t\t\theaders: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },\r\n\t\t\t\t\t\tbody: JSON.stringify(documentData),\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tnotificationContext.peek('positive', {\r\n\t\t\t\tdata: { message: `Document \"${name}\" created successfully!` },\r\n\t\t\t});\r\n\r\n\t\t\tif (newDocumentId) {\r\n\t\t\t\tconst newPath = `/umbraco/section/content/workspace/document/edit/${newDocumentId}`;\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\twindow.location.href = newPath;\r\n\t\t\t\t}, 150);\r\n\t\t\t}\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error('Error creating document:', error);\r\n\t\t\tnotificationContext.peek('danger', {\r\n\t\t\t\tdata: { message: 'An unexpected error occurred while creating the document.' },\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\t#applyDestinationMapping(\r\n\t\tvalues: Array<{ alias: string; value: unknown }>,\r\n\t\tdest: MappingDestination,\r\n\t\tsectionValue: string,\r\n\t\tconfig: DocumentTypeConfig,\r\n\t\tmappedFields: Set<string>,\r\n\t) {\r\n\t\tconst transformedValue = sectionValue;\r\n\r\n\t\t// Block property with blockKey — find the specific block instance\r\n\t\tif (dest.blockKey) {\r\n\t\t\tfor (const grid of config.destination.blockGrids ?? []) {\r\n\t\t\t\tconst block = grid.blocks.find((b) => b.key === dest.blockKey);\r\n\t\t\t\tif (block?.identifyBy) {\r\n\t\t\t\t\tthis.#applyBlockGridValue(values, grid.alias, block.identifyBy, dest.target, transformedValue, mappedFields);\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tconsole.log(`Block ${dest.blockKey} not found in destination config`);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Parse the target path\r\n\t\tconst pathParts = dest.target.split('.');\r\n\r\n\t\tif (pathParts.length === 1) {\r\n\t\t\t// Simple field mapping: \"pageTitle\"\r\n\t\t\tconst alias = pathParts[0];\r\n\t\t\tconst existing = values.find((v) => v.alias === alias);\r\n\r\n\t\t\tif (existing) {\r\n\t\t\t\tif (mappedFields.has(alias)) {\r\n\t\t\t\t\t// Already written by a previous mapping — concatenate\r\n\t\t\t\t\tconst currentValue = typeof existing.value === 'string' ? existing.value : '';\r\n\t\t\t\t\texisting.value = `${currentValue} ${transformedValue}`;\r\n\t\t\t\t} else {\r\n\t\t\t\t\t// First write — replace the blueprint default\r\n\t\t\t\t\texisting.value = transformedValue;\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tvalues.push({ alias, value: transformedValue });\r\n\t\t\t}\r\n\t\t\tmappedFields.add(alias);\r\n\t\t} else if (pathParts.length === 3) {\r\n\t\t\t// Legacy dot-path: \"contentGrid.itineraryBlock.richTextContent\"\r\n\t\t\tconst [gridKey, blockKey, propertyKey] = pathParts;\r\n\t\t\tconst blockGrid = config.destination.blockGrids?.find((g) => g.key === gridKey);\r\n\t\t\tconst block = blockGrid?.blocks.find((b) => b.key === blockKey);\r\n\r\n\t\t\tif (!blockGrid || !block) return;\r\n\r\n\t\t\tconst gridAlias = blockGrid.alias;\r\n\t\t\tconst targetProperty = block.properties?.find((p) => p.key === propertyKey)?.alias ?? propertyKey;\r\n\t\t\tconst blockSearch = block.identifyBy;\r\n\r\n\t\t\tif (!blockSearch) return;\r\n\r\n\t\t\tthis.#applyBlockGridValue(values, gridAlias, blockSearch, targetProperty, transformedValue, mappedFields);\r\n\t\t}\r\n\t}\r\n\r\n\t#applyBlockGridValue(\r\n\t\tvalues: Array<{ alias: string; value: unknown }>,\r\n\t\tgridAlias: string,\r\n\t\tblockSearch: { property: string; value: string },\r\n\t\ttargetProperty: string,\r\n\t\tvalue: string,\r\n\t\tmappedFields: Set<string>,\r\n\t) {\r\n\t\tconst contentGridValue = values.find((v) => v.alias === gridAlias);\r\n\t\tif (!contentGridValue || !contentGridValue.value) return;\r\n\r\n\t\ttry {\r\n\t\t\tconst wasString = typeof contentGridValue.value === 'string';\r\n\t\t\tconst contentGrid = wasString\r\n\t\t\t\t? JSON.parse(contentGridValue.value as string)\r\n\t\t\t\t: contentGridValue.value;\r\n\r\n\t\t\tconst contentData = contentGrid.contentData as Array<{\r\n\t\t\t\tcontentTypeKey: string;\r\n\t\t\t\tkey: string;\r\n\t\t\t\tvalues: Array<{ alias: string; value: unknown }>;\r\n\t\t\t}>;\r\n\r\n\t\t\tif (!contentData) return;\r\n\r\n\t\t\tfor (const block of contentData) {\r\n\t\t\t\tconst searchValue = block.values?.find((v) => v.alias === blockSearch.property);\r\n\t\t\t\tif (\r\n\t\t\t\t\tsearchValue &&\r\n\t\t\t\t\ttypeof searchValue.value === 'string' &&\r\n\t\t\t\t\tsearchValue.value.toLowerCase().includes(blockSearch.value.toLowerCase())\r\n\t\t\t\t) {\r\n\t\t\t\t\tconst targetValue = block.values?.find((v) => v.alias === targetProperty);\r\n\t\t\t\t\tif (targetValue) {\r\n\t\t\t\t\t\t// Use compound key for block property tracking\r\n\t\t\t\t\t\tconst fieldKey = `${block.key}:${targetProperty}`;\r\n\r\n\t\t\t\t\t\tif (mappedFields.has(fieldKey)) {\r\n\t\t\t\t\t\t\t// Already written — concatenate with newline\r\n\t\t\t\t\t\t\tconst currentValue = typeof targetValue.value === 'string' ? targetValue.value : '';\r\n\t\t\t\t\t\t\ttargetValue.value = `${currentValue}\\n${value}`;\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t// First write — replace the blueprint default\r\n\t\t\t\t\t\t\ttargetValue.value = value;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tmappedFields.add(fieldKey);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tcontentGridValue.value = wasString ? JSON.stringify(contentGrid) : contentGrid;\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error(`Failed to apply block mapping to ${gridAlias}:`, error);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Post-mapping pass: converts richText fields from markdown to HTML + RTE value object.\r\n\t * Uses destination.json field types to auto-detect which fields need conversion.\r\n\t * Only converts fields that were written by our mappings (tracked by mappedFields).\r\n\t */\r\n\t#convertRichTextFields(\r\n\t\tvalues: Array<{ alias: string; value: unknown }>,\r\n\t\tconfig: DocumentTypeConfig,\r\n\t\tmappedFields: Set<string>,\r\n\t) {\r\n\t\t// Convert top-level richText fields\r\n\t\tfor (const field of config.destination.fields) {\r\n\t\t\tif (field.type === 'richText' && mappedFields.has(field.alias)) {\r\n\t\t\t\tconst val = values.find((v) => v.alias === field.alias);\r\n\t\t\t\tif (val && typeof val.value === 'string') {\r\n\t\t\t\t\tval.value = buildRteValue(markdownToHtml(val.value));\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// Convert block grid richText properties\r\n\t\tfor (const grid of config.destination.blockGrids ?? []) {\r\n\t\t\tconst gridVal = values.find((v) => v.alias === grid.alias);\r\n\t\t\tif (!gridVal?.value) continue;\r\n\r\n\t\t\tconst wasString = typeof gridVal.value === 'string';\r\n\t\t\tconst gridData = wasString ? JSON.parse(gridVal.value as string) : gridVal.value;\r\n\t\t\tconst contentData = gridData.contentData as Array<{\r\n\t\t\t\tkey: string;\r\n\t\t\t\tvalues: Array<{ alias: string; value: unknown }>;\r\n\t\t\t}> | undefined;\r\n\t\t\tif (!contentData) continue;\r\n\r\n\t\t\tfor (const block of contentData) {\r\n\t\t\t\tfor (const destBlock of grid.blocks) {\r\n\t\t\t\t\tif (!destBlock.identifyBy) continue;\r\n\t\t\t\t\tconst searchVal = block.values?.find((v) => v.alias === destBlock.identifyBy!.property);\r\n\t\t\t\t\tif (\r\n\t\t\t\t\t\tsearchVal &&\r\n\t\t\t\t\t\ttypeof searchVal.value === 'string' &&\r\n\t\t\t\t\t\tsearchVal.value.toLowerCase().includes(destBlock.identifyBy.value.toLowerCase())\r\n\t\t\t\t\t) {\r\n\t\t\t\t\t\tfor (const prop of destBlock.properties ?? []) {\r\n\t\t\t\t\t\t\tif (prop.type === 'richText' && mappedFields.has(`${block.key}:${prop.alias}`)) {\r\n\t\t\t\t\t\t\t\tconst blockVal = block.values?.find((v) => v.alias === prop.alias);\r\n\t\t\t\t\t\t\t\tif (blockVal && typeof blockVal.value === 'string') {\r\n\t\t\t\t\t\t\t\t\tblockVal.value = buildRteValue(markdownToHtml(blockVal.value as string));\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tgridVal.value = wasString ? JSON.stringify(gridData) : gridData;\r\n\t\t}\r\n\t}\r\n\r\n\toverride render() {\r\n\t\tif (!this._hasWorkflows) return html``;\r\n\r\n\t\treturn html`\r\n\t\t\t<uui-button\r\n\t\t\t\tcolor=\"default\"\r\n\t\t\t\tlook=\"outline\"\r\n\t\t\t\tlabel=\"Create from Source\"\r\n\t\t\t\t@click=${this.#onClick}>\r\n\t\t\t\tCreate from Source\r\n\t\t\t</uui-button>\r\n\t\t`;\r\n\t}\r\n\r\n\tstatic override styles = [\r\n\t\tcss`\r\n\t\t\t:host {\r\n\t\t\t\tdisplay: contents;\r\n\t\t\t}\r\n\t\t`,\r\n\t];\r\n}\r\n\r\nexport default UpDocCollectionActionElement;\r\n\r\ndeclare global {\r\n\tinterface HTMLElementTagNameMap {\r\n\t\t'up-doc-collection-action': UpDocCollectionActionElement;\r\n\t}\r\n}\r\n"],"names":["_documentTypeStructureRepository","_blueprintItemRepository","_UpDocCollectionActionElement_instances","checkWorkflows_fn","onClick_fn","applyDestinationMapping_fn","applyBlockGridValue_fn","convertRichTextFields_fn","UpDocCollectionActionElement","UmbLitElement","__privateAdd","UmbDocumentTypeStructureRepository","UmbDocumentBlueprintItemRepository","UMB_DOCUMENT_WORKSPACE_CONTEXT","workspaceContext","unique","__privateMethod","documentTypeUnique","html","token","UMB_AUTH_CONTEXT","activeWorkflows","fetchActiveWorkflows","activeBlueprintIds","data","__privateGet","docType","blueprints","bp","notificationContext","UMB_NOTIFICATION_CONTEXT","parentUnique","allowedTypes","documentTypeOptions","workflowBlueprints","blueprintSelection","umbOpenModal","UMB_BLUEPRINT_PICKER_MODAL","blueprintUnique","selectedBlueprint","dt","modalValue","UMB_UP_DOC_MODAL","name","mediaUnique","sectionLookup","config","scaffoldResponse","error","scaffold","values","mappedFields","mapping","sectionValue","dest","createRequest","createResponse","newDocumentId","getResponse","documentData","newPath","transformedValue","grid","block","b","pathParts","alias","existing","v","currentValue","gridKey","blockKey","propertyKey","blockGrid","g","gridAlias","targetProperty","p","blockSearch","value","contentGridValue","wasString","contentGrid","contentData","searchValue","targetValue","fieldKey","field","val","buildRteValue","markdownToHtml","gridVal","gridData","destBlock","searchVal","prop","blockVal","css","__decorateClass","state","customElement","UpDocCollectionActionElement_default"],"mappings":"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"}